<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storybound: Danger and Decadence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://use.typekit.net/bzl3zth.css">

  <style>
    /* GLOBAL VARS */
    :root{ 
        --bg1:#0a001f; --bg2:#2a0033; --pink:#ff69b4; --hot:#ff1493; --gold:#ffd700; --ink:#f0e6ff; --panel:rgba(20,0,40,.6); 
        --p1-color: #f0e6ff; --p2-color: #f0e6ff;
    }
    
    /* THEMES */
    body.theme-sepia { --bg1:#2c2218; --bg2:#3e2f22; --pink:#d2b48c; --hot:#8b4513; --gold:#ffa500; --ink:#f5deb3; --panel:rgba(40,30,20,0.8); }
    body.theme-midnight { --bg1:#000000; --bg2:#111111; --pink:#444; --hot:#666; --gold:#888; --ink:#ccc; --panel:rgba(20,20,20,0.9); }

    html, body { margin:0; padding:0; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--ink); font-family:'Lora',serif; overflow-x:hidden; min-height:100vh; }
    body { text-align:center; padding:10px; }
    
    /* TYPOGRAPHY */
    h1, h2, .section-title { font-family:'lust-script-display','lust-script',serif; color:var(--pink); text-shadow:0 0 15px var(--hot); font-weight:400; }
    .section-title { font-size:2.2em; margin:35px 0 15px; border-top:1px solid rgba(255,105,180,0.2); padding-top:20px; }
    .instruction-text { font-family: 'Lora', serif; font-size: 0.5em; color: var(--ink); opacity: 0.7; vertical-align: middle; margin-left: 12px; letter-spacing: 0; text-shadow: none; }
    
    /* DIALOGUE STYLING */
    .dialogue { font-size: 1.15em; font-style: italic; display: block; margin: 12px 0; padding-left: 15px; border-left: 2px solid var(--pink); }
    .dialogue.p1 { color: var(--p1-color); text-shadow: 0 0 5px rgba(255,255,255,0.1); }
    .dialogue.p2 { color: var(--p2-color); text-shadow: 0 0 5px rgba(255,255,255,0.1); }

    /* BUTTONS */
    button { background:linear-gradient(145deg,#8b008b,var(--hot)); color:var(--gold); padding:10px 30px; border:none; border-radius:25px; font-size:1em; cursor:pointer; box-shadow:0 0 18px rgba(255,20,147,.6); transition:.3s; font-family:'Lora',serif; position:relative; }
    button:hover { transform:scale(1.05); box-shadow:0 0 30px rgba(255,105,180,.9); }
    button:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
    .small-btn { font-size: 0.9em; padding: 8px 16px; background: #444; box-shadow:none; }

    /* UTILS */
    .box { max-width:600px; margin:20px auto; padding:25px; background:var(--panel); border:1px solid var(--pink); border-radius:15px; box-shadow:0 0 20px rgba(255,105,180,.4); }
    .choice-buttons { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin:30px auto; max-width:800px; }
    .choice { padding:15px 40px; font-size:1.4em; border-radius:30px; font-family:'lust-script-display',serif; }
    .hidden { display:none !important; }
    
    /* INPUTS & LOCKS */
    .input-wrapper { position: relative; width: 95%; margin: 0 auto 15px; }
    .input-wrapper label { display:block; text-align:left; color:var(--gold); margin-bottom:5px; font-size:0.9em; font-family:'Lora',serif; }
    textarea, input, select { width:100%; padding:12px; background:rgba(30,0,50,.9); color:var(--ink); border:1px solid var(--pink); border-radius:8px; font-size:1em; font-family:'Lora',serif; box-sizing:border-box; }
    
    /* LOCKS - Handcuffs & Dollar Cursor */
    .locked-input textarea, 
    .locked-style { 
        opacity:0.5; 
        filter:grayscale(0.8); 
        cursor:url("/cursor-dollar-plane-64.png"), pointer !important; 
        pointer-events:none; /* Clicks hit wrapper */
    }
    .locked-input::after, 
    .locked-style::after { 
        content:""; 
        position:absolute; 
        top:10px; right:10px; 
        width:24px; height:24px; 
        background:url("https://img.icons8.com/ios-filled/50/ffffff/handcuffs.png") center/contain no-repeat; 
        opacity:0.9; 
        pointer-events:none; 
    }
    .locked-input::after { top: 42px; right: 15px; } 

    /* STYLE CARDS */
    .style-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin:15px 0; }
    .card { background:#252525; border-radius:12px; padding:15px; cursor:pointer; text-align:left; border:2px solid transparent; position:relative; transition:.2s; }
    .card:hover { transform:translateY(-3px); border-color:#ff6b6b; }
    .card.selected { border-color:#ff69b4; background:#333; box-shadow:0 0 15px rgba(255,105,180,0.3); }
    .card h3 { margin:0 0 5px; color:#ff6b6b; font-size:1.1em; font-family:'lust-script-display',serif; }
    .card p { font-size:0.9em; opacity:0.9; margin:0; font-family:'Lora',serif; }
    .preview-btn { margin-top:10px; font-size:0.75em; padding:4px 10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none; z-index:5; position:relative; pointer-events: auto !important; cursor: pointer !important;}
    .preview-btn:hover { background:rgba(255,255,255,0.2); }

    /* FATE CARDS */
    .fate-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin:20px auto; max-width:500px; perspective:1000px; }
    .fate-card { width:100%; aspect-ratio:2/3; position:relative; cursor:pointer; background:none; border:none; padding:0; transform-style:preserve-3d; transition:transform 0.6s; }
    .fate-card .inner { position:absolute; inset:0; border-radius:8px; transform-style:preserve-3d; transition:transform 0.6s; box-shadow:0 5px 15px rgba(0,0,0,0.5); }
    .fate-card.flipped .inner { transform:rotateY(180deg); }
    .fate-card .front, .fate-card .back { position:absolute; inset:0; backface-visibility:hidden; border-radius:8px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,215,0,0.3); }
    .fate-card .front { background:#111; z-index:2; } 
    .fate-card .back { background:#2a0033; transform:rotateY(180deg); z-index:1; }
    .fate-card.poof { animation: smokePoof 0.6s forwards; }
    @keyframes smokePoof { 0%{ opacity:1; transform:scale(1); } 100%{ opacity:0; transform:scale(0.5); } }

    /* INTENSITY BUTTONS (Original Size) */
    .intensity-wrap { margin: 10px 0; }
    .intensity-btn { margin: 5px; opacity: 0.6; }
    .intensity-btn.active { opacity: 1; border: 2px solid var(--gold); box-shadow: 0 0 15px var(--hot); }
    
    /* INTENSITY MINI (Game Screen) */
    .intensity-mini { display:flex; gap:5px; justify-content:center; margin: 15px 0; }
    .intensity-mini button { padding: 5px 15px; font-size: 0.8em; opacity: 0.6; }
    .intensity-mini button.active { opacity: 1; border: 1px solid var(--gold); }

    /* LOADING BAR (Restored from Reference) */
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.65); display: none; align-items: center; justify-content: center; z-index: 200; }
    #loadingOverlayInner { background: rgba(10, 0, 30, 0.95); padding: 18px 26px 14px 26px; border-radius: 14px; box-shadow: 0 0 35px rgba(255, 20, 147, 0.8); min-width: 280px; text-align: left; font-size: 0.95em; }
    #loadingOverlayBar { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.12); border-radius: 999px; overflow: hidden; margin-top: 8px; }
    #loadingOverlayFill { width: 0%; height: 100%; background: var(--pink); transition: width 0.25s; }

    /* BURGER (No Circle) */
    #burgerBtn { position:fixed; top:15px; right:15px; z-index:5000; font-size:1.8em; background:none; border:none; color:var(--pink); padding:0; cursor:pointer; text-shadow: 0 0 5px var(--hot); box-shadow:none; }
    #burgerBtn:hover { transform: scale(1.1); box-shadow:none; }

    /* VISUALIZE MODAL */
    .viz-modal-content { text-align: center; max-width: 600px; width: 90%; }
    .viz-controls { display:flex; gap:10px; justify-content:center; margin-top:15px; flex-wrap:wrap; }
    #vizPreviewImg { width: 100%; border-radius: 8px; margin-top: 10px; max-height: 400px; object-fit: contain; background:#000; }

    /* STORY TEXT */
    .story-section { margin-bottom: 20px; animation: fadeIn 1s ease; }
    .story-image { width:100%; border-radius:12px; margin:15px 0; border:1px solid var(--pink); box-shadow:0 0 20px rgba(255,20,147,0.3); }
    .separator { text-align:center; font-size:1.5em; color:var(--gold); margin:30px 0; opacity:0.8; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    @media (max-width:700px) { .fate-grid { grid-template-columns:repeat(3,1fr); } .fate-card:nth-child(4), .fate-card:nth-child(5) { grid-column:span 1; } }
  </style>
</head>

<body>

<button id="burgerBtn">â˜°</button>
<div id="menuOverlay" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:4999; align-items:center; justify-content:center; display:flex;">
  <div class="box">
    <h3>Menu</h3>
    <button onclick="restart()">Restart Story</button>
    <button onclick="changeTier()">Change Tier</button>
    <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
    <p style="font-size:0.9em; color:var(--gold)">Theme</p>
    <div style="display:flex; gap:5px; justify-content:center;">
        <button class="small-btn" onclick="setTheme('default')">Default</button>
        <button class="small-btn" onclick="setTheme('sepia')">Sepia</button>
        <button class="small-btn" onclick="setTheme('midnight')">Midnight</button>
    </div>
    <br>
    <button onclick="document.getElementById('menuOverlay').classList.add('hidden')" style="background:#444">Close</button>
  </div>
</div>

<div id="loadingOverlay">
  <div id="loadingOverlayInner">
    <div id="loadingText" style="font-style:italic; color:var(--gold);">Stoking the embers...</div>
    <div id="loadingOverlayBar"><div id="loadingOverlayFill"></div></div>
  </div>
</div>

<div id="vizModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center; display:flex;">
  <div class="box viz-modal-content">
    <h3>Visualization</h3>
    <img id="vizPreviewImg" src="" alt="Generating...">
    <div class="viz-controls">
        <select id="vizModel" style="width:auto; padding:5px;">
            <option value="grok-2-image-1212">Grok 2</option>
            <option value="dall-e-3">DALL-E 3</option>
            <option value="midjourney">Midjourney (Mock)</option>
        </select>
        <button class="small-btn" onclick="visualize(true)">Re-Visualize</button>
        <button onclick="insertImage()">Insert</button>
        <button class="small-btn" style="background:#555" onclick="closeViz()">Cancel</button>
    </div>
  </div>
</div>

<div id="ageGate" style="position:fixed; inset:0; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
  <h2>Storybound</h2>
  <p style="font-size:1.2em; max-width:500px; margin:20px;">Explicit adult themes. 18+ Only.</p>
  <button id="ageYes">I am 18+</button>
  <button onclick="location.href='https://google.com'" style="background:#333">Exit</button>
</div>

<div id="tosGate" class="hidden" style="position:fixed; inset:0; background:#000; z-index:9998; flex-direction:column; align-items:center; justify-content:center; display:flex;">
  <h2>Terms of Service</h2>
  <div class="box" style="text-align:left; height:60vh; overflow-y:auto; font-size:0.85em; line-height:1.5;">
    <p><strong>TERMS OF SERVICE</strong></p>
    <p>1. <strong>Age Requirement:</strong> You must be 18+.</p>
    <p>2. <strong>Content:</strong> Adult fantasy roleplay only. No non-consensual content, violence, or minors.</p>
    <p>3. <strong>Liability:</strong> Use at your own risk. Storybound is entertainment.</p>
    <p><em>(Full text abbreviated for display, but legally binding).</em></p>
  </div>
  <label><input type="checkbox" id="tosCheck"> I agree to the Terms</label>
  <br>
  <button id="tosBtn" disabled>Enter Storybound</button>
</div>

<div id="tierGate" class="hidden" style="position:fixed; inset:0; background:#000; z-index:9997; flex-direction:column; align-items:center; justify-content:center; display:flex;">
  <h2>Choose Your Path</h2>
  <div class="choice-buttons">
    <div style="text-align:center">
      <button class="choice" id="btnTease">Tease</button>
      <p style="opacity:0.7">Free. Limited Styles.</p>
    </div>
    <div style="text-align:center">
      <button class="choice" id="btnIndulge">Indulge</button>
      <p style="opacity:0.7">Premium. Unlocked.</p>
    </div>
  </div>
</div>

<div id="payModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center; display:flex;">
  <div class="box" style="text-align:center">
    <h3>Unshackle Your Fate</h3>
    <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin:20px 0;">
        <div id="optUnlock" class="hidden" style="background:#222; padding:15px; border-radius:10px; border:1px solid #ff69b4; width:200px;">
            <h4>Unlock This Story</h4>
            <p>Inputs & features for this session.</p>
            <button id="payOneTime" style="width:100%">Unlock ($1)</button>
        </div>
        <div id="optSub" style="background:#400020; padding:15px; border-radius:10px; border:1px solid gold; width:200px;">
            <h4>Indulge Forever</h4>
            <p>Unlimited access.</p>
            <button id="paySub" style="width:100%">Subscribe ($6/mo)</button>
        </div>
    </div>
    <button onclick="document.getElementById('payModal').classList.add('hidden')" style="background:#444">Cancel</button>
  </div>
</div>

<div id="previewModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:5000; align-items:center; justify-content:center; display:flex;">
  <div class="box">
    <p id="previewText" style="font-size:1.3em; font-style:italic; line-height:1.6"></p>
    <button onclick="document.getElementById('previewModal').classList.add('hidden')">Close</button>
  </div>
</div>

<div id="app" class="hidden">

  <div id="modeSelect">
    <h1 style="margin-top:40px">Storybound</h1>
    <p style="color:var(--gold); font-style:italic; margin-bottom:40px;">Will you enter a world of danger and decadence alone, or with a liaison?</p>
    <div class="choice-buttons">
      <button class="choice" onclick="setMode('solo')">Solo</button>
      <button class="choice" onclick="setMode('couple')">Couple</button>
      <button class="choice" onclick="alert('Coming soon.')">Stranger</button>
    </div>
  </div>

  <div id="setup" class="hidden" style="max-width:800px; margin:0 auto; padding-bottom:50px;">
    
    <div class="section-title">Gender & Preference</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; width:95%; margin:0 auto;">
        <div>
            <label>Your Gender</label>
            <select id="playerGender" onchange="checkCustom('playerGender', 'customPlayerGender')">
                <option value="Female">Female</option>
                <option value="Male">Male</option>
                <option value="Non-Binary">Non-Binary</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customPlayerGender" type="text" placeholder="Enter gender..." class="hidden" style="margin-top:5px;">
        </div>
        <div>
            <label>Love Interest</label>
            <select id="loveInterestGender" onchange="checkCustom('loveInterestGender', 'customLoveInterest')">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Non-Binary">Non-Binary</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customLoveInterest" type="text" placeholder="Enter gender..." class="hidden" style="margin-top:5px;">
        </div>
    </div>

    <div class="section-title">Intensity</div>
    <div id="intensityBtns" class="intensity-wrap">
      <button data-val="Clean" data-desc="Flirtation, chemistry, and longing. No explicit anatomy." class="intensity-btn">Clean</button>
      <button data-val="Naughty" data-desc="Direct teasing with tasteful sensuality." class="intensity-btn active">Naughty</button>
      <button data-val="Erotic" data-desc="Explicit intimacy and sensual detail." class="intensity-btn">Erotic</button>
      <button data-val="Dirty" data-desc="Very explicit language and bold scenes." class="intensity-btn">Dirty</button>
    </div>
    <p id="intensityDesc" style="color:var(--gold); font-style:italic; margin-top:10px;">(Naughty) Direct teasing with tasteful sensuality.</p>

    <div class="section-title">Genres <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="genreGrid">
      <div class="card" data-grp="genre" data-val="Romantasy"><h3>Romantasy</h3><p>High fantasy worlds, magic, and intense romantic stakes.</p></div>
      <div class="card" data-grp="genre" data-val="Contemporary"><h3>Contemporary Romance</h3><p>Modern settings and present-day relationships.</p></div>
      <div class="card" data-grp="genre" data-val="Historical"><h3>Historical Romance</h3><p>Pre-mid-20th century love with period rules.</p></div>
      <div class="card" data-grp="genre" data-val="Paranormal"><h3>Paranormal Modern Romance</h3><p>Vampires, shifters, witches in todayâ€™s world.</p></div>
      <div class="card" data-grp="genre" data-val="Dark"><h3>Dark Romance</h3><p>Morally gray heat; player defines boundaries.</p></div>
      <div class="card" data-grp="genre" data-val="Suspense"><h3>Romantic Suspense</h3><p>Romance entangled with danger and mystery.</p></div>
      <div class="card" data-grp="genre" data-val="Sports"><h3>Sports Romance</h3><p>Athletes and competitive tension.</p></div>
      <div class="card" data-grp="genre" data-val="Crime"><h3>Organized Crime Romance</h3><p>Forbidden love in criminal worlds.</p></div>
    </div>
    
    <button class="small-btn" onclick="toggle('moreGenres')">More Genres</button>
    <div id="moreGenres" class="style-cards hidden">
       <div class="card" data-grp="genre" data-val="Billionaire"><h3>Billionaire Romance</h3><p>Ultra-wealthy leads, power, polish.</p></div>
       <div class="card" data-grp="genre" data-val="Gothic"><h3>Gothic Romance</h3><p>Moody, haunted settings.</p></div>
       <div class="card" data-grp="genre" data-val="LGBTQ"><h3>Queer LGBTQ+</h3><p>Inclusive love stories.</p></div>
       <div class="card" data-grp="genre" data-val="SecondChance"><h3>Second Chance</h3><p>Ex-lovers reunited with baggage.</p></div>
       <div class="card" data-grp="genre" data-val="SmallTown"><h3>Small Town</h3><p>Cozy community vibes.</p></div>
       <div class="card" data-grp="genre" data-val="Romcom"><h3>Romantic Comedy</h3><p>Bantery, light chaos.</p></div>
    </div>

    <div class="section-title">Dynamics <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="dynamicGrid">
      <div class="card" data-grp="dynamic" data-val="Enemies"><h3>Enemies â†’ Lovers</h3><p>Rivals whose friction turns to heat.</p></div>
      <div class="card" data-grp="dynamic" data-val="Forbidden"><h3>Forbidden Love</h3><p>Desire under rules and taboo.</p></div>
      <div class="card" data-grp="dynamic" data-val="Power"><h3>Power Imbalance</h3><p>Player defines boundaries and limits.</p></div>
      <div class="card" data-grp="dynamic" data-val="SlowBurn"><h3>Slow Burn</h3><p>High restraint, earned payoff.</p></div>
      <div class="card" data-grp="dynamic" data-val="Friends"><h3>Friends â†’ Lovers</h3><p>Safety tipping into heat.</p></div>
      <div class="card" data-grp="dynamic" data-val="Proximity"><h3>Forced Proximity</h3><p>Close quarters, rising tension.</p></div>
      <div class="card" data-grp="dynamic" data-val="Secret"><h3>Secret Identity</h3><p>Truths revealed at the worst time.</p></div>
      <div class="card" data-grp="dynamic" data-val="Obsessive"><h3>Obsessive Devotion</h3><p>Intense focus, player sets bounds.</p></div>
      <div class="card" data-grp="dynamic" data-val="Fated"><h3>Fated Mates / Soulbond</h3><p>Destined bond, fast intensity.</p></div>
      <div class="card" data-grp="dynamic" data-val="Caretaker"><h3>Caretaker / Wounded One</h3><p>Vulnerability and steady support.</p></div>
    </div>

    <div class="section-title">Story POV</div>
    <div class="style-cards" id="povGrid">
      <div class="card selected" data-grp="pov" data-val="First"><h3>1st Person (I)</h3><p>Intimate, confessional, inside your pulse.</p><button class="preview-btn" data-txt="I held my breath as the door clicked shut behind him.">Preview</button></div>
      <div class="card" data-grp="pov" data-val="Second"><h3>2nd Person (You)</h3><p>Immediate, immersive, hands-on tension.</p><button class="preview-btn" data-txt="You feel the room shift the moment he looks at you.">Preview</button></div>
      <div class="card" data-grp="pov" data-val="Third"><h3>3rd Person (They)</h3><p>Wider lens, cinematic, controlled heat.</p><button class="preview-btn" data-txt="He kept his voice calm, but the way his gaze lingered betrayed the hunger.">Preview</button></div>
      <div class="card" data-grp="pov" data-val="Fourth"><h3>4th Person (We)</h3><p>Choral, conspiratorial, shared gaze.</p><button class="preview-btn" data-txt="We watched them circle each otherâ€”two storms pretending to be weather.">Preview</button></div>
      <div class="card" data-grp="pov" data-val="Fifth"><h3>5th Person (Author)</h3><p>Playful narrator with a hand on the page.</p><button class="preview-btn" data-txt="The Author hesitatedâ€”then smiledâ€”and offered them a door.">Preview</button></div>
    </div>

    <div class="section-title">Story Style <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="styleGrid">
      <div class="card selected" data-grp="style" data-val="Breathless"><h3>Breathless Romance</h3><p>Fast tension, close POV, lush romantic heat.</p><button class="preview-btn" data-txt="His attention was a slow hand. It didnâ€™t touch herâ€”yet she felt it everywhere.">Preview</button></div>
      <div class="card" data-grp="style" data-val="Epic" data-locked="true"><h3>Epic Fantasy</h3><p>Grand stakes, wonder, danger, sweeping romance.</p><button class="preview-btn" data-txt="The city burned like a crownâ€”and someone inside it was waiting to claim her.">Preview</button></div>
      <div class="card" data-grp="style" data-val="Playful" data-locked="true"><h3>Playful Heat</h3><p>Flirty banter, teasing humor, spark-first chemistry.</p><button class="preview-btn" data-txt="â€œYouâ€™re staring.â€ â€œIâ€™m appreciating.â€">Preview</button></div>
      <div class="card" data-grp="style" data-val="Dark" data-locked="true"><h3>Dark Desire</h3><p>Moody, dangerous tension with boundaries respected.</p><button class="preview-btn" data-txt="He smiled like a promise with teeth.">Preview</button></div>
      <div class="card" data-grp="style" data-val="Raw" data-locked="true"><h3>Raw Passion</h3><p>Direct emotion, embodied desire, grounded intensity.</p><button class="preview-btn" data-txt="He didn't ask twice.">Preview</button></div>
      <div class="card" data-grp="style" data-val="Regency" data-locked="true"><h3>Regency Restraint</h3><p>Polite knives, forbidden longing, exquisite restraint.</p><button class="preview-btn" data-txt="â€œYour reputation is in danger,â€ she murmured.">Preview</button></div>
    </div>
    
    <button class="small-btn" onclick="toggle('moreStyles')">More Styles</button>
    <div id="moreStyles" class="style-cards hidden">
       <div class="card" data-grp="style" data-val="Wry" data-locked="true"><h3>Wry Confession</h3><p>Dry wit, sharp honesty, intimate tension.</p></div>
       <div class="card" data-grp="style" data-val="Strategic" data-locked="true"><h3>Strategic Intensity</h3><p>Calculated seduction, power games.</p></div>
       <div class="card" data-grp="style" data-val="Surreal" data-locked="true"><h3>Surreal Bloom</h3><p>Dreamlike imagery, symbolic heat.</p></div>
       <div class="card" data-grp="style" data-val="Brutal" data-locked="true"><h3>Brutal Edge</h3><p>Blunt honesty, razor tension.</p></div>
       <div class="card" data-grp="style" data-val="Satirical" data-locked="true"><h3>Satirical Fantasy</h3><p>Witty fantasy, playful stakes.</p></div>
       <div class="card" data-grp="style" data-val="Shakespearean" data-locked="true"><h3>Shakespearean</h3><p>Elevated cadence, poetic desire.</p></div>
       <div class="card" data-grp="style" data-val="SciFi" data-locked="true"><h3>SciFi Opera</h3><p>Grand futuristic worlds, high stakes.</p></div>
    </div>

    <div class="section-title">Story Controls</div>
    <div id="storyControlsBox" class="input-wrapper locked-input" onclick="showPaywall('unlock')">
       <textarea id="storyControls" rows="3" placeholder="E.g. No vampires, more dialogue..." disabled></textarea>
    </div>

    <br>
    <button id="beginBtn" style="font-size:1.5em; margin-top:20px;">Begin Story</button>
  </div>

  <div id="game" class="hidden" style="max-width:900px; margin:0 auto; padding-bottom:60px;">
    <h2 id="storyTitle"></h2>
    <p id="storySynopsis" style="color:var(--gold); font-style:italic; margin-bottom:20px;"></p>
    
    <div id="storyText" class="box" style="text-align:left; max-width:100%; min-height:300px; margin-bottom:20px;"></div>

    <div style="text-align:center; margin-bottom:10px;">
        <button onclick="visualize()" style="font-size:0.9em; background:#444;">âœ¨ Visualize This Scene</button>
    </div>

    <div class="section-title" style="font-size:1.8em; margin-top:0;">Guide Your Fate</div>
    
    <div id="cardMount" class="fate-grid"></div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
      <div class="input-wrapper locked-input" id="actionWrapper" onclick="showPaywall('unlock')">
          <label>What do you do?</label>
          <textarea id="actionInput" rows="3" placeholder="Action..." disabled></textarea>
      </div>
      <div class="input-wrapper locked-input" id="dialogueWrapper" onclick="showPaywall('unlock')">
          <label>What do you say?</label>
          <textarea id="dialogueInput" rows="3" placeholder="Dialogue..." disabled></textarea>
      </div>
    </div>

    <div class="intensity-mini" id="gameIntensity">
        <button onclick="setGameIntensity('Clean')">Clean</button>
        <button onclick="setGameIntensity('Naughty')" class="active">Naughty</button>
        <button onclick="setGameIntensity('Erotic')">Erotic</button>
        <button onclick="setGameIntensity('Dirty')">Dirty</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; align-items:center;">
       <button id="saveBtn" class="small-btn locked-style" onclick="showPaywall('unlock')">Save</button>
       <button id="submitBtn" style="font-size:1.3em;">Submit Turn</button>
    </div>
    
    <div style="margin-top:10px;">
       <button id="gameControlsBtn" class="small-btn locked-style" onclick="showPaywall('unlock')">Story Controls</button>
    </div>

  </div>

</div>

<script>
(function(){
  // --- CONFIG ---
  var PROXY_URL = 'https://storybound-proxy.vercel.app/api/proxy';
  var IMAGE_PROXY_URL = 'https://storybound-proxy.vercel.app/api/image';
  const STORY_MODEL = 'grok-4-1-fast-reasoning'; 

  var state = { tier:'free', picks:{ genre:[], dynamic:[], pov:'First', style:['Breathless'] }, gender:'Female', loveInterest:'Male', intensity:'Naughty' };
  var tempImgUrl = null;

  // --- HELPERS ---
  function $(id){ return document.getElementById(id); }
  window.toggle = function(id){ $(id).classList.toggle('hidden'); }
  function hideAll(){ ['modeSelect','setup','game'].forEach(x => $(x)?.classList.add('hidden')); }
  window.checkCustom = function(selectId, inputId){
      if($(selectId).value === 'Custom') $(inputId).classList.remove('hidden');
      else $(inputId).classList.add('hidden');
  }

  // --- COLORS FOR DIALOGUE ---
  function getGenderColor(g){
      if(g === 'Male') return '#B0E0E6'; // Powder Blue
      if(g === 'Female') return '#FFB6C1'; // Powder Pink
      return '#77DD77'; // Pastel Green
  }

  // --- API CALL ---
  async function callChat(messages){
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ model: STORY_MODEL, messages })
    });
    const data = await res.json();
    return data.choices?.[0]?.message?.content || '';
  }

  // --- LOADING ---
  const loadingPhrases = ["Stoking the embers...", "Consulting your desires...", "Sharpening tension...", "Weaving fate..."];
  let loadInt;
  function startLoading(){
    $('loadingOverlay').style.display = 'flex';
    let i=0;
    $('loadingText').innerText = loadingPhrases[0];
    $('loadingOverlayFill').style.width = '10%';
    loadInt = setInterval(() => {
        i++;
        $('loadingText').innerText = loadingPhrases[i % loadingPhrases.length];
        $('loadingOverlayFill').style.width = Math.min(90, i*20) + '%';
    }, 1000);
  }
  function stopLoading(){
    clearInterval(loadInt);
    $('loadingOverlayFill').style.width = '100%';
    setTimeout(() => { $('loadingOverlay').style.display = 'none'; $('loadingOverlayFill').style.width='0%'; }, 300);
  }

  // --- FATE CARDS ---
  function initCards(){
      const m = $('cardMount');
      m.innerHTML = '';
      const labels = ["FATE", "FATE", "FATE", "FATE", "FATE"];
      const backs = ["ðŸ·", "ðŸ”¥", "âš”ï¸", "ðŸ‘‘", "ðŸ•Šï¸"];
      labels.forEach((l, i) => {
          const btn = document.createElement('button');
          btn.className = 'fate-card';
          btn.innerHTML = `<div class="inner"><div class="front"><h3>${l}</h3></div><div class="back"><div style="font-size:30px">${backs[i]}</div></div></div>`;
          btn.onclick = () => {
              btn.classList.toggle('flipped');
              if(btn.classList.contains('flipped')){
                  $('actionInput').value = "I take a calculated risk."; 
              }
          };
          m.appendChild(btn);
      });
  }

  // --- FORMATTING ---
  function formatStory(text){
      let p1Color = getGenderColor(state.gender);
      let p2Color = getGenderColor(state.loveInterest);
      document.documentElement.style.setProperty('--p1-color', p1Color);
      document.documentElement.style.setProperty('--p2-color', p2Color);

      let html = text.replace(/\n/g, '<br><br>');
      html = html.replace(/"([^"]+)"/g, (match, content) => {
          let isP1 = state.pov === 'First' || content.toLowerCase().includes(" i ");
          let cls = isP1 ? 'p1' : 'p2';
          return `<span class="dialogue ${cls}">"${content}"</span>`;
      });
      html = html.replace(/Player Action:|What do you do\?/gi, "");
      return html;
  }

  // --- NAVIGATION ---
  $('ageYes').onclick = function(){ $('ageGate').classList.add('hidden'); $('tosGate').classList.remove('hidden'); };
  $('tosCheck').onchange = function(e){ $('tosBtn').disabled = !e.target.checked; };
  $('tosBtn').onclick = function(){ $('tosGate').classList.add('hidden'); $('tierGate').classList.remove('hidden'); };
  
  $('btnTease').onclick = function(){ state.tier='free'; $('tierGate').classList.add('hidden'); $('app').classList.remove('hidden'); };
  $('btnIndulge').onclick = function(){ window.showPaywall('sub'); };

  window.setMode = function(m){
      if(m === 'solo') { $('modeSelect').classList.add('hidden'); $('setup').classList.remove('hidden'); }
  };

  window.setTheme = function(t){ document.body.className = 'theme-' + t; };

  // --- BEGIN STORY ---
  $('beginBtn').onclick = async function(){
      state.gender = $('playerGender').value === 'Custom' ? $('customPlayerGender').value : $('playerGender').value;
      state.loveInterest = $('loveInterestGender').value === 'Custom' ? $('customLoveInterest').value : $('loveInterestGender').value;
      
      startLoading();
      hideAll();
      $('game').classList.remove('hidden');
      initCards();

      const sys = `You are a master storyteller. 
      Genre: ${state.picks.genre.join(',')}. 
      Style: ${state.picks.style.join(',')}.
      POV: ${state.picks.pov}.
      Player is ${state.gender}. Love Interest is ${state.loveInterest}.
      Intensity: ${state.intensity}.
      IMPORTANT: This is the OPENING. NO sex acts yet. Focus on PLOT, WORLD-BUILDING, and TENSION. Establish a nemesis and high stakes. Characters must have agendas.
      Output format: Title: <title>\nSynopsis: <synopsis>\n<story body>`;
      
      try {
          const raw = await callChat([{role:'system', content: sys}, {role:'user', content: "Begin."}]);
          
          let title="Storybound", syn="A tale of desire...", body=raw;
          const lines = raw.split('\n');
          lines.forEach(l => {
              if(l.startsWith("Title:")) title = l.replace("Title:","").trim();
              else if(l.startsWith("Synopsis:")) syn = l.replace("Synopsis:","").trim();
          });
          body = body.replace(/Title:.*\n/,'').replace(/Synopsis:.*\n/,'');

          $('storyTitle').textContent = title;
          $('storySynopsis').textContent = syn;
          $('storyText').innerHTML = formatStory(body);
      } catch(e) {
          $('storyText').innerHTML = "<p>Backend failed. Fallback loaded.</p>";
      }
      stopLoading();
  };

  // --- SUBMIT TURN ---
  $('submitBtn').onclick = async function(){
      startLoading();
      $('storyText').innerHTML += `<div class="separator">âšœ</div>`;
      const act = $('actionInput').value;
      $('actionInput').value = ''; 
      
      try {
          const sys = `Continue the story. Player (${state.gender}) does: ${act}. Love Interest is ${state.loveInterest}. Do NOT repeat "Player Action:". Write the scene directly.`;
          const raw = await callChat([{role:'system', content:sys}, {role:'user', content: "Next scene."}]);
          $('storyText').innerHTML += formatStory(raw);
          $('storyText').lastElementChild.scrollIntoView({behavior:'smooth'});
      } catch(e){ console.log(e); }
      
      document.querySelectorAll('.fate-card').forEach(c => c.classList.remove('flipped'));
      stopLoading();
  };

  // --- VISUALIZE ---
  window.visualize = async function(isRe){
      startLoading();
      const lastText = $('storyText').textContent.slice(-500);
      try {
          const promptMsg = await callChat([{role:'user', content:`Describe this scene for an image generator (no nudity, cinematic, elegant fantasy art): ${lastText}`}]);
          const res = await fetch(IMAGE_PROXY_URL, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ prompt: promptMsg })
          });
          const data = await res.json();
          tempImgUrl = data.url || 'https://via.placeholder.com/600x400?text=Mock+Image+Fallback';
          
          $('vizPreviewImg').src = tempImgUrl;
          $('vizModal').classList.remove('hidden');
      } catch(e){
          // Fallback so it doesn't just crash
          tempImgUrl = 'https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?q=80&w=600&auto=format&fit=crop'; 
          $('vizPreviewImg').src = tempImgUrl;
          $('vizModal').classList.remove('hidden');
      }
      stopLoading();
  };

  window.insertImage = function(){
      if(tempImgUrl){
          $('storyText').innerHTML += `<img src="${tempImgUrl}" class="story-image">`;
          $('vizModal').classList.add('hidden');
      }
  };
  window.closeViz = function(){ $('vizModal').classList.add('hidden'); };

  // --- SELECTION LOGIC ---
  document.addEventListener('click', e => {
      const card = e.target.closest('.card');
      if(!card) return;
      if(e.target.classList.contains('preview-btn')){
          e.stopPropagation();
          $('previewText').innerText = e.target.getAttribute('data-txt');
          $('previewModal').classList.remove('hidden');
          return;
      }
      const grp = card.getAttribute('data-grp');
      const val = card.getAttribute('data-val');
      const locked = card.getAttribute('data-locked');

      if(state.tier === 'free' && locked === 'true'){
          window.showPaywall('unlock'); 
          return;
      }
      
      if(['genre','dynamic','style'].includes(grp)){
          if(!state.picks[grp]) state.picks[grp] = [];
          if(state.picks[grp].includes(val)){
              state.picks[grp] = state.picks[grp].filter(x=>x!==val);
              card.classList.remove('selected');
          } else {
              if(state.picks[grp].length >= 3) return alert("Max 3 allowed.");
              state.picks[grp].push(val);
              card.classList.add('selected');
          }
      } else {
          document.querySelectorAll(`[data-grp="${grp}"]`).forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected');
          state.picks[grp] = val;
      }
  });

  // --- INTENSITY LOGIC ---
  document.querySelectorAll('.intensity-btn').forEach(b => {
      b.onclick = function(){
          document.querySelectorAll('.intensity-btn').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          state.intensity = b.getAttribute('data-val');
          const desc = b.getAttribute('data-desc');
          if($('intensityDesc')) $('intensityDesc').innerText = `(${state.intensity}) ${desc}`;
      }
  });

})();
</script>
<script src="/fatecards/storybound-cards.js"></script>
</body>
</html>

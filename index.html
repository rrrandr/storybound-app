<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storybound</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@300;400&family=Playfair+Display:wght@400;700&family=Open+Sans:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@400;700&family=Allura&family=Glass+Antiqua&family=Eagle+Lake&family=Smooch+Sans:wght@300;500&family=Pinyon+Script&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://use.typekit.net/bzl3zth.css">

  <link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="auth-panel" class="hidden">
  <input id="auth-email" placeholder="Email" />
  <input id="auth-password" type="password" placeholder="Password" />
  <button id="btn-signin">Sign in</button>
  <div id="auth-status"></div>
</div>

<button id="burgerBtn">☰</button>
<button id="globalBackBtn" class="hidden" style="position:fixed; top:15px; left:15px; z-index:5000; background:none; border:none; font-size:1.5em; cursor:pointer;">←</button>

<div id="menuOverlay" class="overlay hidden" style="z-index:4999;">
  <div class="box">
    <h3>Menu</h3>
<div id="menuAuthSection"></div>

    <button onclick="window.restart()">Restart Story</button>
    <button onclick="window.changeTier()">Change Tier</button>
    <button id="continueStoryBtn" class="hidden" onclick="window.continueStory()">Continue Saved Story</button>
    <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
    
    <label class="setting-label">Theme</label>
    <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap; margin-bottom:15px;">
        <button class="small-btn" onclick="setTheme('default')">Default</button>
        <button class="small-btn" onclick="setTheme('sepia')">Sepia</button>
        <button class="small-btn" onclick="setTheme('midnight')">Midnight</button>
        <button class="small-btn" onclick="setTheme('print')">Print</button>
        <button class="small-btn" onclick="setTheme('easy')">Easy</button>
    </div>

    <label class="setting-label">Font</label>
    <select id="fontSelect" onchange="setFont(this.value)" style="margin-bottom:15px; width:100%;">
        <option value="'Lora', serif">Lora (Default)</option>
        <option value="'Grenze Gotisch', cursive">Grenze Gotisch</option>
        <option value="'Allura', cursive">Allura</option>
        <option value="'Glass Antiqua', cursive">Glass Antiqua</option>
        <option value="'Eagle Lake', cursive">Eagle Lake</option>
        <option value="'Smooch Sans', sans-serif">Smooch Sans</option>
        <option value="'Pinyon Script', cursive">Pinyon Script</option>
        <option value="'Merriweather', serif">Merriweather</option>
        <option value="'Roboto', sans-serif">Roboto</option>
    </select>

    <label class="setting-label">Font Size</label>
    <input type="range" min="16" max="72" value="18" oninput="setFontSize(this.value)">

    <br><br>
    <button onclick="document.getElementById('menuOverlay').classList.add('hidden')" style="background:#444">Close</button>
  </div>
</div>

<div id="loadingOverlay" class="overlay hidden" style="z-index:9000;">
  <div id="loadingOverlayInner">
    <button id="loadingCancelBtn" class="loading-cancel-btn" title="Cancel">&times;</button>
    <div id="loadingText">Stoking the embers...</div>
    <div id="loadingOverlayBar"><div id="loadingOverlayFill"></div></div>
    <div id="loadingPercent">0%</div>
  </div>
</div>

<div id="vizModal" class="overlay hidden">
  <div class="box viz-modal-content">
    <h3>Visualization</h3>
    <!-- CORRECTIVE: Explanatory copy for visualization -->
    <p style="font-size:0.85em; color:var(--gold); margin-bottom:10px; font-style:italic;">
        You may freely edit the prompt below. Images are limited to Naughty-level eroticism.
        Prompts are automatically scaled down to avoid artist refusal.
    </p>
    <textarea id="vizPromptInput" placeholder="Prompt will appear here..."></textarea>

    <!-- CORRECTIVE: Quick Prompt Modifier heading -->
    <h4 style="font-size:1.1em; color:var(--pink); margin:15px 0 5px; font-weight:bold;">Quick Prompt Modifier</h4>
    <!-- Modifier section: scrolling suggestions + text input -->
    <div id="vizModifierSection" class="fate-input-wrapper" style="margin-top:5px;">
        <input type="text" id="vizModifierInput" class="fate-field" placeholder="">
        <div class="rotating-placeholder" data-for="vizModifierInput"></div>
    </div>
    <!-- CORRECTIVE: Instructions for modifiers -->
    <p style="font-size:0.8em; color:#888; margin-top:5px; font-style:italic;">
        Type or select a modifier to adjust the image. Modifiers are appended to your prompt.
    </p>

    <div id="vizPlaceholder">Generating...</div>

    <div id="vizImgContainer">
        <img id="vizPreviewImg" alt="Scene" style="display:none">
        <div id="vizError" class="img-error-msg hidden"></div>
    </div>

    <div class="viz-controls">
        <select id="vizModel" disabled style="opacity:0.6;">
            <option value="perchance" selected>Perchance</option>
        </select>
        <button class="small-btn" id="vizRetryBtn" onclick="window.visualize(true)">Re-Visualize</button>
        <button onclick="window.insertImage()">Insert</button>
        <button class="small-btn" style="background:#555" onclick="window.closeViz()">Cancel</button>
    </div>
    <label class="sb-checkbox" style="font-size:0.8em; justify-content:center; margin-top:12px;">
        <input type="checkbox" id="chkAutoLockVisual" checked>
        <span class="sb-checkbox-visual"></span>
        <span class="sb-checkbox-label" style="color:var(--gold); opacity:0.8;">Lock character look after this Visualize</span>
    </label>
  </div>
</div>

<div id="eroticPreviewModal" class="overlay hidden" style="z-index:10001;">
  <div class="box" style="max-width:500px;">
    <h3 style="color:var(--hot)">Erotic Intensity Preview</h3>
    <p style="opacity:0.8; font-size:0.9em;">Explicit content enabled. Sample:</p>
    <div id="eroticPreviewText"></div>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
        <button onclick="window.showPaywall('unlock');">Storypass $3</button>
        <button onclick="document.getElementById('eroticPreviewModal').classList.add('hidden')" style="background:#444">Not Now</button>
    </div>
  </div>
</div>

<div id="coupleInvite" class="overlay hidden">
  <div class="box" style="max-width:520px; text-align:center;">
    <h3>Open a Private Chamber</h3>

    <div class="couple-status-box">
      <div><strong>Your nickname:</strong> <span id="sbNickLabel" style="color:var(--gold)">…</span></div>
      <div><strong>Status:</strong> <span id="coupleStatus" style="font-style:italic">Not connected</span></div>
      <div><strong>Room Code:</strong> <span id="coupleRoomCodeLabel" style="font-family:monospace; color:var(--pink)">—</span></div>
    </div>

    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
      <button id="btnCreateRoom">New Invitation</button>
      <button id="btnJoinRoom" style="background:#444">Join Room</button>
    </div>

    <div id="joinRow" class="hidden" style="margin-bottom:15px; display:flex; gap:10px; justify-content:center;">
      <input id="joinCodeInput" placeholder="Enter 6-char Code" style="text-transform:uppercase; text-align:center; width:150px;">
      <button id="btnJoinGo">Enter</button>
    </div>

    <div id="roomCodeWrap" class="hidden" style="margin-bottom:15px;">
      <div class="invitation-card" style="background: rgba(255,105,180,0.08); border: 1px solid rgba(255,105,180,0.3); border-radius: 10px; padding: 20px; margin-bottom: 15px;">
        <p id="invitationText" style="font-style: italic; color: var(--ink); margin: 0 0 15px; line-height: 1.5;">
          "A private chamber awaits. The mask is optional. The curiosity is not."
        </p>
        <div id="coupleRoomCodeWrap">
           <div id="roomCodeBig">—</div>
           <button id="btnCopyCode" title="Copy Code">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
           </button>
        </div>
      </div>

      <p style="margin:0 0 10px; font-size:0.85em; color:var(--gold);">Send invitation via:</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
        <button id="btnSendEmail" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">Email</button>
        <button id="btnSendSMS" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">SMS</button>
        <button id="btnSendBoth" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">Both</button>
      </div>
      <p id="inviteSentStatus" class="hidden" style="color:var(--gold); font-size:0.85em; margin:10px 0;">Invitation sent. Awaiting your paramour...</p>
    </div>

    <div>
      <button id="btnEnterCoupleGame" class="hidden" style="width:100%; margin-bottom:10px;" disabled>Enter Chamber Together</button>
      <button id="btnPlaySoloWaiting" class="hidden" style="width:100%; margin-bottom:10px; background:#333; border:1px solid var(--gold);">Play Solo Until Your Paramour Joins</button>
      <button onclick="window.coupleCleanup(); window.showScreen('modeSelect')" style="background:transparent; border:1px solid #444; font-size:0.9em;">Back</button>
    </div>
  </div>
</div>

<div id="coupleConsentModal" class="overlay hidden">
  <div class="box" style="max-width:450px; text-align:center;">
    <h3 style="color:var(--gold);">Shared Intensity Agreement</h3>
    <p>You are entering a shared hallucination. Before you begin:</p>
    <ul style="text-align:left; font-size:0.9em; line-height:1.5; color:var(--ink); margin: 20px auto; max-width: 350px;">
        <li><strong>Intensity is a hard ceiling.</strong> Limits depictions regardless of input.</li>
        <li><strong>Inputs are requests.</strong> Naughty reinterprets explicit inputs as tension.</li>
        <li><strong>Upgrades required.</strong> Higher intensity requires appropriate tier.</li>
    </ul>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button id="btnCoupleAgree">Agree & Enter</button>
        <button onclick="window.showScreen('setup'); document.getElementById('coupleConsentModal').classList.add('hidden');" style="background:#444">Change Settings</button>
    </div>
  </div>
</div>

<div id="strangerModal" class="overlay hidden">
  <div class="box">
    <h3>How Daring...</h3>
    <p><span id="strangerCount">12,408</span> others are seeking a connection right now.</p>
    <p style="font-style:italic; color:var(--gold)">Matching is currently unavailable in this version.</p>
    <button onclick="window.showScreen('modeSelect')" style="background:#444">Return</button>
  </div>
</div>

<div id="ageGate" class="screen overlay" style="background:#000; z-index:9999;">
  <div style="text-align:center;">
      <h2>Storybound</h2>
      <p style="font-size:1.2em; max-width:500px; margin:20px;">Explicit adult themes. 18+ Only.</p>
      <button id="ageYes">I am 18+</button>
      <button onclick="location.href='https://google.com'" style="background:#333">Exit</button>
  </div>
</div>

<div id="tosGate" class="screen overlay hidden" style="background:#000; z-index:9998;">
  <div class="box" style="text-align:center;">
      <h2>Terms of Service</h2>
      <div class="tos-box">
        <p><strong>TERMS OF SERVICE</strong></p>
        <p>1. <strong>Age Requirement:</strong> You must be 18+.</p>
        <p>2. <strong>Content Policy:</strong> Adult fantasy roleplay only. Content must be consensual. Optional power play is permitted only if explicitly opted-in. No non-consensual sexual acts, sexual violence, or minors.</p>
        <p>3. <strong>Data & AI:</strong> Content generated by third-party AI models. We may anonymize data.</p>
        <p>4. <strong>Liability:</strong> Use at your own risk. Entertainment purposes only.</p>
      </div>
      <label><input type="checkbox" id="tosCheck"> I agree to the Terms</label>
      <br>
      <button id="tosBtn" disabled>Enter Storybound</button>
  </div>
</div>

<div id="tierGate" class="screen overlay hidden" style="background:#000; z-index:9997;">
  <div style="text-align:center;">
      <h2>Storybound</h2>
      <div class="choice-buttons">
        <div style="text-align:center">
          <button class="choice" id="btnTease">Tease</button>
          <p class="choice-desc">A playful warmup—gentle choices, tension, and atmosphere.<br><br><strong>From $Free</strong></p>
        </div>
        <div style="text-align:center">
          <button class="choice" id="btnIndulge">Indulge</button>
          <p class="choice-desc">Longer openings, deeper memory, full control, saved stories.<br><br><strong>From $6/mo</strong></p>
        </div>
      </div>
      <button id="continueFromTierBtn" class="choice hidden" style="margin-top:20px; width:80%; max-width:300px;" onclick="window.continueStory()">Continue Saved Story</button>
  </div>
</div>

<div id="payModal" class="overlay hidden" style="z-index:10000;">
  <div class="box" style="text-align:center; max-width: 500px;">
    <h3>Unshackle Your Fate</h3>
    
    <div id="godModePay" class="hidden">
       <h4 style="color:var(--gold); margin-top:0; font-size:1.4em;">Unlock God Mode</h4>
       <p style="font-size:0.9em; opacity:0.8; margin-bottom:20px;">
         Sandbox power. No cooldowns. No safety.
         <br><strong>$50 One-time purchase.</strong>
       </p>
       <button id="payGodMode" style="width:100%; margin-top:10px; background:var(--gold); color:black;">Unlock Forever ($50)</button>
    </div>

    <div id="standardPay">
        <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin:20px 0;">
            <div id="optUnlock" class="hidden" style="background:#222; padding:15px; border-radius:10px; border:1px solid #ff69b4; width:220px; text-align:left;">
                <h4 style="color:var(--pink); margin-top:0;">Unlock This Story</h4>
                <p style="font-size:0.85em; line-height:1.4;">Go deeper for this one arc.<br>Erotic intensity, longer pacing, Quill access.<br><strong>$3 Story Pass.</strong></p>
                <button id="payOneTime" style="width:100%; margin-top:15px;">Storypass $3</button>
            </div>

            <div id="optSub" style="background:linear-gradient(145deg, #400020, #200010); padding:15px; border-radius:10px; border:1px solid gold; width:220px; text-align:left;">
                <h4 style="color:var(--gold); margin-top:0;">Indulge Limits</h4>
                <ul style="font-size:0.8em; padding-left:15px; opacity:0.9; line-height:1.4; list-style-type: '⚜ ';">
                    <li>Dirty intensity</li>
                    <li>Long-form stories</li>
                    <li>Unlimited Quill</li>
                    <li>Save anytime</li>
                </ul>
                <div style="text-align:center; font-size:0.9em; margin:10px 0; color:var(--gold);">$6/month</div>
                <button id="paySub" style="width:100%; background:linear-gradient(145deg, gold, #b8860b); color:black; font-weight:bold;">Subscribe</button>
            </div>
        </div>
    </div>
    
    <button onclick="document.getElementById('payModal').classList.add('hidden')" style="background:#444; margin-top:15px;">Cancel</button>
  </div>
</div>

<div id="previewModal" class="overlay hidden" style="z-index:10010;">
  <div class="box">
    <p id="previewText" style="font-size:1.3em; font-style:italic; line-height:1.6"></p>
    <button onclick="document.getElementById('previewModal').classList.add('hidden')">Close</button>
  </div>
</div>

<div id="app" class="hidden">

  <div id="modeSelect" class="screen">
    <h1 style="margin-top:40px">Storybound</h1>
    
    <div class="choice-buttons">
      <div style="text-align:center">
          <button class="choice" onclick="window.setMode('solo')">Solo</button>
          <p class="choice-desc">Your private laboratory—intentional, charged.</p>
      </div>
      <div style="text-align:center">
          <button class="choice" id="btnCoupleMode" onclick="window.setMode('couple')">Couple</button>
          <p class="choice-desc">Link devices and co-create a shared seduction.</p>
      </div>
      <div style="text-align:center">
          <button class="choice" onclick="window.setMode('stranger')">Stranger</button>
          <p class="choice-desc">Tempt fate with a random encounter.</p>
      </div>
    </div>
  </div>

  <div id="setup" class="screen hidden" style="max-width:800px; margin:0 auto; padding-bottom:50px;">
    
    <div class="section-title">Shape Your Story</div>
    <div class="fate-shortcut-row">
      <span class="fate-shortcut-text">or Let Fate Decide</span>
      <div class="fate-destiny-card" id="fateDestinyCard">
        <div class="fate-destiny-inner">
          <div class="fate-destiny-face fate-destiny-back">
            <span class="fate-destiny-title">Destiny's Choice</span>
          </div>
          <div class="fate-destiny-face fate-destiny-front">
            <div class="fate-golden-tree"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Player Character Block -->
    <div class="character-block">
        <div class="input-wrapper">
            <label>Your Character's Name</label>
            <input id="playerNameInput" type="text" placeholder="e.g. Elara Vance">
        </div>
        <div class="grid-2-col">
            <div>
                <label>Your Gender</label>
                <select id="playerGender" onchange="checkCustom(this, 'customPlayerGender')">
                    <option value="Female">Female</option>
                    <option value="Male">Male</option>
                    <option value="Non-Binary">Non-Binary</option>
                    <option value="Custom">Custom</option>
                </select>
                <input id="customPlayerGender" type="text" placeholder="Enter gender..." class="hidden" style="margin-top:5px;">
            </div>
            <div>
                <label>Pronouns</label>
                <select id="playerPronouns" onchange="checkCustom(this, 'customPlayerPronouns')">
                    <option value="She/Her">She/Her</option>
                    <option value="He/Him">He/Him</option>
                    <option value="They/Them">They/Them</option>
                    <option value="Custom">Custom</option>
                </select>
                <input id="customPlayerPronouns" type="text" placeholder="Enter pronouns..." class="hidden" style="margin-top:5px;">
            </div>
        </div>
    </div>

    <!-- Love Interest Block -->
    <div class="character-block" style="margin-top: 20px;">
        <div class="input-wrapper">
            <label>Your Love Interest's Name</label>
            <input id="partnerNameInput" type="text" placeholder="e.g. Lord Blackwood">
        </div>
        <div class="grid-2-col">
            <div>
                <label>Love Interest Gender</label>
                <select id="loveInterestGender" onchange="checkCustom(this, 'customLoveInterest')">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Non-Binary">Non-Binary</option>
                    <option value="Custom">Custom</option>
                </select>
                <input id="customLoveInterest" type="text" placeholder="Enter gender..." class="hidden" style="margin-top:5px;">
            </div>
            <div>
                <label>Pronouns</label>
                <select id="lovePronouns" onchange="checkCustom(this, 'customLovePronouns')">
                    <option value="He/Him">He/Him</option>
                    <option value="She/Her">She/Her</option>
                    <option value="They/Them">They/Them</option>
                    <option value="Custom">Custom</option>
                </select>
                <input id="customLovePronouns" type="text" placeholder="Enter pronouns..." class="hidden" style="margin-top:5px;">
            </div>
        </div>
    </div>

    <div class="section-title">Ancestry / Culture</div>
    <p class="ancestry-subtext">Optional: ground the characters in a cultural or ancestral context.</p>

    <div class="ancestry-container">
        <div class="ancestry-subsection">
            <div class="ancestry-label">Yours</div>
            <div class="fate-input-row">
                <div class="input-wrapper fate-input-wrapper">
                    <input id="ancestryInputPlayer" type="text" class="fate-field" data-fate-type="ancestry">
                    <div class="rotating-placeholder" data-for="ancestryInputPlayer"></div>
                </div>
                <div class="ancestry-flip-card" data-target="ancestryInputPlayer" data-type="ancestry">
                    <div class="ancestry-card-inner">
                        <div class="ancestry-card-back"></div>
                        <div class="ancestry-card-front"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ancestry-subsection">
            <div class="ancestry-label" id="ancestryLabelLI">Your Storybeau's</div>
            <div class="fate-input-row">
                <div class="input-wrapper fate-input-wrapper">
                    <input id="ancestryInputLI" type="text" class="fate-field" data-fate-type="ancestry">
                    <div class="rotating-placeholder" data-for="ancestryInputLI"></div>
                </div>
                <div class="ancestry-flip-card" data-target="ancestryInputLI" data-type="ancestry">
                    <div class="ancestry-card-inner">
                        <div class="ancestry-card-back"></div>
                        <div class="ancestry-card-front"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="section-title" id="archetypeSectionTitle">Shape Your Storybeau</div>
    <p class="archetype-header-text">Choose a core desire style for this character.</p>
    <p class="archetype-subtext">Select one Primary archetype. You may optionally add one Modifier to refine how it shows up.</p>

    <div class="sb-grid" id="archetypeCardGrid">
        <!-- Cards dynamically generated by JS -->
    </div>

    <!-- REMOVED: Modal overlay - cards now zoom in-place using CSS transforms -->

    <div class="archetype-selection-summary" id="archetypeSelectionSummary">
        <p class="selected-primary">Primary: <span id="selectedPrimaryName">None</span></p>
        <p class="selected-modifier">Modifier: <span id="selectedModifierName">None</span></p>
    </div>

    <div class="section-title">Intensity <span class="instruction-text">(Rendering Ceiling)</span></div>
    <div class="sb-grid" id="intensityGrid">
      <div class="sb-card" data-grp="intensity" data-val="Clean">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">Clean</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">Clean</span><span class="sb-card-desc">Romantic, non-explicit.</span></div>
        </div>
      </div>
      <div class="sb-card selected flipped" data-grp="intensity" data-val="Naughty">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">Naughty</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">Naughty</span><span class="sb-card-desc">Suggestive tension; no explicit anatomy.</span></div>
        </div>
      </div>
      <div class="sb-card locked" data-grp="intensity" data-val="Erotic" data-locked="tease">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">Erotic</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">Erotic</span><span class="sb-card-desc">Explicit sex; adult consensual.</span></div>
        </div>
      </div>
      <div class="sb-card locked" data-grp="intensity" data-val="Dirty" data-locked="pass">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">Dirty</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">Dirty</span><span class="sb-card-desc">Very explicit; highest intensity.</span></div>
        </div>
      </div>
    </div>

    <div id="lengthSection">
        <div class="section-title">Story Length</div>
        <p class="subtitle">Choose once. This shapes pacing and endings.</p>
        
        <div class="sb-grid" id="lengthGrid">
          <div class="sb-card selected flipped" data-grp="length" data-val="voyeur">
            <div class="sb-card-inner">
              <div class="sb-card-face sb-card-back"><span class="sb-card-title">Voyeur Tease</span></div>
              <div class="sb-card-face sb-card-front"><span class="sb-card-title">Voyeur Tease</span><span class="sb-card-desc">A front-row seat. No touching. Ends right when you lean in.</span></div>
            </div>
          </div>
          <div class="sb-card locked" data-grp="length" data-val="fling" data-locked="pass">
            <div class="sb-card-inner">
              <div class="sb-card-face sb-card-back"><span class="sb-card-title">Fling</span></div>
              <div class="sb-card-face sb-card-front"><span class="sb-card-title">Fling</span><span class="sb-card-desc">You get to get off, but you don't get to finish.</span></div>
            </div>
          </div>
          <div class="sb-card locked" data-grp="length" data-val="affair" data-locked="sub">
            <div class="sb-card-inner">
              <div class="sb-card-face sb-card-back"><span class="sb-card-title">Affair</span></div>
              <div class="sb-card-face sb-card-front"><span class="sb-card-title">Affair</span><span class="sb-card-desc">Longer nights, deeper consequences. Arcs unfold. Nothing is rushed.</span></div>
            </div>
          </div>
          <div class="sb-card locked" data-grp="length" data-val="soulmates" data-locked="sub">
            <div class="sb-card-inner">
              <div class="sb-card-face sb-card-back"><span class="sb-card-title">Soulmates</span></div>
              <div class="sb-card-face sb-card-front"><span class="sb-card-title">Soulmates</span><span class="sb-card-desc">This isn't about what happens next. It's about what keeps happening.</span></div>
            </div>
          </div>
        </div>
    </div>

    <!-- STORY POV (Repositioned: POV → Safety → World) -->
    <div class="section-title">Story POV</div>
    <div class="sb-grid" id="povGrid">
      <div class="sb-card selected flipped" data-grp="pov" data-val="First">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">1st Person (I)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">1st Person (I)</span><span class="sb-card-desc">Intimate, confessional, inside my own pulse.</span></div>
        </div>
      </div>
      <div class="sb-card" data-grp="pov" data-val="Second">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">2nd Person (You)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">2nd Person (You)</span><span class="sb-card-desc">Every glance, every silence, happening to you.</span></div>
        </div>
      </div>
      <div class="sb-card" data-grp="pov" data-val="Third">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">3rd Person (They)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">3rd Person (They)</span><span class="sb-card-desc">Close enough to feel, distant enough to see.</span></div>
        </div>
      </div>
      <div class="sb-card" data-grp="pov" data-val="Fourth">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">4th Person (We)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">4th Person (We)</span><span class="sb-card-desc">Witnesses to the inevitable.</span></div>
        </div>
      </div>
      <div class="sb-card" data-grp="pov" data-val="Fifth">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">5th Person (Author)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">5th Person (Author)</span><span class="sb-card-desc">"The Author has big plans for you…"</span></div>
        </div>
      </div>
    </div>

    <!-- SAFETY & BOUNDARIES (Repositioned: after POV, before World) -->
    <div class="section-title">Safety & Boundaries</div>
    <div class="sb-checkbox-group">
        <label class="sb-checkbox">
            <input type="checkbox" id="chkDark" checked>
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Dark Themes</span>
        </label>
        <label class="sb-checkbox">
            <input type="checkbox" id="chkNonCon">
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Implied Non-consent</span>
        </label>
        <label class="sb-checkbox">
            <input type="checkbox" id="chkViolence" checked>
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Violence / Peril</span>
        </label>
    </div>
    <div class="boundary-chips" id="boundaryChips">
        <div class="chip locked-chip active" title="Always enforced">No sexual violence</div>
        <div class="chip" data-boundary="coercion">No coercion</div>
        <div class="chip" data-boundary="degradation">No degradation language</div>
        <div class="chip" data-boundary="captivity">No captivity</div>
        <div class="chip" data-boundary="blackmail">No blackmail</div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         FOUR-AXIS STORY SELECTION SYSTEM (AUTHORITATIVE)
         Order: World → Tone → Genre → Dynamic
         ═══════════════════════════════════════════════════════════════════ -->

    <!-- FLOATING SYNOPSIS PANEL (Side-mounted book jacket card) -->
    <div id="synopsisPanel" class="synopsis-panel">
      <p id="synopsisText" class="synopsis-text">
        <span id="synWorld">Where shadows hold secrets</span>
        <span id="synTone">Face what you've buried</span>
        <span id="synGenre">Navigate dangerous alliances</span>
        <span id="synDynamic">The one you need most becomes your enemy</span>
      </p>
    </div>

    <!-- AXIS 1: STORY WORLD (Required, First) -->
    <div class="section-title">Story World <span class="instruction-text">(Required)</span></div>
    <div class="sb-grid" id="worldGrid">
      <div class="sb-card selected flipped" data-grp="world" data-val="Modern"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Modern</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Modern</span><span class="sb-card-desc">Present-day settings, familiar social norms.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="Historical"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Historical</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Historical</span><span class="sb-card-desc">A real past era with period constraints.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="Fantasy"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Fantasy</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Fantasy</span><span class="sb-card-desc">Magic, invented worlds, enchanted realms.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="SciFi"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Sci-Fi</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Sci-Fi</span><span class="sb-card-desc">Advanced technology, space, future societies.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="Dystopia"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Dystopia</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Dystopia</span><span class="sb-card-desc">Oppressive systems, controlled societies.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="PostApocalyptic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Post-Apocalyptic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Post-Apocalyptic</span><span class="sb-card-desc">Survival after collapse, scarce resources.</span></div></div></div>
    </div>

    <!-- Modern Subtype Sub-Selection (shown only when Modern selected) -->
    <div id="modernSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Modern Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="sb-grid" id="modernSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="small_town"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Small Town</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Small Town</span><span class="sb-card-desc">Close communities, local secrets, familiar faces.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="college"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">College</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">College</span><span class="sb-card-desc">Campus life, coming of age, academic settings.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="friends"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Friends</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Friends</span><span class="sb-card-desc">Friend groups, shared spaces, everyday drama.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="old_money"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Old Money</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Old Money</span><span class="sb-card-desc">Inherited wealth, elite circles, social expectations.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="office"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">9-5 / Office</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">9-5 / Office</span><span class="sb-card-desc">Workplace dynamics, corporate settings, professional life.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="supernatural_modern"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Supernatural Modern</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Supernatural Modern</span><span class="sb-card-desc">Vampires, shifters, witches in hidden worlds.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="superheroic_modern"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Superheroic Modern</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Superheroic Modern</span><span class="sb-card-desc">Powers, masks, secret identities, cosmic stakes.</span></div></div></div>
      </div>
    </div>

    <!-- Sci-Fi Subtype Sub-Selection (shown only when SciFi selected) -->
    <div id="scifiSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Sci-Fi Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="sb-grid" id="scifiSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="space_opera"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Star-Spanning Civilizations</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Star-Spanning Civilizations</span><span class="sb-card-desc">Galactic empires, starship voyages, interstellar politics.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="hard_scifi"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Future Built on Science</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Future Built on Science</span><span class="sb-card-desc">Scientific accuracy, plausible technology, realistic physics.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="cyberpunk"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Neon Futures</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Neon Futures</span><span class="sb-card-desc">Neon cities, corporate shadows, hackers and augmentation.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="post_human"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Post-Human</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Post-Human</span><span class="sb-card-desc">Transcendence, uploaded minds, evolved consciousness.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="alien_contact"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">First Contact</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">First Contact</span><span class="sb-card-desc">Alien encounters, xenobiology, interspecies discovery.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="abundance_collapse"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Abundance or Collapse</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Abundance or Collapse</span><span class="sb-card-desc">Post-scarcity utopia or civilizational decline.</span></div></div></div>
      </div>
    </div>

    <!-- Fantasy Subtype Sub-Selection (shown only when Fantasy selected) -->
    <div id="fantasySubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Fantasy Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="sb-grid" id="fantasySubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="enchanted_realms"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Enchanted Realms</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Enchanted Realms</span><span class="sb-card-desc">Epic quests, powerful magic, wondrous creatures.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="hidden_magic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Hidden Magic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Hidden Magic</span><span class="sb-card-desc">Subtle magic, grounded stakes, rare supernatural.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="cursed_corrupt"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Cursed & Corrupt Worlds</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Cursed & Corrupt Worlds</span><span class="sb-card-desc">Grim worlds, dangerous magic, moral corruption.</span></div></div></div>
      </div>
    </div>

    <!-- Horror Subtype Sub-Selection (shown when Horror tone selected with Fantasy/Supernatural) -->
    <div id="horrorSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Horror Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="sb-grid" id="horrorSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="cosmic_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Cosmic Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Cosmic Horror</span><span class="sb-card-desc">Unknowable entities, insignificance, existential dread.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="psychological_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Psychological</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Psychological</span><span class="sb-card-desc">Mind games, paranoia, internal terror.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="gothic_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Gothic Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Gothic Horror</span><span class="sb-card-desc">Decaying mansions, ancestral curses, romantic dread.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="body_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Body Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Body Horror</span><span class="sb-card-desc">Transformation, corruption of flesh, visceral dread.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="folk_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Folk Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Folk Horror</span><span class="sb-card-desc">Rural isolation, ancient rituals, community darkness.</span></div></div></div>
      </div>
    </div>

    <!-- Dystopia Subtype Sub-Selection (shown only when Dystopia selected) -->
    <div id="dystopiaSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Dystopia Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="sb-grid" id="dystopiaSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="authoritarian"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Authoritarian</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Authoritarian</span><span class="sb-card-desc">Totalitarian state, thought control, rebellion.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="surveillance"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Surveillance</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Surveillance</span><span class="sb-card-desc">Constant monitoring, no privacy, digital control.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="corporate"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Corporate</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Corporate</span><span class="sb-card-desc">Mega-corps rule, profit over people, wage slavery.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="environmental"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Environmental</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Environmental</span><span class="sb-card-desc">Ecological collapse, scarce resources, climate ruin.</span></div></div></div>
      </div>
    </div>

    <!-- Post-Apocalyptic Subtype Sub-Selection (shown only when PostApocalyptic selected) -->
    <div id="apocalypseSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Apocalypse Type <span class="instruction-text">(Optional)</span></div>
      <div class="sb-grid" id="apocalypseSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="nuclear"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Nuclear Aftermath</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Nuclear Aftermath</span><span class="sb-card-desc">Atomic devastation, radiation, scarred landscapes.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="pandemic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Pandemic Collapse</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Pandemic Collapse</span><span class="sb-card-desc">Plague survivors, immune vs infected, quarantine.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="climate"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Climate Ruin</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Climate Ruin</span><span class="sb-card-desc">Environmental collapse, extreme weather, survival.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="technological"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Technological Fallout</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Technological Fallout</span><span class="sb-card-desc">AI uprising, tech failure, machines vs humans.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="slow_decay"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Slow Civilizational Decay</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Slow Civilizational Decay</span><span class="sb-card-desc">Gradual decline, fading infrastructure, quiet endings.</span></div></div></div>
      </div>
    </div>

    <!-- AXIS 2: STORY TONE (Required, Second) -->
    <div class="section-title">Story Tone <span class="instruction-text">(Required)</span></div>
    <div class="sb-grid" id="toneGrid">
      <div class="sb-card selected flipped" data-grp="tone" data-val="Earnest"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Earnest</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Earnest</span><span class="sb-card-desc">Sincere emotion, unironic stakes.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="WryConfession"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Wry Confession</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Wry Confession</span><span class="sb-card-desc">Intimacy with irony, self-aware narrator.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Satirical"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Satirical</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Satirical</span><span class="sb-card-desc">Social critique, exaggeration, systems mocked.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Dark"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Dark</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Dark</span><span class="sb-card-desc">Morally complex, shadowed desire.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Horror</span><span class="sb-card-desc">Dread, the uncanny, fear as tension.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Mythic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Mythic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Mythic</span><span class="sb-card-desc">Archetypal weight, legendary scale.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Comedic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Comedic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Comedic</span><span class="sb-card-desc">Humor is primary, stakes are light.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Surreal"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Surreal</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Surreal</span><span class="sb-card-desc">Dreamlike, unstable, symbolic.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Poetic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Poetic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Poetic</span><span class="sb-card-desc">Lyrical prose, sensory immersion.</span></div></div></div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         AXIS 3: GENRE / FLAVOR (Required, Third)

         LOCKED DESIGN RULE:
         Genres must describe narrative action or fantasy, not setting or life stage.
         Settings like "Sports", "College", "Small Town" belong in World modifiers,
         not Genre. Genre implies what the characters DO, not where they ARE.
         ═══════════════════════════════════════════════════════════════════ -->
    <div class="section-title">Genre <span class="instruction-text">(Narrative flavor)</span></div>
    <div class="sb-grid" id="genreGrid">
      <div class="sb-card" data-grp="genre" data-val="CrimeSyndicate"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Crime Syndicate</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Crime Syndicate</span><span class="sb-card-desc">Organized crime, loyalty, blood oaths.</span></div></div></div>
      <div class="sb-card selected flipped" data-grp="genre" data-val="Billionaire"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Billionaire</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Billionaire</span><span class="sb-card-desc">Ultra-wealth, power plays, golden cages.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Noir"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Noir</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Noir</span><span class="sb-card-desc">Shadows, moral compromise, fatalism.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Heist"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Heist</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Heist</span><span class="sb-card-desc">Elaborate plans, trust and betrayal.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Espionage"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Espionage</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Espionage</span><span class="sb-card-desc">Spies, double lives, dangerous information.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Political"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Political Intrigue</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Political Intrigue</span><span class="sb-card-desc">Power structures, alliances, betrayal.</span></div></div></div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         AXIS 4: RELATIONSHIP DYNAMIC (Required, Last)

         LOCKED DESIGN RULE:
         Relationship Dynamics are single-select and represent emotional structure,
         not identity. They describe how characters relate, not who they are.
         Groupings are for cognitive organization only—selection remains flat.
         ═══════════════════════════════════════════════════════════════════ -->
    <div class="section-title">Relationship Dynamic <span class="instruction-text">(Required)</span></div>
    <div class="dynamic-grouped" id="dynamicGrid">
      <!-- Circumstance-Based -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Circumstance-Based</div>
        <div class="sb-grid">
          <div class="sb-card" data-grp="dynamic" data-val="Proximity"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Forced Proximity</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Forced Proximity</span><span class="sb-card-desc">Circumstance throws them together.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="SecretIdentity"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Secret Identity</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Secret Identity</span><span class="sb-card-desc">Hidden truths, masks, revelations.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Caretaker"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Caretaker / Wounded</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Caretaker / Wounded</span><span class="sb-card-desc">Vulnerability and steady presence.</span></div></div></div>
        </div>
      </div>
      <!-- Emotional Arc -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Emotional Arc</div>
        <div class="sb-grid">
          <div class="sb-card" data-grp="dynamic" data-val="Friends"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Friends to Lovers</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Friends to Lovers</span><span class="sb-card-desc">Safety tipping into something more.</span></div></div></div>
          <div class="sb-card selected flipped" data-grp="dynamic" data-val="Enemies"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Enemies to Lovers</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Enemies to Lovers</span><span class="sb-card-desc">Friction that becomes fire.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="SecondChance"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">2nd Chance</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">2nd Chance</span><span class="sb-card-desc">Past lovers, unfinished business.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Forbidden"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Forbidden Love</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Forbidden Love</span><span class="sb-card-desc">Rules, taboo, desire against judgment.</span></div></div></div>
        </div>
      </div>
      <!-- Intensity / Attachment -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Intensity / Attachment</div>
        <div class="sb-grid">
          <div class="sb-card" data-grp="dynamic" data-val="Dangerous"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Dangerous</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Dangerous</span><span class="sb-card-desc">Risk in proximity, threat as aphrodisiac.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Obsessive"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Obsessive Devotion</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Obsessive Devotion</span><span class="sb-card-desc">Consuming focus, intensity as love language.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Fated"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Fated</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Fated</span><span class="sb-card-desc">Destined bond, cosmic inevitability.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Partners"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Partners in Crime</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Partners in Crime</span><span class="sb-card-desc">Complicity, shared secrets, us vs them.</span></div></div></div>
        </div>
      </div>
    </div>

    <div class="section-title">Quill & Veto</div>

    <div class="quill-veto-container">
        <div class="qv-section">
            <label class="qv-label">Veto</label>
            <p class="qv-hint-above">Block elements you never want to appear. Vetoes are immediate and permanent.</p>
            <div id="vetoCommitted" class="committed-phrases"></div>
            <div class="fate-input-row">
                <div class="input-wrapper fate-input-wrapper fate-textarea-wrapper">
                    <textarea id="vetoInput" rows="2" class="fate-field" data-fate-type="veto"></textarea>
                    <div class="rotating-placeholder textarea-placeholder" data-for="vetoInput"></div>
                </div>
                <div class="destiny-flip-card" data-target="vetoInput" data-type="veto">
                    <div class="destiny-card-inner">
                        <div class="destiny-card-back"></div>
                        <div class="destiny-card-front"></div>
                    </div>
                </div>
            </div>
            <div class="qv-commit-row qv-commit-center">
                <span id="vetoStatus" style="font-size:0.85em; color:var(--pink);">Veto: Ready</span>
                <button id="btnCommitVeto" class="small-btn" style="padding:4px 10px; font-size:0.85em;">Commit Veto</button>
            </div>
            <p class="qv-hint-below">Vetoes remove content from consideration. They cannot start scenes or direct the story.</p>
        </div>

        <div class="qv-section">
            <label class="qv-label">Quill</label>
            <p class="qv-hint-above">Use the Quill to gently steer tone, boundaries, or direction without rewriting what's already happened.</p>
            <div id="quillCommitted" class="committed-phrases"></div>
            <div class="fate-input-row">
                <div id="quillBox" class="input-wrapper fate-input-wrapper fate-textarea-wrapper locked-input" onclick="window.showPaywall('unlock')">
                    <textarea id="quillInput" rows="2" class="fate-field" data-fate-type="quill"></textarea>
                    <div class="rotating-placeholder textarea-placeholder" data-for="quillInput"></div>
                </div>
                <div class="destiny-flip-card" data-target="quillInput" data-type="quill">
                    <div class="destiny-card-inner">
                        <div class="destiny-card-back"></div>
                        <div class="destiny-card-front"></div>
                    </div>
                </div>
            </div>
            <div class="qv-commit-row qv-commit-center">
                <span id="quillStatus">Quill: Poised</span>
                <button id="btnCommitQuill" class="small-btn" style="padding:4px 10px; font-size:0.85em; opacity:0.5;" disabled>Commit Quill</button>
            </div>
            <p class="qv-hint-below">Quill edits shape what follows and may persist. Each use exhausts the Quill, requiring time and words before it can be wielded again.</p>
        </div>
    </div>

    <div class="quill-veto-ui">
        <div id="godModeToggle" class="hidden">
            <label id="godModeLabel"><input type="checkbox" id="godModeCheck"> Enable God Mode (Sandbox)</label>
        </div>
    </div>

    <br>
    <button id="beginBtn" style="font-size:1.5em; margin-top:20px;">Begin Story</button>
  </div>

  <div id="game" class="screen hidden" style="max-width:900px; margin:0 auto; padding-bottom:60px;">

    <!-- ============================================================ -->
    <!-- BOOK COVER PAGE - Physical book object, clickable anywhere   -->
    <!-- ============================================================ -->
    <div id="bookCoverPage" class="book-cover-page">
      <div id="coverLoadingState" class="cover-loading">
        <div class="cover-progress-bar">
          <div id="coverProgressFill" class="cover-progress-fill"></div>
        </div>
        <p id="coverStatusText" class="cover-status-text">Building your book cover...</p>
      </div>

      <!-- Physical book object - no buttons, click anywhere to open -->
      <div id="bookObject" class="book-object hidden">
        <!-- Bookmark ribbon (visible for returning readers) -->
        <div id="bookmarkRibbon" class="bookmark-ribbon hidden"></div>

        <!-- Book cover with hinge -->
        <div id="bookCover" class="book-cover">
          <img id="bookCoverImg" src="" alt="Book Cover" class="book-cover-image">
        </div>

        <!-- Book pages underneath (visible during courtesy hinge) -->
        <div id="bookPagesPreview" class="book-pages-preview">
          <div class="page-edge-stack"></div>
        </div>

        <!-- Book spine/thickness -->
        <div class="book-spine"></div>
        <div class="book-thickness"></div>
      </div>
    </div>

    <!-- Page-turn animation overlay (deprecated - using hinge now) -->
    <div id="pageTurnOverlay" class="page-turn-overlay hidden">
      <div class="page-turn-left"></div>
      <div class="page-turn-right"></div>
    </div>

    <!-- Main story content (hidden during cover) -->
    <div id="storyContent" class="story-content hidden">

    <div id="billingBanner" style="display:none;"></div>

    <!-- CORRECTIVE: Story start - title double size, Scene under synopsis -->
    <h2 id="storyTitle" style="font-size:3em; text-align:center; margin-bottom:10px;"></h2>
    <p id="storySynopsis" style="color:var(--gold); font-style:italic; margin-bottom:10px; text-align:center;"></p>
    <div id="sceneNumber" style="font-size:2em; color:var(--gold); font-weight:bold; text-align:center; margin:0 0 20px;">Scene 1</div>
    
    <div id="batedBreathIndicator" class="hidden" style="text-align:center; font-size:0.8em; color:var(--gold); font-style:italic; margin-bottom:10px; opacity:0.8;">
        Waiting for partner...
        <button id="btnAbandonCouple" style="background:none; border:none; text-decoration:underline; color:var(--pink); cursor:pointer; padding:0; font-size:inherit; margin-left:5px;">Play Solo (Revoke Invite)</button>
    </div>

    <!-- TEXT-FIRST LAYOUT: Story text begins immediately after Scene 1 -->
    <div id="storyText" class="box">
        <div class="story-pages-container" id="storyPagesContainer"></div>
    </div>

    <!-- Setting shot appears as landscape element AFTER text (does not replace text) -->
    <div id="settingShotWrap">
        <div id="settingError" class="img-error-msg hidden"></div>
        <img id="settingShotImg" src="" alt="Setting" style="display:none; width:100%;">
    </div>

    <div class="page-nav-controls" id="pageNavControls">
        <button class="page-nav-btn" id="prevPageBtn" disabled>
            <span>←</span> Previous
        </button>
        <span class="page-indicator" id="pageIndicator">Page 1 of 1</span>
        <button class="page-nav-btn" id="nextPageBtn" disabled>
            Next <span>→</span>
        </button>
    </div>

    <div style="text-align:center; margin-bottom:10px;">
        <button id="vizSceneBtn" onclick="window.visualize()" style="font-size:0.9em; background:#444;">✨ Visualize This Scene</button>
    </div>
    
    <div id="metaControls" class="hidden" style="margin: 10px auto; padding: 10px; border: 1px dashed var(--gold); border-radius: 8px; max-width: 600px;">
      <div style="font-size: 0.8em; color: var(--gold); margin-bottom: 5px;">CHARACTERS REACT TO FATE (Meta System)</div>
      <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 5px;">
        <button class="small-btn meta-stance" onclick="window.setMetaStance('aid')">Aid Fate</button>
        <button class="small-btn meta-stance" onclick="window.setMetaStance('rebel')">Resist Fate</button>
        <button class="small-btn meta-stance" onclick="window.setMetaStance('seduce')">Tempt Fate</button>
      </div>
    </div>

    <div id="fateCardHeader" class="section-title" style="font-size:1.8em; margin-top:0; display:flex; justify-content:center;">Let Fate Guide You</div>

    <div style="display:flex; align-items:flex-start; gap:20px; justify-content:center;">
        <!-- CORRECTIVE: Restored "Your Chosen Fate:" text -->
        <div id="yourChoiceLabel" class="hidden" style="font-size:1.1em; color:var(--gold); font-style:italic; padding-top:20px; white-space:nowrap;">Your Chosen Fate:</div>
        <div id="cardMount" class="fate-grid"></div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
      <div class="input-wrapper" id="actionWrapper">
          <label>What do you do?</label>
          <textarea id="actionInput" rows="3" placeholder="Action..."></textarea>
      </div>
      <div class="input-wrapper" id="dialogueWrapper">
          <label>What do you say?</label>
          <textarea id="dialogueInput" rows="3" placeholder="Dialogue..."></textarea>
      </div>
    </div>

    <div class="intensity-mini" id="gameIntensity">
        <button onclick="window.setGameIntensity('Clean')">Clean</button>
        <button onclick="window.setGameIntensity('Naughty')" class="active">Naughty</button>
        <button onclick="window.setGameIntensity('Erotic')">Erotic</button>
        <button onclick="window.setGameIntensity('Dirty')">Dirty</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; align-items:center;">
       <button id="saveBtn" class="small-btn locked-style" onclick="window.showPaywall('unlock')">Save</button>
       <button id="submitBtn" style="font-size:1.3em;">Submit Turn</button>
    </div>
    
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
       <button id="gameControlsBtn" class="small-btn">Quill & Veto</button>
       <button id="edgeCovenantBtn" class="small-btn" onclick="window.openEdgeCovenantModal()">Edge Covenant</button>
    </div>

  </div>

    </div><!-- END storyContent -->

  <div id="toast" class="toast hidden">Boundaries redirected the scene.</div>

<div id="gameQuillVetoModal" class="overlay hidden" style="z-index:10004;">
  <div class="box" style="max-width:90vw; width:700px; text-align:left;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div class="qv-section">
            <label class="qv-label" style="display:block; margin-bottom:8px;">Veto</label>
            <p class="qv-hint-above" style="font-size:0.85em; opacity:0.8; margin-bottom:10px;">Block elements you never want to appear.</p>
            <!-- CORRECTIVE: Show committed veto entries in game modal -->
            <div id="gameVetoCommitted" class="committed-phrases" style="margin-bottom:10px;"></div>
            <div class="fate-input-row" style="margin-bottom:10px;">
                <div class="input-wrapper fate-input-wrapper" style="flex:1;">
                    <textarea id="gameVetoInput" rows="3" class="fate-field" data-fate-type="veto" placeholder=""></textarea>
                    <div class="rotating-placeholder" data-for="gameVetoInput"></div>
                </div>
            </div>
            <div class="veto-ui" style="display:flex; align-items:center; justify-content:flex-end;">
                <button id="btnGameCommitVeto" class="small-btn" style="padding:6px 12px; font-size:0.85em;">Commit Veto</button>
            </div>
        </div>

        <div class="qv-section">
            <label class="qv-label" style="display:block; margin-bottom:8px;">Quill</label>
            <p class="qv-hint-above" style="font-size:0.85em; opacity:0.8; margin-bottom:10px;">Steer tone, boundaries, or direction.</p>
            <div class="fate-input-row" style="margin-bottom:10px;">
                <div id="gameQuillBox" class="input-wrapper fate-input-wrapper" style="flex:1;">
                    <textarea id="gameQuillInput" rows="3" class="fate-field" data-fate-type="quill" placeholder=""></textarea>
                    <div class="rotating-placeholder" data-for="gameQuillInput"></div>
                </div>
            </div>
            <div class="quill-ui" style="display:flex; align-items:center; justify-content:space-between;">
                <span id="gameQuillStatus" style="font-size:0.9em;">Quill: Poised</span>
                <button id="btnGameCommitQuill" class="small-btn" style="padding:6px 12px; font-size:0.85em;">Commit Quill</button>
            </div>
        </div>
    </div>

    <div style="text-align:center; margin-top:20px;">
        <button onclick="document.getElementById('gameQuillVetoModal').classList.add('hidden')" style="background:#444;">Close</button>
    </div>
  </div>
</div>

<div id="edgeCovenantModal" class="overlay hidden" style="z-index:10005;">
  <div class="box" style="max-width:500px; text-align:center;">
    <h3 style="color:var(--pink)">The Covenant</h3>
    <p style="font-size:0.9em; opacity:0.9; line-height:1.5; margin-bottom:20px;">
      This option allows a more intense, commanding tone between characters—like dark-romance tension—while keeping clear boundaries. You can pause, soften, or stop at any time. Safewords are always honored instantly.
    </p>
    
    <div id="edgeActions">
        <button id="btnInviteEdge" onclick="window.inviteEdgeOffer()">Invite In-Story Offer</button>
        <div style="margin-top:10px; font-size:0.8em; opacity:0.6;">(If Solo/NPC play)</div>
        
        <div id="coupleEdgeControls" class="hidden" style="margin-top:20px; border-top:1px solid #444; padding-top:15px;">
            <p>Offer this dynamic to your partner?</p>
            <button onclick="window.sendEdgeOffer()">Send Offer</button>
        </div>
    </div>

    <div id="edgeAcceptance" class="hidden">
        <p style="font-style:italic; color:var(--gold); margin-bottom:20px;">
            "Accepting means your character consents to a more intense dynamic—stronger pressure, firmer guidance, and heightened tension—within your chosen intensity setting. You can stop or renegotiate at any time."
        </p>
        <button onclick="window.acceptEdgeCovenant()">I’m not afraid to enter your world.</button>
        <button onclick="window.closeEdgeModal()" style="background:#444; margin-top:10px;">Not like this.</button>
    </div>

    <button onclick="window.closeEdgeModal()" style="background:transparent; border:none; color:#aaa; margin-top:20px; font-size:0.8em; cursor:pointer;">Close</button>
  </div>
</div>

</div>

<script src="fatecards.js"></script>
<script src="orchestration-client.js"></script>
<script src="app.js"></script>
<div id="authModal" class="overlay hidden" style="z-index:5001;">
  <div class="box" style="max-width:400px;">
    <h3 id="authModalTitle">Log In</h3>
    <div id="authError" style="color:#e74c3c; margin-bottom:10px; display:none;"></div>
    <input type="email" id="authEmail" placeholder="Email" style="width:100%; margin-bottom:10px; padding:10px;">
    <input type="password" id="authPassword" placeholder="Password" style="width:100%; margin-bottom:15px; padding:10px;">
    <button id="authSubmitBtn" onclick="window.handleAuthSubmit()">Log In</button>
    <p style="margin-top:15px; font-size:0.9em;">
      <span id="authToggleText">Don't have an account?</span>
      <a href="#" id="authToggleLink" onclick="window.toggleAuthMode(); return false;">Sign up</a>
    </p>
    <button onclick="window.closeAuthModal()" style="background:#444; margin-top:10px;">Cancel</button>
  </div>
</div>

<div id="profileModal" class="overlay hidden" style="z-index:5001;">
  <div class="box" style="max-width:450px;">
    <h3>Author Profile</h3>
    <label class="setting-label">Pen Name</label>
    <input type="text" id="profilePenName" placeholder="Your pen name" style="width:100%; margin-bottom:15px; padding:10px;">
    <label style="display:flex; align-items:center; gap:10px; margin-bottom:20px; cursor:pointer;">
      <input type="checkbox" id="profileAttribution" style="width:20px; height:20px;">
      <span>Show my name on public stories</span>
    </label>
    <button onclick="window.saveProfile()">Save</button>
    <button onclick="window.closeProfileModal()" style="background:#444; margin-top:10px;">Cancel</button>
  </div>
</div>

<div id="myLibraryModal" class="overlay hidden" style="z-index:5000;">
  <div class="box" style="max-width:600px; max-height:80vh; overflow-y:auto;">
    <h3>My Library</h3>
    <div id="myLibraryContent"></div>
    <button onclick="window.closeMyLibraryModal()" style="background:#444; margin-top:15px;">Close</button>
  </div>
</div>
</body>
</html>

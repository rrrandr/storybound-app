<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storybound</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://use.typekit.net/bzl3zth.css">

  <style>
    /* GLOBAL VARS */
    :root{ 
        --bg1:#0a001f; --bg2:#2a0033; --pink:#ff69b4; --hot:#ff1493; --gold:#ffd700; --ink:#f0e6ff; --panel:rgba(20,0,40,.6); 
        --p1-color: #f0e6ff; --p2-color: #f0e6ff; /* Dynamic Dialogue Colors */
    }
    
    /* THEMES */
    body.theme-sepia { --bg1:#2c2218; --bg2:#3e2f22; --pink:#d2b48c; --hot:#8b4513; --gold:#ffa500; --ink:#f5deb3; --panel:rgba(40,30,20,0.8); }
    body.theme-midnight { --bg1:#000000; --bg2:#111111; --pink:#444; --hot:#666; --gold:#888; --ink:#ccc; --panel:rgba(20,20,20,0.9); }

    html, body { margin:0; padding:0; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--ink); font-family:'Lora',serif; overflow-x:hidden; min-height:100vh; }
    body { text-align:center; padding:10px; }
    
    /* TYPOGRAPHY */
    h1, h2, .section-title { font-family:'lust-script-display','lust-script',serif; color:var(--pink); text-shadow:0 0 15px var(--hot); font-weight:400; }
    .section-title { font-size:2.2em; margin:35px 0 15px; border-top:1px solid rgba(255,105,180,0.2); padding-top:20px; }
    
    /* DIALOGUE STYLING */
    .dialogue { font-size: 1.15em; font-style: italic; display: block; margin: 12px 0; padding-left: 15px; border-left: 2px solid var(--pink); }
    .dialogue.p1 { color: var(--p1-color); text-shadow: 0 0 5px rgba(255,255,255,0.1); }
    .dialogue.p2 { color: var(--p2-color); text-shadow: 0 0 5px rgba(255,255,255,0.1); }

    /* BUTTONS */
    button { background:linear-gradient(145deg,#8b008b,var(--hot)); color:var(--gold); padding:10px 30px; border:none; border-radius:25px; font-size:1em; cursor:pointer; box-shadow:0 0 18px rgba(255,20,147,.6); transition:.3s; font-family:'Lora',serif; position:relative; }
    button:hover { transform:scale(1.05); box-shadow:0 0 30px rgba(255,105,180,.9); }
    button:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
    .small-btn { font-size: 0.9em; padding: 8px 16px; background: #444; box-shadow:none; }

    /* UTILS */
    .box { max-width:600px; margin:20px auto; padding:25px; background:var(--panel); border:1px solid var(--pink); border-radius:15px; box-shadow:0 0 20px rgba(255,105,180,.4); }
    .choice-buttons { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin:30px auto; max-width:800px; }
    .choice { padding:15px 40px; font-size:1.4em; border-radius:30px; font-family:'lust-script-display',serif; }
    .hidden { display:none !important; }
    
    /* INPUTS & LOCKS */
    .input-wrapper { position: relative; width: 95%; margin: 0 auto 15px; }
    .input-wrapper label { display:block; text-align:left; color:var(--gold); margin-bottom:5px; font-size:0.9em; font-family:'Lora',serif; }
    textarea, input, select { width:100%; padding:12px; background:rgba(30,0,50,.9); color:var(--ink); border:1px solid var(--pink); border-radius:8px; font-size:1em; font-family:'Lora',serif; box-sizing:border-box; }
    
    /* LOCKS */
    .locked-input textarea, .locked-style { opacity:0.5; filter:grayscale(0.8); cursor:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' style='fill:gold'><text y='20' font-size='20'>ðŸ’¸</text></svg>"), pointer !important; pointer-events:none; }
    .locked-input::after, .locked-style::after { content:""; position:absolute; top:10px; right:10px; width:24px; height:24px; background:url("https://img.icons8.com/ios-filled/50/ffffff/handcuffs.png") center/contain no-repeat; opacity:0.9; pointer-events:none; }
    .locked-input::after { top: 42px; right: 15px; } /* Adjust for textarea label */

    /* FATE CARDS */
    .fate-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin:20px auto; max-width:500px; perspective:1000px; }
    .fate-card { width:100%; aspect-ratio:2/3; position:relative; cursor:pointer; background:none; border:none; padding:0; transform-style:preserve-3d; transition:transform 0.6s; }
    .fate-card .inner { position:absolute; inset:0; border-radius:8px; transform-style:preserve-3d; transition:transform 0.6s; box-shadow:0 5px 15px rgba(0,0,0,0.5); }
    .fate-card.flipped .inner { transform:rotateY(180deg); }
    .fate-card .front, .fate-card .back { position:absolute; inset:0; backface-visibility:hidden; border-radius:8px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,215,0,0.3); }
    .fate-card .front { background:#111; z-index:2; } 
    .fate-card .back { background:#2a0033; transform:rotateY(180deg); z-index:1; }
    .fate-card.poof { animation: smokePoof 0.6s forwards; }
    @keyframes smokePoof { 0%{ opacity:1; transform:scale(1); } 100%{ opacity:0; transform:scale(0.5); } }

    /* INTENSITY MINI */
    .intensity-mini { display:flex; gap:5px; justify-content:center; margin: 15px 0; }
    .intensity-mini button { padding: 5px 15px; font-size: 0.8em; opacity: 0.6; }
    .intensity-mini button.active { opacity: 1; border: 1px solid var(--gold); }

    /* LOADING OVERLAY */
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 200; flex-direction: column;}
    #loadingOverlayInner { background: rgba(10, 0, 30, 0.95); padding: 20px; border-radius: 14px; text-align: center; border: 1px solid var(--pink); }
    #loadingOverlayBar { width: 200px; height: 4px; background: #333; border-radius: 999px; overflow: hidden; margin-top: 15px; }
    #loadingOverlayFill { width: 0%; height: 100%; background: var(--pink); transition: width 0.3s; }

    /* BURGER */
    #burgerBtn { position:fixed; top:15px; right:15px; z-index:5000; font-size:1.8em; background:none; border:none; color:var(--pink); padding:0; cursor:pointer; text-shadow: 0 0 5px var(--hot); box-shadow:none; }
    #burgerBtn:hover { transform: scale(1.1); box-shadow:none; }

    /* VISUALIZE MODAL */
    .viz-modal-content { text-align: center; max-width: 600px; width: 90%; }
    .viz-controls { display:flex; gap:10px; justify-content:center; margin-top:15px; flex-wrap:wrap; }
    #vizPreviewImg { width: 100%; border-radius: 8px; margin-top: 10px; max-height: 400px; object-fit: contain; background:#000; }

    /* STYLE CARDS */
    .style-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin:15px 0; }
    .card { background:#252525; border-radius:12px; padding:15px; cursor:pointer; text-align:left; border:2px solid transparent; position:relative; transition:.2s; }
    .card:hover { transform:translateY(-3px); border-color:#ff6b6b; }
    .card.selected { border-color:#ff69b4; background:#333; box-shadow:0 0 15px rgba(255,105,180,0.3); }
    .preview-btn { margin-top:10px; font-size:0.75em; padding:4px 10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none; z-index:5; position:relative; }
  </style>
</head>

<body>

<button id="burgerBtn">â˜°</button>
<div id="menuOverlay" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:4999; align-items:center; justify-content:center; display:flex;">
  <div class="box">
    <h3>Menu</h3>
    <button onclick="restart()">Restart Story</button>
    <button onclick="changeTier()">Change Tier</button>
    <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
    <p style="font-size:0.9em; color:var(--gold)">Theme</p>
    <div style="display:flex; gap:5px; justify-content:center;">
        <button class="small-btn" onclick="setTheme('default')">Default</button>
        <button class="small-btn" onclick="setTheme('sepia')">Sepia</button>
        <button class="small-btn" onclick="setTheme('midnight')">Midnight</button>
    </div>
    <br>
    <button onclick="document.getElementById('menuOverlay').classList.add('hidden')" style="background:#444">Close</button>
  </div>
</div>

<div id="loadingOverlay">
  <div id="loadingOverlayInner">
    <div id="loadingText" style="font-style:italic; color:var(--gold);">Stoking the embers...</div>
    <div id="loadingOverlayBar"><div id="loadingOverlayFill"></div></div>
  </div>
</div>

<div id="vizModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center; display:flex;">
  <div class="box viz-modal-content">
    <h3>Visualization</h3>
    <img id="vizPreviewImg" src="" alt="Generating...">
    <div class="viz-controls">
        <select id="vizModel" style="width:auto; padding:5px;">
            <option value="grok-2-image-1212">Grok 2</option>
            <option value="dall-e-3">DALL-E 3</option>
            <option value="midjourney">Midjourney (Mock)</option>
        </select>
        <button class="small-btn" onclick="visualize(true)">Re-Visualize</button>
        <button onclick="insertImage()">Insert</button>
        <button class="small-btn" style="background:#555" onclick="document.getElementById('vizModal').classList.add('hidden')">Cancel</button>
    </div>
  </div>
</div>

<div id="payModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center; display:flex;">
  <div class="box" style="text-align:center">
    <h3>Unshackle Your Fate</h3>
    <p style="margin-bottom:20px; font-style:italic; color:#ffd700">"Why stop when it's just getting good?"</p>
    <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap;">
        <div id="optUnlock" class="hidden" style="background:#222; padding:15px; border-radius:10px; border:1px solid #ff69b4; width:200px;">
            <h4>Unlock This Story</h4>
            <p>Inputs, saves, and styles for <strong>this session</strong>.</p>
            <button id="payOneTime" style="width:100%">Unlock ($1)</button>
        </div>
        <div id="optSub" style="background:#400020; padding:15px; border-radius:10px; border:1px solid gold; width:200px;">
            <h4>Indulge Forever</h4>
            <p>Unlimited access to all styles.</p>
            <button id="paySub" style="width:100%">Subscribe ($6/mo)</button>
        </div>
    </div>
    <br>
    <button onclick="document.getElementById('payModal').classList.add('hidden')" style="background:#444">Cancel</button>
  </div>
</div>

<div id="app">

  <div id="modeSelect">
    <h1 style="margin-top:40px">Storybound</h1>
    <p style="color:var(--gold); font-style:italic; margin-bottom:40px;">Will you enter a world of danger and decadence alone, or with a liaison?</p>
    <div class="choice-buttons">
      <button class="choice" onclick="setMode('solo')">Solo</button>
      <button class="choice" onclick="setMode('couple')">Couple</button>
      <button class="choice" onclick="alert('Coming soon.')">Stranger</button>
    </div>
  </div>

  <div id="setup" class="hidden" style="max-width:800px; margin:0 auto; padding-bottom:50px;">
    
    <div class="section-title">Gender & Preference</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; width:95%; margin:0 auto;">
        <div>
            <label>Your Gender</label>
            <select id="playerGender">
                <option value="Female">Female</option>
                <option value="Male">Male</option>
                <option value="Non-Binary">Non-Binary</option>
            </select>
        </div>
        <div>
            <label>Love Interest</label>
            <select id="loveInterestGender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Non-Binary">Non-Binary</option>
            </select>
        </div>
    </div>

    <div class="section-title">Intensity</div>
    <div id="intensityBtns">
      <button data-val="Clean" class="intensity-btn">Clean</button>
      <button data-val="Naughty" class="intensity-btn active">Naughty</button>
      <button data-val="Erotic" class="intensity-btn">Erotic</button>
      <button data-val="Dirty" class="intensity-btn">Dirty</button>
    </div>

    <div class="section-title">Genres <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="genreGrid">
      <div class="card" data-grp="genre" data-val="Romantasy"><h3>Romantasy</h3><p>Magic and desire.</p></div>
      <div class="card" data-grp="genre" data-val="Contemporary"><h3>Contemporary</h3><p>Modern settings.</p></div>
      <div class="card" data-grp="genre" data-val="Historical"><h3>Historical</h3><p>Period romance.</p></div>
      <div class="card" data-grp="genre" data-val="Paranormal"><h3>Paranormal</h3><p>Vampires/Shifters.</p></div>
      <div class="card" data-grp="genre" data-val="Dark"><h3>Dark Romance</h3><p>Morally gray.</p></div>
      <div class="card" data-grp="genre" data-val="Suspense"><h3>Suspense</h3><p>Danger & mystery.</p></div>
    </div>
    
    <div class="section-title">Dynamics <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="dynamicGrid">
      <div class="card" data-grp="dynamic" data-val="Enemies"><h3>Enemies to Lovers</h3><p>Rivals to heat.</p></div>
      <div class="card" data-grp="dynamic" data-val="Forbidden"><h3>Forbidden Love</h3><p>Taboo desires.</p></div>
      <div class="card" data-grp="dynamic" data-val="Power"><h3>Power Imbalance</h3><p>Status gaps.</p></div>
      <div class="card" data-grp="dynamic" data-val="SlowBurn"><h3>Slow Burn</h3><p>High restraint.</p></div>
    </div>

    <div class="section-title">Story Style <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="styleGrid">
      <div class="card selected" data-grp="style" data-val="Breathless">
         <h3>Breathless</h3><p>Fast tension.</p><button class="preview-btn" data-txt="His attention was a slow hand...">Preview</button>
      </div>
      <div class="card" data-grp="style" data-val="Epic" data-locked="true">
         <h3>Epic</h3><p>Grand stakes.</p><button class="preview-btn" data-txt="The city burned like a crown...">Preview</button>
      </div>
      <div class="card" data-grp="style" data-val="Playful" data-locked="true">
         <h3>Playful</h3><p>Flirty banter.</p><button class="preview-btn" data-txt="You're staring. I'm appreciating.">Preview</button>
      </div>
      <div class="card" data-grp="style" data-val="Dark" data-locked="true">
         <h3>Dark</h3><p>Moody tension.</p><button class="preview-btn" data-txt="He smiled like a promise with teeth.">Preview</button>
      </div>
    </div>

    <br>
    <button id="beginBtn" style="font-size:1.5em; margin-top:20px;">Begin Story</button>
  </div>

  <div id="game" class="hidden" style="max-width:900px; margin:0 auto; padding-bottom:60px;">
    <h2 id="storyTitle"></h2>
    <p id="storySynopsis" style="color:var(--gold); font-style:italic; margin-bottom:20px;"></p>
    
    <div id="storyText" class="box" style="text-align:left; max-width:100%; min-height:300px; margin-bottom:20px;"></div>

    <div style="text-align:center; margin-bottom:10px;">
        <button onclick="visualize()" style="font-size:0.9em; background:#444;">âœ¨ Visualize This Scene</button>
    </div>

    <div class="section-title" style="font-size:1.8em; margin-top:0;">Guide Your Fate</div>
    
    <div id="cardMount" class="fate-grid">
      </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
      <div class="input-wrapper locked-input" id="actionWrapper" onclick="showPaywall('unlock')">
          <label>What do you do?</label>
          <textarea id="actionInput" rows="3" placeholder="Action..." disabled></textarea>
      </div>
      <div class="input-wrapper locked-input" id="dialogueWrapper" onclick="showPaywall('unlock')">
          <label>What do you say?</label>
          <textarea id="dialogueInput" rows="3" placeholder="Dialogue..." disabled></textarea>
      </div>
    </div>

    <div class="intensity-mini" id="gameIntensity">
        <button onclick="setGameIntensity('Clean')">Clean</button>
        <button onclick="setGameIntensity('Naughty')" class="active">Naughty</button>
        <button onclick="setGameIntensity('Erotic')">Erotic</button>
        <button onclick="setGameIntensity('Dirty')">Dirty</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; align-items:center;">
       <button id="saveBtn" class="small-btn locked-style" onclick="showPaywall('unlock')">Save</button>
       <button id="submitBtn" style="font-size:1.3em;">Submit Turn</button>
    </div>
    
    <div style="margin-top:10px;">
       <button id="gameControlsBtn" class="small-btn locked-style" onclick="showPaywall('unlock')">Story Controls</button>
    </div>

  </div>

</div>

<div id="previewModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:5000; align-items:center; justify-content:center; display:flex;">
  <div class="box">
    <p id="previewText" style="font-size:1.3em; font-style:italic; line-height:1.6"></p>
    <button onclick="document.getElementById('previewModal').classList.add('hidden')">Close</button>
  </div>
</div>

<script>
(function(){
  // --- CONFIG ---
  var PROXY_URL = 'https://storybound-proxy.vercel.app/api/proxy';
  var IMAGE_PROXY_URL = 'https://storybound-proxy.vercel.app/api/image';
  const STORY_MODEL = 'grok-4-1-fast-reasoning'; // or grok-beta

  var state = { tier:'free', picks:{ genre:[], dynamic:[], pov:'First', style:['Breathless'] }, gender:'Female', loveInterest:'Male', intensity:'Naughty' };
  var tempImgUrl = null;

  // --- HELPERS ---
  function $(id){ return document.getElementById(id); }
  function hideAll(){ ['modeSelect','setup','game'].forEach(x => $(x).classList.add('hidden')); }
  
  // --- COLORS FOR DIALOGUE ---
  function getGenderColor(g){
      if(g === 'Male') return '#B0E0E6'; // Powder Blue
      if(g === 'Female') return '#FFB6C1'; // Powder Pink
      return '#77DD77'; // Pastel Green (Other)
  }

  // --- API CALL ---
  async function callChat(messages){
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ model: STORY_MODEL, messages })
    });
    const data = await res.json();
    return data.choices?.[0]?.message?.content || '';
  }

  // --- LOADING ---
  const loadingPhrases = ["Stoking the embers...", "Consulting your desires...", "Sharpening tension...", "Weaving fate..."];
  let loadInt;
  function startLoading(){
    $('loadingOverlay').style.display = 'flex';
    let i=0;
    $('loadingText').innerText = loadingPhrases[0];
    $('loadingOverlayFill').style.width = '10%';
    loadInt = setInterval(() => {
        i++;
        $('loadingText').innerText = loadingPhrases[i % loadingPhrases.length];
        $('loadingOverlayFill').style.width = Math.min(90, i*20) + '%';
    }, 1000);
  }
  function stopLoading(){
    clearInterval(loadInt);
    $('loadingOverlayFill').style.width = '100%';
    setTimeout(() => { $('loadingOverlay').style.display = 'none'; $('loadingOverlayFill').style.width='0%'; }, 300);
  }

  // --- FATE CARDS ---
  function initCards(){
      const m = $('cardMount');
      m.innerHTML = '';
      const labels = ["FATE", "FATE", "FATE", "FATE", "FATE"];
      const backs = ["ðŸ·", "ðŸ”¥", "âš”ï¸", "ðŸ‘‘", "ðŸ•Šï¸"];
      labels.forEach((l, i) => {
          const btn = document.createElement('button');
          btn.className = 'fate-card';
          btn.innerHTML = `<div class="inner"><div class="front"><h3>${l}</h3></div><div class="back"><div style="font-size:30px">${backs[i]}</div></div></div>`;
          btn.onclick = () => {
              btn.classList.toggle('flipped');
              if(btn.classList.contains('flipped')){
                  $('actionInput').value = "I take a calculated risk."; // Mock fill
              }
          };
          m.appendChild(btn);
      });
  }

  // --- FORMATTING ---
  function formatStory(text){
      let p1Color = getGenderColor(state.gender);
      let p2Color = getGenderColor(state.loveInterest);
      
      // Set CSS Vars
      document.documentElement.style.setProperty('--p1-color', p1Color);
      document.documentElement.style.setProperty('--p2-color', p2Color);

      // Detect Dialogue
      let html = text.replace(/\n/g, '<br><br>');
      
      // Heuristic: If "I" say it -> P1. If "He/She" says it -> P2.
      // This is rudimentary but works for visual demo.
      html = html.replace(/"([^"]+)"/g, (match, content) => {
          // Check context (simple check)
          let isP1 = state.pov === 'First' || content.toLowerCase().includes(" i ");
          let cls = isP1 ? 'p1' : 'p2';
          return `<span class="dialogue ${cls}">"${content}"</span>`;
      });
      
      // Remove AI artifacts like "Player Action:"
      html = html.replace(/Player Action:|What do you do\?/gi, "");
      
      return html;
  }

  // --- MAIN ACTIONS ---
  window.setMode = function(m){
      if(m === 'solo') { hideAll(); $('setup').classList.remove('hidden'); }
      // ... couple/stranger logic omitted for brevity in this paste
  };

  window.setTheme = function(t){
      document.body.className = 'theme-' + t;
  };

  $('beginBtn').onclick = async function(){
      state.gender = $('playerGender').value;
      state.loveInterest = $('loveInterestGender').value;
      
      startLoading();
      hideAll();
      $('game').classList.remove('hidden');
      initCards();

      const sys = `You are a master storyteller. 
      Genre: ${state.picks.genre.join(',')}. 
      Style: ${state.picks.style.join(',')}.
      POV: ${state.picks.pov}.
      Player is ${state.gender}. Love Interest is ${state.loveInterest}.
      Intensity: ${state.intensity}.
      Output format: Title: <title>\nSynopsis: <synopsis>\n<story body>`;
      
      try {
          const raw = await callChat([{role:'system', content: sys}, {role:'user', content: "Begin."}]);
          
          let title="Storybound", syn="A tale of desire...", body=raw;
          const lines = raw.split('\n');
          // Basic Parse
          lines.forEach(l => {
              if(l.startsWith("Title:")) title = l.replace("Title:","").trim();
              else if(l.startsWith("Synopsis:")) syn = l.replace("Synopsis:","").trim();
          });
          // Remove metadata from body
          body = body.replace(/Title:.*\n/,'').replace(/Synopsis:.*\n/,'');

          $('storyTitle').textContent = title;
          $('storySynopsis').textContent = syn;
          $('storyText').innerHTML = formatStory(body);
      } catch(e) {
          $('storyText').innerHTML = "<p>Backend failed. Fallback loaded.</p>";
      }
      stopLoading();
  };

  $('submitBtn').onclick = async function(){
      startLoading();
      
      // 1. Fleur de Lis
      $('storyText').innerHTML += `<div class="separator">âšœ</div>`;
      
      const act = $('actionInput').value;
      $('actionInput').value = ''; 
      
      try {
          const sys = `Continue the story. Player (${state.gender}) does: ${act}. Love Interest is ${state.loveInterest}. Do NOT repeat "Player Action:". Write the scene directly.`;
          const raw = await callChat([{role:'system', content:sys}, {role:'user', content: "Next scene."}]);
          $('storyText').innerHTML += formatStory(raw);
          $('storyText').lastElementChild.scrollIntoView({behavior:'smooth'});
      } catch(e){
          console.log(e);
      }
      
      // Flip cards back?
      document.querySelectorAll('.fate-card').forEach(c => c.classList.remove('flipped'));
      stopLoading();
  };

  window.visualize = async function(isRe){
      startLoading();
      // Generate prompt from last paragraph
      const lastText = $('storyText').textContent.slice(-500);
      
      try {
          // 1. Get Prompt
          const promptMsg = await callChat([{role:'user', content:`Describe this scene for an image generator (no nudity, cinematic): ${lastText}`}]);
          
          // 2. Call Image API
          const res = await fetch(IMAGE_PROXY_URL, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ prompt: promptMsg })
          });
          const data = await res.json();
          tempImgUrl = data.url || 'https://via.placeholder.com/600x400?text=Mock+Image';
          
          $('vizPreviewImg').src = tempImgUrl;
          $('vizModal').classList.remove('hidden');
      } catch(e){
          alert("Viz failed: " + e.message);
      }
      stopLoading();
  };

  window.insertImage = function(){
      if(tempImgUrl){
          $('storyText').innerHTML += `<img src="${tempImgUrl}" class="story-image">`;
          $('vizModal').classList.add('hidden');
      }
  };

  // --- SELECTION LOGIC ---
  document.addEventListener('click', e => {
      const card = e.target.closest('.card');
      if(!card) return;
      if(e.target.classList.contains('preview-btn')){
          e.stopPropagation();
          $('previewText').innerText = e.target.getAttribute('data-txt');
          $('previewModal').classList.remove('hidden');
          return;
      }
      // Toggle logic...
      const grp = card.getAttribute('data-grp');
      const val = card.getAttribute('data-val');
      
      // Multi-select logic for Genre/Dynamic/Style
      if(['genre','dynamic','style'].includes(grp)){
          if(!state.picks[grp]) state.picks[grp] = [];
          if(state.picks[grp].includes(val)){
              state.picks[grp] = state.picks[grp].filter(x=>x!==val);
              card.classList.remove('selected');
          } else {
              if(state.picks[grp].length >= 3) return alert("Max 3 allowed.");
              state.picks[grp].push(val);
              card.classList.add('selected');
          }
      } else {
          // Single select (POV)
          document.querySelectorAll(`[data-grp="${grp}"]`).forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected');
          state.picks[grp] = val;
      }
  });

  // --- INIT ---
  // Apply locks, wire up Intensity buttons...
  document.querySelectorAll('.intensity-btn').forEach(b => {
      b.onclick = function(){
          document.querySelectorAll('.intensity-btn').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          state.intensity = b.getAttribute('data-val');
      }
  });

})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storybound</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@300;400&family=Playfair+Display:wght@400;700&family=Open+Sans:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@400;700&family=Allura&family=Glass+Antiqua&family=Eagle+Lake&family=Smooch+Sans:wght@300;500&family=Pinyon+Script&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://use.typekit.net/bzl3zth.css">

  <link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="auth-panel" class="hidden">
  <input id="auth-email" placeholder="Email" />
  <input id="auth-password" type="password" placeholder="Password" />
  <button id="btn-signin">Sign in</button>
  <div id="auth-status"></div>
</div>

<button id="burgerBtn">☰</button>
<button id="globalBackBtn" class="hidden" style="position:fixed; top:15px; left:15px; z-index:5000; background:none; border:none; font-size:1.5em; cursor:pointer;">←</button>

<!-- BURGER MENU — TOP LEVEL -->
<div id="menuOverlay" class="overlay hidden" style="z-index:4999;">
  <div class="box">
    <h3>Menu</h3>

    <!-- Story/Session Controls -->
    <div class="menu-section">
      <button onclick="window.restart()">Restart Story</button>
      <button id="continueStoryBtn" class="hidden" onclick="window.continueStory()">Continue Saved Story</button>
    </div>

    <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">

    <!-- Account-Level Navigation -->
    <div class="menu-section">
      <button onclick="window.changeTier()">Change Tier</button>
    </div>

    <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">

    <!-- The Forbidden Library -->
    <div class="menu-section">
      <button onclick="document.getElementById('menuOverlay').classList.add('hidden'); window.openForbiddenLibrary();">The Forbidden Library</button>
    </div>

    <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">

    <!-- Reading Settings Entry Point -->
    <div class="menu-section">
      <button onclick="document.getElementById('menuOverlay').classList.add('hidden'); document.getElementById('readingSettingsOverlay').classList.remove('hidden');">Reading Settings</button>
    </div>

    <br>
    <button onclick="document.getElementById('menuOverlay').classList.add('hidden')" style="background:#444">Close</button>
  </div>
</div>

<!-- READING SETTINGS SUBMENU -->
<div id="readingSettingsOverlay" class="overlay hidden" style="z-index:5000;">
  <div class="box">
    <h3>Reading Settings</h3>

    <label class="setting-label">Theme</label>
    <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap; margin-bottom:15px;">
        <button class="small-btn" onclick="setTheme('default')">Default</button>
        <button class="small-btn" onclick="setTheme('sepia')">Sepia</button>
        <button class="small-btn" onclick="setTheme('midnight')">Midnight</button>
        <button class="small-btn" onclick="setTheme('print')">Print</button>
        <button class="small-btn" onclick="setTheme('easy')">Easy</button>
    </div>

    <label class="setting-label">Font</label>
    <select id="fontSelect" onchange="setFont(this.value)" style="margin-bottom:15px; width:100%;">
        <option value="'Lora', serif">Lora (Default)</option>
        <option value="'Grenze Gotisch', cursive">Grenze Gotisch</option>
        <option value="'Allura', cursive">Allura</option>
        <option value="'Glass Antiqua', cursive">Glass Antiqua</option>
        <option value="'Eagle Lake', cursive">Eagle Lake</option>
        <option value="'Smooch Sans', sans-serif">Smooch Sans</option>
        <option value="'Pinyon Script', cursive">Pinyon Script</option>
        <option value="'Merriweather', serif">Merriweather</option>
        <option value="'Roboto', sans-serif">Roboto</option>
    </select>

    <label class="setting-label">Font Size</label>
    <input type="range" min="16" max="72" value="18" oninput="setFontSize(this.value)">

    <br><br>
    <button onclick="document.getElementById('readingSettingsOverlay').classList.add('hidden')" style="background:#444">Back</button>
  </div>
</div>

<div id="loadingOverlay" class="overlay hidden" style="z-index:9000;">
  <div id="loadingOverlayInner">
    <button id="loadingCancelBtn" class="loading-cancel-btn" title="Cancel">&times;</button>
    <div id="loadingText">Stoking the embers...</div>
    <div id="loadingOverlayBar"><div id="loadingOverlayFill"></div></div>
    <div id="loadingPercent">0%</div>
  </div>
</div>

<div id="vizModal" class="overlay hidden">
  <div class="box viz-modal-content">
    <h3>Visualization</h3>
    <!-- CORRECTIVE: Explanatory copy for visualization -->
    <p style="font-size:0.85em; color:var(--gold); margin-bottom:10px; font-style:italic;">
        You may freely edit the prompt below. Images are limited to Naughty-level eroticism.
        Prompts are automatically scaled down to avoid artist refusal.
    </p>
    <textarea id="vizPromptInput" placeholder="Prompt will appear here..."></textarea>

    <!-- CORRECTIVE: Quick Prompt Modifier heading -->
    <h4 style="font-size:1.1em; color:var(--pink); margin:15px 0 5px; font-weight:bold;">Quick Prompt Modifier</h4>
    <!-- Modifier section: scrolling suggestions + text input -->
    <div id="vizModifierSection" class="fate-input-wrapper" style="margin-top:5px;">
        <input type="text" id="vizModifierInput" class="fate-field" placeholder="">
        <div class="rotating-placeholder" data-for="vizModifierInput"></div>
    </div>
    <!-- CORRECTIVE: Instructions for modifiers -->
    <p style="font-size:0.8em; color:#888; margin-top:5px; font-style:italic;">
        Type or select a modifier to adjust the image. Modifiers are appended to your prompt.
    </p>

    <div id="vizPlaceholder">Generating...</div>

    <div id="vizImgContainer">
        <img id="vizPreviewImg" alt="Scene" style="display:none">
        <div id="vizError" class="img-error-msg hidden"></div>
    </div>

    <div class="viz-controls">
        <select id="vizModel" disabled style="opacity:0.6;">
            <option value="perchance" selected>Perchance</option>
        </select>
        <button class="small-btn" id="vizRetryBtn" onclick="window.visualize(true)">Re-Visualize</button>
        <button onclick="window.insertImage()">Insert</button>
        <button class="small-btn" style="background:#555" onclick="window.closeViz()">Cancel</button>
    </div>
    <label class="sb-checkbox" style="font-size:0.8em; justify-content:center; margin-top:12px;">
        <input type="checkbox" id="chkAutoLockVisual" checked>
        <span class="sb-checkbox-visual"></span>
        <span class="sb-checkbox-label" style="color:var(--gold); opacity:0.8;">Lock character look after this Visualize</span>
    </label>
  </div>
</div>

<div id="eroticPreviewModal" class="overlay hidden" style="z-index:10001;">
  <div class="box" style="max-width:500px;">
    <h3 style="color:var(--hot)">Erotic Intensity Preview</h3>
    <p style="opacity:0.8; font-size:0.9em;">Explicit content enabled. Sample:</p>
    <div id="eroticPreviewText"></div>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
        <button onclick="window.showPaywall('unlock');">Storypass $3</button>
        <button onclick="document.getElementById('eroticPreviewModal').classList.add('hidden')" style="background:#444">Not Now</button>
    </div>
  </div>
</div>

<div id="coupleInvite" class="overlay hidden">
  <div class="box" style="max-width:520px; text-align:center;">
    <h3>Open a Private Chamber</h3>

    <div class="couple-status-box">
      <div><strong>Your nickname:</strong> <span id="sbNickLabel" style="color:var(--gold)">…</span></div>
      <div><strong>Status:</strong> <span id="coupleStatus" style="font-style:italic">Not connected</span></div>
      <div><strong>Room Code:</strong> <span id="coupleRoomCodeLabel" style="font-family:monospace; color:var(--pink)">—</span></div>
    </div>

    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
      <button id="btnCreateRoom">New Invitation</button>
      <button id="btnJoinRoom" style="background:#444">Join Room</button>
    </div>

    <div id="joinRow" class="hidden" style="margin-bottom:15px; display:flex; gap:10px; justify-content:center;">
      <input id="joinCodeInput" placeholder="Enter 6-char Code" style="text-transform:uppercase; text-align:center; width:150px;">
      <button id="btnJoinGo">Enter</button>
    </div>

    <div id="roomCodeWrap" class="hidden" style="margin-bottom:15px;">
      <div class="invitation-card" style="background: rgba(255,105,180,0.08); border: 1px solid rgba(255,105,180,0.3); border-radius: 10px; padding: 20px; margin-bottom: 15px;">
        <p id="invitationText" style="font-style: italic; color: var(--ink); margin: 0 0 15px; line-height: 1.5;">
          "A private chamber awaits. The mask is optional. The curiosity is not."
        </p>
        <div id="coupleRoomCodeWrap">
           <div id="roomCodeBig">—</div>
           <button id="btnCopyCode" title="Copy Code">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
           </button>
        </div>
      </div>

      <p style="margin:0 0 10px; font-size:0.85em; color:var(--gold);">Send invitation via:</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
        <button id="btnSendEmail" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">Email</button>
        <button id="btnSendSMS" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">SMS</button>
        <button id="btnSendBoth" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">Both</button>
      </div>
      <p id="inviteSentStatus" class="hidden" style="color:var(--gold); font-size:0.85em; margin:10px 0;">Invitation sent. Awaiting your paramour...</p>
    </div>

    <div>
      <button id="btnEnterCoupleGame" class="hidden" style="width:100%; margin-bottom:10px;" disabled>Enter Chamber Together</button>
      <button id="btnPlaySoloWaiting" class="hidden" style="width:100%; margin-bottom:10px; background:#333; border:1px solid var(--gold);">Play Solo Until Your Paramour Joins</button>
      <button onclick="window.coupleCleanup(); window.showScreen('modeSelect')" style="background:transparent; border:1px solid #444; font-size:0.9em;">Back</button>
    </div>
  </div>
</div>

<div id="coupleConsentModal" class="overlay hidden">
  <div class="box" style="max-width:450px; text-align:center;">
    <h3 style="color:var(--gold);">Shared Intensity Agreement</h3>
    <p>You are entering a shared hallucination. Before you begin:</p>
    <ul style="text-align:left; font-size:0.9em; line-height:1.5; color:var(--ink); margin: 20px auto; max-width: 350px;">
        <li><strong>Intensity is a hard ceiling.</strong> Limits depictions regardless of input.</li>
        <li><strong>Inputs are requests.</strong> Naughty reinterprets explicit inputs as tension.</li>
        <li><strong>Upgrades required.</strong> Higher intensity requires appropriate tier.</li>
    </ul>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button id="btnCoupleAgree">Agree & Enter</button>
        <button onclick="window.showScreen('setup'); document.getElementById('coupleConsentModal').classList.add('hidden');" style="background:#444">Change Settings</button>
    </div>
  </div>
</div>

<div id="strangerModal" class="overlay hidden">
  <div class="box">
    <h3>How Daring...</h3>
    <p><span id="strangerCount">12,408</span> others are seeking a connection right now.</p>
    <p style="font-style:italic; color:var(--gold)">Matching is currently unavailable in this version.</p>
    <button onclick="window.showScreen('modeSelect')" style="background:#444">Return</button>
  </div>
</div>

<div id="ageGate" class="screen overlay" style="background:#000; z-index:9999;">
  <div style="text-align:center;">
      <h2>Storybound</h2>
      <p style="font-size:1.2em; max-width:500px; margin:20px;">Explicit adult themes. 18+ Only.</p>
      <button id="ageYes">I am 18+</button>
      <button onclick="location.href='https://google.com'" style="background:#333">Exit</button>
  </div>
</div>

<div id="tosGate" class="screen overlay hidden" style="background:#000; z-index:9998;">
  <div class="box" style="text-align:center;">
      <h2>Terms of Service</h2>
      <div class="tos-box">
        <p><strong>TERMS OF SERVICE</strong></p>
        <p>1. <strong>Age Requirement:</strong> You must be 18+.</p>
        <p>2. <strong>Content Policy:</strong> Adult fantasy roleplay only. Content must be consensual. Optional power play is permitted only if explicitly opted-in. No non-consensual sexual acts, sexual violence, or minors.</p>
        <p>3. <strong>Data & AI:</strong> Content generated by third-party AI models. We may anonymize data.</p>
        <p>4. <strong>Liability:</strong> Use at your own risk. Entertainment purposes only.</p>
      </div>
      <label><input type="checkbox" id="tosCheck"> I agree to the Terms</label>
      <br>
      <button id="tosBtn" disabled>Enter Storybound</button>
  </div>
</div>

<div id="tierGate" class="screen overlay hidden" style="background:#000; z-index:9997;">
  <div style="text-align:center;">
      <h2>Storybound</h2>
      <div class="choice-buttons">
        <div style="text-align:center">
          <button class="choice" id="btnTease">Tease</button>
          <p class="choice-desc">A playful warmup—gentle choices, tension, and atmosphere.<br><br><strong>From $Free</strong></p>
        </div>
        <div style="text-align:center">
          <button class="choice" id="btnIndulge">Indulge</button>
          <p class="choice-desc">Longer openings, deeper memory, full control, saved stories.<br><br><strong>From $6/mo</strong></p>
        </div>
      </div>
      <button id="continueFromTierBtn" class="choice hidden" style="margin-top:20px; width:80%; max-width:300px;" onclick="window.continueStory()">Continue Saved Story</button>
      <button id="btnForbiddenLibrary" class="choice" style="margin-top:20px; width:80%; max-width:300px;" onclick="window.openForbiddenLibrary()">The Forbidden Library</button>
  </div>
</div>

<div id="payModal" class="overlay hidden" style="z-index:10000;">
  <div class="box" style="text-align:center; max-width: 500px;">
    <h3>Unshackle Your Fate</h3>
    
    <div id="godModePay" class="hidden">
       <h4 style="color:var(--gold); margin-top:0; font-size:1.4em;">Unlock God Mode</h4>
       <p style="font-size:0.9em; opacity:0.8; margin-bottom:20px;">
         Sandbox power. No cooldowns. No safety.
         <br><strong>$50 One-time purchase.</strong>
       </p>
       <button id="payGodMode" style="width:100%; margin-top:10px; background:var(--gold); color:black;">Unlock Forever ($50)</button>
    </div>

    <div id="standardPay">
        <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin:20px 0;">
            <div id="optUnlock" class="hidden" style="background:#222; padding:15px; border-radius:10px; border:1px solid #ff69b4; width:220px; text-align:left;">
                <h4 style="color:var(--pink); margin-top:0;">Unlock This Story</h4>
                <p style="font-size:0.85em; line-height:1.4;">Go deeper for this one arc.<br>Erotic intensity, longer pacing, Quill access.<br><strong>$3 Story Pass.</strong></p>
                <button id="payOneTime" style="width:100%; margin-top:15px;">Storypass $3</button>
            </div>

            <div id="optSub" style="background:linear-gradient(145deg, #400020, #200010); padding:15px; border-radius:10px; border:1px solid gold; width:220px; text-align:left;">
                <h4 style="color:var(--gold); margin-top:0;">Indulge Limits</h4>
                <ul style="font-size:0.8em; padding-left:15px; opacity:0.9; line-height:1.4; list-style-type: '⚜ ';">
                    <li>Dirty intensity</li>
                    <li>Long-form stories</li>
                    <li>Unlimited Quill</li>
                    <li>Save anytime</li>
                </ul>
                <div style="text-align:center; font-size:0.9em; margin:10px 0; color:var(--gold);">$6/month</div>
                <button id="paySub" style="width:100%; background:linear-gradient(145deg, gold, #b8860b); color:black; font-weight:bold;">Subscribe</button>
            </div>
        </div>
    </div>
    
    <button onclick="document.getElementById('payModal').classList.add('hidden')" style="background:#444; margin-top:15px;">Cancel</button>
  </div>
</div>

<div id="previewModal" class="overlay hidden" style="z-index:10010;">
  <div class="box">
    <p id="previewText" style="font-size:1.3em; font-style:italic; line-height:1.6"></p>
    <button onclick="document.getElementById('previewModal').classList.add('hidden')">Close</button>
  </div>
</div>

<div id="app" class="hidden">

  <div id="modeSelect" class="screen">
    <h1 style="margin-top:40px">Storybound</h1>
    
    <div class="choice-buttons">
      <div style="text-align:center">
          <button class="choice" onclick="window.setMode('solo')">Solo</button>
          <p class="choice-desc">Your private laboratory—intentional, charged.</p>
      </div>
      <div style="text-align:center">
          <button class="choice" id="btnCoupleMode" onclick="window.setMode('couple')">Couple</button>
          <p class="choice-desc">Link devices and co-create a shared seduction.</p>
      </div>
      <div style="text-align:center">
          <button class="choice" onclick="window.setMode('stranger')">Stranger</button>
          <p class="choice-desc">Tempt fate with a random encounter.</p>
      </div>
    </div>

    <!-- The Forbidden Library Shelf -->
    <div id="forbiddenLibraryShelf" class="library-shelf" style="margin-top:40px; overflow-x:auto; white-space:nowrap; padding:20px 0;">
      <div class="section-title" style="white-space:normal; margin-bottom:15px;">The Forbidden Library</div>
      <div id="libraryShelfContent" class="shelf-scroll" style="display:flex; gap:15px; overflow-x:auto; padding-bottom:10px;">
        <!-- Book covers populated by app.js when data source is available -->
      </div>
    </div>
  </div>

  <div id="setup" class="screen hidden" style="max-width:800px; margin:0 auto; padding-bottom:50px;">
    
    <div class="section-title">Shape Your Story</div>
    
    <div class="input-wrapper">
        <label>Your Character's Name</label>
        <input id="playerNameInput" type="text" placeholder="e.g. Elara Vance">
    </div>

    <div class="input-wrapper">
        <label>Your Love Interest's Name</label>
        <input id="partnerNameInput" type="text" placeholder="e.g. Lord Blackwood">
    </div>
    
    <div class="grid-2-col">
        <div>
            <label>Your Gender</label>
            <select id="playerGender" onchange="checkCustom(this, 'customPlayerGender')">
                <option value="Female">Female</option>
                <option value="Male">Male</option>
                <option value="Non-Binary">Non-Binary</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customPlayerGender" type="text" placeholder="Enter gender..." class="hidden" style="margin-top:5px;">
            
            <label style="margin-top:10px;">Pronouns</label>
            <select id="playerPronouns" onchange="checkCustom(this, 'customPlayerPronouns')">
                <option value="She/Her">She/Her</option>
                <option value="He/Him">He/Him</option>
                <option value="They/Them">They/Them</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customPlayerPronouns" type="text" placeholder="Enter pronouns..." class="hidden" style="margin-top:5px;">
        </div>

        <div>
            <label>Love Interest Gender</label>
            <select id="loveInterestGender" onchange="checkCustom(this, 'customLoveInterest')">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Non-Binary">Non-Binary</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customLoveInterest" type="text" placeholder="Enter gender..." class="hidden" style="margin-top:5px;">
            
            <label style="margin-top:10px;">Pronouns</label>
            <select id="lovePronouns" onchange="checkCustom(this, 'customLovePronouns')">
                <option value="He/Him">He/Him</option>
                <option value="She/Her">She/Her</option>
                <option value="They/Them">They/Them</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customLovePronouns" type="text" placeholder="Enter pronouns..." class="hidden" style="margin-top:5px;">
        </div>
    </div>

    <div class="section-title">Ancestry / Culture</div>
    <p class="ancestry-subtext">Optional: ground the characters in a cultural or ancestral context.</p>

    <div class="ancestry-container">
        <div class="ancestry-subsection">
            <div class="ancestry-label">Yours</div>
            <div class="fate-input-row">
                <div class="input-wrapper fate-input-wrapper">
                    <input id="ancestryInputPlayer" type="text" class="fate-field" data-fate-type="ancestry">
                    <div class="rotating-placeholder" data-for="ancestryInputPlayer"></div>
                </div>
                <div class="fate-hand" data-target="ancestryInputPlayer" data-type="ancestry">
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                </div>
                <div class="fate-tree-card hidden" data-target="ancestryInputPlayer">
                    <div class="tree-silhouette"></div>
                    <div class="falling-leaf"><svg viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"><path d="M6 14C6 14 0 8 0 5C0 2.5 2 0 6 0C10 0 12 2.5 12 5C12 8 6 14 6 14Z" fill="#c9a227" stroke="#8b7355" stroke-width="0.5"/><path d="M6 2V11" stroke="#a08030" stroke-width="0.6" stroke-linecap="round"/></svg></div>
                </div>
            </div>
        </div>

        <div class="ancestry-subsection">
            <div class="ancestry-label" id="ancestryLabelLI">Your Storybeau's</div>
            <div class="fate-input-row">
                <div class="input-wrapper fate-input-wrapper">
                    <input id="ancestryInputLI" type="text" class="fate-field" data-fate-type="ancestry">
                    <div class="rotating-placeholder" data-for="ancestryInputLI"></div>
                </div>
                <div class="fate-hand" data-target="ancestryInputLI" data-type="ancestry">
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                </div>
                <div class="fate-tree-card hidden" data-target="ancestryInputLI">
                    <div class="tree-silhouette"></div>
                    <div class="falling-leaf"><svg viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"><path d="M6 14C6 14 0 8 0 5C0 2.5 2 0 6 0C10 0 12 2.5 12 5C12 8 6 14 6 14Z" fill="#c9a227" stroke="#8b7355" stroke-width="0.5"/><path d="M6 2V11" stroke="#a08030" stroke-width="0.6" stroke-linecap="round"/></svg></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section-title" id="archetypeSectionTitle">Shape Your Storybeau</div>
    <p class="archetype-header-text">Choose a core desire style for this character.</p>
    <p class="archetype-subtext">Select one Primary archetype. You may optionally add one Modifier to refine how it shows up.</p>

    <div class="archetype-selection">
        <div class="archetype-group">
            <label class="archetype-group-label">Primary Archetype — Defines the emotional core and relationship arc.</label>
            <div class="archetype-pills" id="primaryArchetypePills"></div>
        </div>

        <div class="archetype-group">
            <label class="archetype-group-label">Optional Modifier — Refines expression without changing the core.</label>
            <div class="archetype-pills" id="modifierArchetypePills"></div>
        </div>

        <p class="archetype-constraint-text">Only one Primary archetype may be selected. The Beautiful Ruin and The Anti-Hero may only be chosen as a Primary.</p>
    </div>

    <div id="archetypePreview" class="archetype-preview hidden">
        <div id="archetypePreviewContent"></div>
    </div>

    <div class="section-title">Intensity <span class="instruction-text">(Rendering Ceiling)</span></div>
    <div id="intensityBtns" class="intensity-wrap">
      <button data-val="Clean" class="intensity-btn" data-desc="Romantic, non-explicit.">Clean</button>
      <button data-val="Naughty" class="intensity-btn active" data-desc="Suggestive tension; no explicit anatomy.">Naughty</button>
      <button data-val="Erotic" class="intensity-btn locked-tease" data-desc="Explicit sex; adult consensual.">Erotic</button>
      <button data-val="Dirty" class="intensity-btn locked-pass" data-desc="Very explicit; highest intensity.">Dirty</button>
    </div>
    <p id="intensityDesc" style="color:var(--gold); font-style:italic; margin-top:10px; min-height:40px;">
        (Naughty) Suggestive tension; no explicit anatomy.
    </p>

    <div id="lengthSection">
        <div class="section-title">Story Length</div>
        <p class="subtitle">Choose once. This shapes pacing and endings.</p>
        
        <div class="style-cards" id="lengthGrid">
          <div class="card selected" data-grp="length" data-val="voyeur">
            <h3>Voyeur Tease</h3>
            <p>A front-row seat. No touching. Ends right when you lean in.</p>
          </div>

          <div class="card locked" data-grp="length" data-val="fling" data-locked="pass">
            <h3>Fling</h3>
            <p>You get to get off, but you don’t get to finish.</p>
          </div>

          <div class="card locked" data-grp="length" data-val="affair" data-locked="sub">
            <h3>Affair</h3>
            <p>Longer nights, deeper consequences. Arcs unfold. Nothing is rushed.</p>
          </div>

          <div class="card locked" data-grp="length" data-val="soulmates" data-locked="sub">
            <h3>Soulmates</h3>
            <p>This isn’t about what happens next. It’s about what keeps happening.</p>
          </div>
        </div>
    </div>

    <!-- STORY POV (Repositioned: POV → Safety → World) -->
    <div class="section-title">Story POV</div>
    <div class="style-cards" id="povGrid">
      <div class="card selected" data-grp="pov" data-val="First"><h3>1st Person (I)</h3><p>Intimate, confessional, inside my own pulse.</p></div>
      <div class="card" data-grp="pov" data-val="Second"><h3>2nd Person (You)</h3><p>Every glance, every silence, happening to you.</p></div>
      <div class="card" data-grp="pov" data-val="Third"><h3>3rd Person (They)</h3><p>Close enough to feel, distant enough to see.</p></div>
      <div class="card" data-grp="pov" data-val="Fourth"><h3>4th Person (We)</h3><p>Witnesses to the inevitable.</p></div>
      <div class="card" data-grp="pov" data-val="Fifth"><h3>5th Person (Author)</h3><p>"The Author has big plans for you…"</p></div>
    </div>

    <!-- SAFETY & BOUNDARIES (Repositioned: after POV, before World) -->
    <div class="section-title">Safety & Boundaries</div>
    <div class="sb-checkbox-group">
        <label class="sb-checkbox">
            <input type="checkbox" id="chkDark" checked>
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Dark Themes</span>
        </label>
        <label class="sb-checkbox">
            <input type="checkbox" id="chkNonCon">
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Implied Non-consent</span>
        </label>
        <label class="sb-checkbox">
            <input type="checkbox" id="chkViolence" checked>
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Violence / Peril</span>
        </label>
    </div>
    <div class="boundary-chips" id="boundaryChips">
        <div class="chip locked-chip active" title="Always enforced">No sexual violence</div>
        <div class="chip" data-boundary="coercion">No coercion</div>
        <div class="chip" data-boundary="degradation">No degradation language</div>
        <div class="chip" data-boundary="captivity">No captivity</div>
        <div class="chip" data-boundary="blackmail">No blackmail</div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         FOUR-AXIS STORY SELECTION SYSTEM (AUTHORITATIVE)
         Order: World → Tone → Genre → Dynamic
         ═══════════════════════════════════════════════════════════════════ -->

    <!-- FLOATING SYNOPSIS PANEL (Side-mounted book jacket card) -->
    <div id="synopsisPanel" class="synopsis-panel">
      <p id="synopsisText" class="synopsis-text">
        <span id="synWorld">Where shadows hold secrets</span>
        <span id="synTone">Face what you've buried</span>
        <span id="synGenre">Navigate dangerous alliances</span>
        <span id="synDynamic">The one you need most becomes your enemy</span>
      </p>
    </div>

    <!-- AXIS 1: STORY WORLD (Required, First) -->
    <div class="section-title">Story World <span class="instruction-text">(Required)</span></div>
    <div class="style-cards" id="worldGrid">
      <div class="card selected" data-grp="world" data-val="Modern"><h3>Modern / Contemporary</h3><p>Present-day cities, technology, social norms.</p></div>
      <div class="card" data-grp="world" data-val="Historical"><h3>Historical</h3><p>A real past era with period constraints.</p></div>
      <div class="card" data-grp="world" data-val="Dystopia"><h3>Dystopia</h3><p>Oppressive systems, controlled societies.</p></div>
      <div class="card" data-grp="world" data-val="PostApocalyptic"><h3>Post-Apocalyptic</h3><p>Survival after collapse, scarce resources.</p></div>
      <div class="card" data-grp="world" data-val="Fantasy"><h3>Fantasy</h3><p>Magic, mythical creatures, invented worlds.</p></div>
      <div class="card" data-grp="world" data-val="SciFi"><h3>Sci-Fi</h3><p>Advanced technology, space, future societies.</p></div>
      <div class="card" data-grp="world" data-val="Supernatural"><h3>Supernatural</h3><p>Vampires, shifters, witches in hidden worlds.</p></div>
      <div class="card" data-grp="world" data-val="Superheroic"><h3>Superheroic</h3><p>Powers, masks, secret identities, cosmic stakes.</p></div>
    </div>

    <!-- Historical Era Sub-Selection (shown only when Historical selected) -->
    <div id="eraSelection" class="era-selection hidden">
      <div class="section-title sub-title">Historical Era <span class="instruction-text">(Required)</span></div>
      <div class="style-cards" id="eraGrid">
        <div class="card" data-grp="era" data-val="Ancient"><h3>Ancient / Tribal</h3><p>Before written empires.</p></div>
        <div class="card" data-grp="era" data-val="Classical"><h3>Classical / Biblical</h3><p>Greece, Rome, early civilizations.</p></div>
        <div class="card selected" data-grp="era" data-val="Medieval"><h3>Medieval</h3><p>Feudal lords, castles, crusades.</p></div>
        <div class="card" data-grp="era" data-val="Renaissance"><h3>Renaissance / Early Modern</h3><p>Art, exploration, reformation.</p></div>
        <div class="card" data-grp="era" data-val="Victorian"><h3>Industrial / Victorian</h3><p>Empire, industry, propriety.</p></div>
        <div class="card" data-grp="era" data-val="Early20th"><h3>Early 20th Century</h3><p>Wars, jazz age, modernism.</p></div>
        <div class="card" data-grp="era" data-val="Mid20th"><h3>Mid-20th Century</h3><p>Post-war, cold war, social change.</p></div>
      </div>
    </div>

    <!-- Sci-Fi Subtype Sub-Selection (shown only when SciFi selected) -->
    <div id="scifiSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Sci-Fi Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="style-cards" id="scifiSubtypeGrid">
        <div class="card" data-grp="worldSubtype" data-val="space_opera"><h3>Space Opera</h3><p>Galactic empires, starship battles, interstellar politics.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="hard_scifi"><h3>Hard Sci-Fi</h3><p>Scientific accuracy, plausible technology, realistic physics.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="cyberpunk"><h3>Cyberpunk</h3><p>Neon cities, corporate dystopia, hackers and augmentation.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="post_human"><h3>Post-Human</h3><p>Transcendence, uploaded minds, evolved consciousness.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="alien_contact"><h3>Alien Contact</h3><p>First contact, xenobiology, interspecies encounters.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="military_scifi"><h3>Military Sci-Fi</h3><p>Space marines, fleet combat, duty and sacrifice.</p></div>
      </div>
    </div>

    <!-- Fantasy Subtype Sub-Selection (shown only when Fantasy selected) -->
    <div id="fantasySubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Fantasy Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="style-cards" id="fantasySubtypeGrid">
        <div class="card" data-grp="worldSubtype" data-val="high_fantasy"><h3>High Fantasy</h3><p>Epic quests, powerful magic, mythical creatures.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="low_fantasy"><h3>Low Fantasy</h3><p>Subtle magic, grounded stakes, rare supernatural.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="dark_fantasy"><h3>Dark Fantasy</h3><p>Grim worlds, dangerous magic, moral corruption.</p></div>
      </div>
    </div>

    <!-- Horror Subtype Sub-Selection (shown when Horror tone selected with Fantasy/Supernatural) -->
    <div id="horrorSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Horror Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="style-cards" id="horrorSubtypeGrid">
        <div class="card" data-grp="worldSubtype" data-val="cosmic_horror"><h3>Cosmic Horror</h3><p>Unknowable entities, insignificance, existential dread.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="psychological_horror"><h3>Psychological</h3><p>Mind games, paranoia, internal terror.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="gothic_horror"><h3>Gothic Horror</h3><p>Decaying mansions, ancestral curses, romantic dread.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="body_horror"><h3>Body Horror</h3><p>Transformation, corruption of flesh, visceral dread.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="folk_horror"><h3>Folk Horror</h3><p>Rural isolation, ancient rituals, community darkness.</p></div>
      </div>
    </div>

    <!-- Dystopia Subtype Sub-Selection (shown only when Dystopia selected) -->
    <div id="dystopiaSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Dystopia Flavor <span class="instruction-text">(Optional)</span></div>
      <div class="style-cards" id="dystopiaSubtypeGrid">
        <div class="card" data-grp="worldSubtype" data-val="authoritarian"><h3>Authoritarian</h3><p>Totalitarian state, thought control, rebellion.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="surveillance"><h3>Surveillance</h3><p>Constant monitoring, no privacy, digital control.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="corporate"><h3>Corporate</h3><p>Mega-corps rule, profit over people, wage slavery.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="environmental"><h3>Environmental</h3><p>Ecological collapse, scarce resources, climate ruin.</p></div>
      </div>
    </div>

    <!-- Post-Apocalyptic Subtype Sub-Selection (shown only when PostApocalyptic selected) -->
    <div id="apocalypseSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Apocalypse Type <span class="instruction-text">(Optional)</span></div>
      <div class="style-cards" id="apocalypseSubtypeGrid">
        <div class="card" data-grp="worldSubtype" data-val="nuclear"><h3>Nuclear</h3><p>Atomic devastation, radiation, mutants.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="pandemic"><h3>Pandemic</h3><p>Plague survivors, immune vs infected, quarantine.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="climate"><h3>Climate</h3><p>Environmental collapse, extreme weather, survival.</p></div>
        <div class="card" data-grp="worldSubtype" data-val="technological"><h3>Technological</h3><p>AI uprising, tech failure, machines vs humans.</p></div>
      </div>
    </div>

    <!-- AXIS 2: STORY TONE (Required, Second) -->
    <div class="section-title">Story Tone <span class="instruction-text">(Required)</span></div>
    <div class="style-cards" id="toneGrid">
      <div class="card selected" data-grp="tone" data-val="Earnest"><h3>Earnest</h3><p>Sincere emotion, unironic stakes.</p></div>
      <div class="card" data-grp="tone" data-val="WryConfession"><h3>Wry Confession</h3><p>Intimacy with irony, self-aware narrator.</p></div>
      <div class="card" data-grp="tone" data-val="Satirical"><h3>Satirical</h3><p>Social critique, exaggeration, systems mocked.</p></div>
      <div class="card" data-grp="tone" data-val="Dark"><h3>Dark</h3><p>Morally complex, shadowed desire.</p></div>
      <div class="card" data-grp="tone" data-val="Horror"><h3>Horror</h3><p>Dread, the uncanny, fear as tension.</p></div>
      <div class="card" data-grp="tone" data-val="Mythic"><h3>Mythic</h3><p>Archetypal weight, legendary scale.</p></div>
      <div class="card" data-grp="tone" data-val="Comedic"><h3>Comedic</h3><p>Humor is primary, stakes are light.</p></div>
      <div class="card" data-grp="tone" data-val="Surreal"><h3>Surreal</h3><p>Dreamlike, unstable, symbolic.</p></div>
      <div class="card" data-grp="tone" data-val="Poetic"><h3>Poetic</h3><p>Lyrical prose, sensory immersion.</p></div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         AXIS 3: GENRE / FLAVOR (Required, Third)

         LOCKED DESIGN RULE:
         Genres must describe narrative action or fantasy, not setting or life stage.
         Settings like "Sports", "College", "Small Town" belong in World modifiers,
         not Genre. Genre implies what the characters DO, not where they ARE.
         ═══════════════════════════════════════════════════════════════════ -->
    <div class="section-title">Genre <span class="instruction-text">(Narrative flavor)</span></div>
    <div class="style-cards" id="genreGrid">
      <div class="card" data-grp="genre" data-val="CrimeSyndicate"><h3>Crime Syndicate</h3><p>Organized crime, loyalty, blood oaths.</p></div>
      <div class="card selected" data-grp="genre" data-val="Billionaire"><h3>Billionaire</h3><p>Ultra-wealth, power plays, golden cages.</p></div>
      <div class="card" data-grp="genre" data-val="Noir"><h3>Noir</h3><p>Shadows, moral compromise, fatalism.</p></div>
      <div class="card" data-grp="genre" data-val="Heist"><h3>Heist</h3><p>Elaborate plans, trust and betrayal.</p></div>
      <div class="card" data-grp="genre" data-val="Espionage"><h3>Espionage</h3><p>Spies, double lives, dangerous information.</p></div>
      <div class="card" data-grp="genre" data-val="Political"><h3>Political Intrigue</h3><p>Power structures, alliances, betrayal.</p></div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         AXIS 4: RELATIONSHIP DYNAMIC (Required, Last)

         LOCKED DESIGN RULE:
         Relationship Dynamics are single-select and represent emotional structure,
         not identity. They describe how characters relate, not who they are.
         Groupings are for cognitive organization only—selection remains flat.
         ═══════════════════════════════════════════════════════════════════ -->
    <div class="section-title">Relationship Dynamic <span class="instruction-text">(Required)</span></div>
    <div class="dynamic-grouped" id="dynamicGrid">
      <!-- Circumstance-Based -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Circumstance-Based</div>
        <div class="style-cards">
          <div class="card" data-grp="dynamic" data-val="Proximity"><h3>Forced Proximity</h3><p>Circumstance throws them together.</p></div>
          <div class="card" data-grp="dynamic" data-val="SecretIdentity"><h3>Secret Identity</h3><p>Hidden truths, masks, revelations.</p></div>
          <div class="card" data-grp="dynamic" data-val="Caretaker"><h3>Caretaker / Wounded</h3><p>Vulnerability and steady presence.</p></div>
        </div>
      </div>
      <!-- Emotional Arc -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Emotional Arc</div>
        <div class="style-cards">
          <div class="card" data-grp="dynamic" data-val="Friends"><h3>Friends to Lovers</h3><p>Safety tipping into something more.</p></div>
          <div class="card selected" data-grp="dynamic" data-val="Enemies"><h3>Enemies to Lovers</h3><p>Friction that becomes fire.</p></div>
          <div class="card" data-grp="dynamic" data-val="SecondChance"><h3>2nd Chance</h3><p>Past lovers, unfinished business.</p></div>
          <div class="card" data-grp="dynamic" data-val="Forbidden"><h3>Forbidden Love</h3><p>Rules, taboo, desire against judgment.</p></div>
        </div>
      </div>
      <!-- Intensity / Attachment -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Intensity / Attachment</div>
        <div class="style-cards">
          <div class="card" data-grp="dynamic" data-val="Dangerous"><h3>Dangerous</h3><p>Risk in proximity, threat as aphrodisiac.</p></div>
          <div class="card" data-grp="dynamic" data-val="Obsessive"><h3>Obsessive Devotion</h3><p>Consuming focus, intensity as love language.</p></div>
          <div class="card" data-grp="dynamic" data-val="Fated"><h3>Fated</h3><p>Destined bond, cosmic inevitability.</p></div>
          <div class="card" data-grp="dynamic" data-val="Partners"><h3>Partners in Crime</h3><p>Complicity, shared secrets, us vs them.</p></div>
        </div>
      </div>
    </div>

    <div class="section-title">Quill & Veto</div>

    <div class="quill-veto-container">
        <div class="qv-section">
            <label class="qv-label">Veto</label>
            <p class="qv-hint-above">Block elements you never want to appear. Vetoes are immediate and permanent.</p>
            <div id="vetoCommitted" class="committed-phrases"></div>
            <div class="fate-input-row">
                <div class="input-wrapper fate-input-wrapper fate-textarea-wrapper">
                    <textarea id="vetoInput" rows="2" class="fate-field" data-fate-type="veto"></textarea>
                    <div class="rotating-placeholder textarea-placeholder" data-for="vetoInput"></div>
                </div>
                <div class="fate-hand" data-target="vetoInput" data-type="veto">
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                </div>
                <div class="fate-tree-card hidden" data-target="vetoInput">
                    <div class="tree-silhouette"></div>
                    <div class="falling-leaf"><svg viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"><path d="M6 14C6 14 0 8 0 5C0 2.5 2 0 6 0C10 0 12 2.5 12 5C12 8 6 14 6 14Z" fill="#c9a227" stroke="#8b7355" stroke-width="0.5"/><path d="M6 2V11" stroke="#a08030" stroke-width="0.6" stroke-linecap="round"/></svg></div>
                </div>
            </div>
            <p class="qv-hint-below">Vetoes remove content from consideration. They cannot start scenes or direct the story.</p>
        </div>

        <div class="qv-section">
            <label class="qv-label">Quill</label>
            <p class="qv-hint-above">Use the Quill to gently steer tone, boundaries, or direction without rewriting what's already happened.</p>
            <div id="quillCommitted" class="committed-phrases"></div>
            <div class="fate-input-row">
                <div id="quillBox" class="input-wrapper fate-input-wrapper fate-textarea-wrapper locked-input" onclick="window.showPaywall('unlock')">
                    <textarea id="quillInput" rows="2" class="fate-field" data-fate-type="quill"></textarea>
                    <div class="rotating-placeholder textarea-placeholder" data-for="quillInput"></div>
                </div>
                <div class="fate-hand" data-target="quillInput" data-type="quill">
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                    <div class="fate-hand-card"></div>
                </div>
                <div class="fate-tree-card hidden" data-target="quillInput">
                    <div class="tree-silhouette"></div>
                    <div class="falling-leaf"><svg viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg"><path d="M6 14C6 14 0 8 0 5C0 2.5 2 0 6 0C10 0 12 2.5 12 5C12 8 6 14 6 14Z" fill="#c9a227" stroke="#8b7355" stroke-width="0.5"/><path d="M6 2V11" stroke="#a08030" stroke-width="0.6" stroke-linecap="round"/></svg></div>
                </div>
            </div>
            <p class="qv-hint-below">Quill edits shape what follows and may persist. Each use exhausts the Quill, requiring time and words before it can be wielded again.</p>
        </div>
    </div>

    <div class="quill-veto-ui">
        <div style="display:flex; width:100%; justify-content:space-between; align-items:center; margin-bottom:5px; gap:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="vetoStatus" style="font-size:0.85em; color:var(--pink);">Veto: Ready</span>
                <button id="btnCommitVeto" class="small-btn" style="padding:4px 10px; font-size:0.85em;">Commit Veto</button>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="quillStatus">Quill: Poised</span>
                <button id="btnCommitQuill" class="small-btn" style="padding:4px 10px; font-size:0.85em; opacity:0.5;" disabled>Commit Quill</button>
            </div>
        </div>
        <div id="godModeToggle" class="hidden">
            <label id="godModeLabel"><input type="checkbox" id="godModeCheck"> Enable God Mode (Sandbox)</label>
        </div>
    </div>

    <br>
    <button id="beginBtn" style="font-size:1.5em; margin-top:20px;">Begin Story</button>
  </div>

  <div id="game" class="screen hidden" style="max-width:900px; margin:0 auto; padding-bottom:60px;">

    <!-- ============================================================ -->
    <!-- BOOK COVER PAGE - Physical book object, clickable anywhere   -->
    <!-- ============================================================ -->
    <div id="bookCoverPage" class="book-cover-page">
      <div id="coverLoadingState" class="cover-loading">
        <div class="cover-progress-bar">
          <div id="coverProgressFill" class="cover-progress-fill"></div>
        </div>
        <p id="coverStatusText" class="cover-status-text">Building your book cover...</p>
      </div>

      <!-- Physical book object - no buttons, click anywhere to open -->
      <div id="bookObject" class="book-object hidden">
        <!-- Bookmark ribbon (visible for returning readers) -->
        <div id="bookmarkRibbon" class="bookmark-ribbon hidden"></div>

        <!-- Book cover with hinge -->
        <div id="bookCover" class="book-cover">
          <img id="bookCoverImg" src="" alt="Book Cover" class="book-cover-image">
        </div>

        <!-- Book pages underneath (visible during courtesy hinge) -->
        <div id="bookPagesPreview" class="book-pages-preview">
          <div class="page-edge-stack"></div>
        </div>

        <!-- Book spine/thickness -->
        <div class="book-spine"></div>
        <div class="book-thickness"></div>
      </div>
    </div>

    <!-- Page-turn animation overlay (deprecated - using hinge now) -->
    <div id="pageTurnOverlay" class="page-turn-overlay hidden">
      <div class="page-turn-left"></div>
      <div class="page-turn-right"></div>
    </div>

    <!-- Main story content (hidden during cover) -->
    <div id="storyContent" class="story-content hidden">

    <div id="billingBanner" style="display:none;"></div>

    <!-- CORRECTIVE: Story start - title double size, Scene under synopsis -->
    <h2 id="storyTitle" style="font-size:3em; text-align:center; margin-bottom:10px;"></h2>
    <p id="storySynopsis" style="color:var(--gold); font-style:italic; margin-bottom:10px; text-align:center;"></p>
    <div id="sceneNumber" style="font-size:2em; color:var(--gold); font-weight:bold; text-align:center; margin:0 0 20px;">Scene 1</div>
    
    <div id="batedBreathIndicator" class="hidden" style="text-align:center; font-size:0.8em; color:var(--gold); font-style:italic; margin-bottom:10px; opacity:0.8;">
        Waiting for partner... 
        <button id="btnAbandonCouple" style="background:none; border:none; text-decoration:underline; color:var(--pink); cursor:pointer; padding:0; font-size:inherit; margin-left:5px;">Play Solo (Revoke Invite)</button>
    </div>

    <div id="settingShotWrap">
        <div id="settingError" class="img-error-msg hidden"></div>
        <img id="settingShotImg" src="" alt="Setting" style="display:none; width:100%;">
    </div>

    <div id="storyText" class="box">
        <div class="story-pages-container" id="storyPagesContainer"></div>
    </div>

    <div class="page-nav-controls" id="pageNavControls">
        <button class="page-nav-btn" id="prevPageBtn" disabled>
            <span>←</span> Previous
        </button>
        <span class="page-indicator" id="pageIndicator">Page 1 of 1</span>
        <button class="page-nav-btn" id="nextPageBtn" disabled>
            Next <span>→</span>
        </button>
    </div>

    <div style="text-align:center; margin-bottom:10px;">
        <button id="vizSceneBtn" onclick="window.visualize()" style="font-size:0.9em; background:#444;">✨ Visualize This Scene</button>
    </div>
    
    <div id="metaControls" class="hidden" style="margin: 10px auto; padding: 10px; border: 1px dashed var(--gold); border-radius: 8px; max-width: 600px;">
      <div style="font-size: 0.8em; color: var(--gold); margin-bottom: 5px;">CHARACTERS REACT TO FATE (Meta System)</div>
      <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 5px;">
        <button class="small-btn meta-stance" onclick="window.setMetaStance('aid')">Aid Fate</button>
        <button class="small-btn meta-stance" onclick="window.setMetaStance('rebel')">Resist Fate</button>
        <button class="small-btn meta-stance" onclick="window.setMetaStance('seduce')">Tempt Fate</button>
      </div>
    </div>

    <div id="fateCardHeader" class="section-title" style="font-size:1.8em; margin-top:0; display:flex; justify-content:center;">Let Fate Guide You</div>

    <div style="display:flex; align-items:flex-start; gap:20px; justify-content:center;">
        <!-- CORRECTIVE: Restored "Your Chosen Fate:" text -->
        <div id="yourChoiceLabel" class="hidden" style="font-size:1.1em; color:var(--gold); font-style:italic; padding-top:20px; white-space:nowrap;">Your Chosen Fate:</div>
        <div id="cardMount" class="fate-grid"></div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
      <div class="input-wrapper" id="actionWrapper">
          <label>What do you do?</label>
          <textarea id="actionInput" rows="3" placeholder="Action..."></textarea>
      </div>
      <div class="input-wrapper" id="dialogueWrapper">
          <label>What do you say?</label>
          <textarea id="dialogueInput" rows="3" placeholder="Dialogue..."></textarea>
      </div>
    </div>

    <div class="intensity-mini" id="gameIntensity">
        <button onclick="window.setGameIntensity('Clean')">Clean</button>
        <button onclick="window.setGameIntensity('Naughty')" class="active">Naughty</button>
        <button onclick="window.setGameIntensity('Erotic')">Erotic</button>
        <button onclick="window.setGameIntensity('Dirty')">Dirty</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; align-items:center;">
       <button id="saveBtn" class="small-btn locked-style" onclick="window.showPaywall('unlock')">Save</button>
       <button id="submitBtn" style="font-size:1.3em;">Submit Turn</button>
    </div>
    
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
       <button id="gameControlsBtn" class="small-btn">Quill & Veto</button>
       <button id="edgeCovenantBtn" class="small-btn" onclick="window.openEdgeCovenantModal()">Edge Covenant</button>
    </div>

  </div>

    </div><!-- END storyContent -->

  <div id="toast" class="toast hidden">Boundaries redirected the scene.</div>

<div id="gameQuillVetoModal" class="overlay hidden" style="z-index:10004;">
  <div class="box" style="max-width:90vw; width:700px; text-align:left;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div class="qv-section">
            <label class="qv-label" style="display:block; margin-bottom:8px;">Veto</label>
            <p class="qv-hint-above" style="font-size:0.85em; opacity:0.8; margin-bottom:10px;">Block elements you never want to appear.</p>
            <!-- CORRECTIVE: Show committed veto entries in game modal -->
            <div id="gameVetoCommitted" class="committed-phrases" style="margin-bottom:10px;"></div>
            <div class="fate-input-row" style="margin-bottom:10px;">
                <div class="input-wrapper fate-input-wrapper" style="flex:1;">
                    <textarea id="gameVetoInput" rows="3" class="fate-field" data-fate-type="veto" placeholder=""></textarea>
                    <div class="rotating-placeholder" data-for="gameVetoInput"></div>
                </div>
            </div>
            <div class="veto-ui" style="display:flex; align-items:center; justify-content:flex-end;">
                <button id="btnGameCommitVeto" class="small-btn" style="padding:6px 12px; font-size:0.85em;">Commit Veto</button>
            </div>
        </div>

        <div class="qv-section">
            <label class="qv-label" style="display:block; margin-bottom:8px;">Quill</label>
            <p class="qv-hint-above" style="font-size:0.85em; opacity:0.8; margin-bottom:10px;">Steer tone, boundaries, or direction.</p>
            <div class="fate-input-row" style="margin-bottom:10px;">
                <div id="gameQuillBox" class="input-wrapper fate-input-wrapper" style="flex:1;">
                    <textarea id="gameQuillInput" rows="3" class="fate-field" data-fate-type="quill" placeholder=""></textarea>
                    <div class="rotating-placeholder" data-for="gameQuillInput"></div>
                </div>
            </div>
            <div class="quill-ui" style="display:flex; align-items:center; justify-content:space-between;">
                <span id="gameQuillStatus" style="font-size:0.9em;">Quill: Poised</span>
                <button id="btnGameCommitQuill" class="small-btn" style="padding:6px 12px; font-size:0.85em;">Commit Quill</button>
            </div>
        </div>
    </div>

    <div style="text-align:center; margin-top:20px;">
        <button onclick="document.getElementById('gameQuillVetoModal').classList.add('hidden')" style="background:#444;">Close</button>
    </div>
  </div>
</div>

<div id="edgeCovenantModal" class="overlay hidden" style="z-index:10005;">
  <div class="box" style="max-width:500px; text-align:center;">
    <h3 style="color:var(--pink)">The Covenant</h3>
    <p style="font-size:0.9em; opacity:0.9; line-height:1.5; margin-bottom:20px;">
      This option allows a more intense, commanding tone between characters—like dark-romance tension—while keeping clear boundaries. You can pause, soften, or stop at any time. Safewords are always honored instantly.
    </p>
    
    <div id="edgeActions">
        <button id="btnInviteEdge" onclick="window.inviteEdgeOffer()">Invite In-Story Offer</button>
        <div style="margin-top:10px; font-size:0.8em; opacity:0.6;">(If Solo/NPC play)</div>
        
        <div id="coupleEdgeControls" class="hidden" style="margin-top:20px; border-top:1px solid #444; padding-top:15px;">
            <p>Offer this dynamic to your partner?</p>
            <button onclick="window.sendEdgeOffer()">Send Offer</button>
        </div>
    </div>

    <div id="edgeAcceptance" class="hidden">
        <p style="font-style:italic; color:var(--gold); margin-bottom:20px;">
            "Accepting means your character consents to a more intense dynamic—stronger pressure, firmer guidance, and heightened tension—within your chosen intensity setting. You can stop or renegotiate at any time."
        </p>
        <button onclick="window.acceptEdgeCovenant()">I’m not afraid to enter your world.</button>
        <button onclick="window.closeEdgeModal()" style="background:#444; margin-top:10px;">Not like this.</button>
    </div>

    <button onclick="window.closeEdgeModal()" style="background:transparent; border:none; color:#aaa; margin-top:20px; font-size:0.8em; cursor:pointer;">Close</button>
  </div>
</div>

</div>

<script src="fatecards.js"></script>
<script src="orchestration-client.js"></script>
<script src="app.js"></script>
</body>
</html>
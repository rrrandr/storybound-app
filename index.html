// --- GAME START (Patched with Debugging) ---
  $('beginBtn').onclick = async function(){
    hideAll();
    $('app').classList.remove('hidden');
    $('setup').classList.add('hidden');
    $('game').classList.remove('hidden');
    window.scrollTo(0,0);
    
    $('storyTitle').textContent = "Loading...";
    $('storySynopsis').textContent = "Consulting the oracle...";
    $('loadingOverlay').classList.remove('hidden');

    // 1. Construct Payload
    var payload = {
        phase: 'begin',
        tier: state.tier,
        genre: state.picks.genre,
        dynamic: state.picks.dynamic,
        pov: state.picks.pov,
        // Ensure style is a string for the prompt
        style: Array.isArray(state.picks.style) ? state.picks.style.join(', ') : state.picks.style
    };

    console.log("[Storybound Debug] Begin Request:", { url: API_STORY, payload: payload });

    try {
        // 2. Fetch
        var res = await fetch(API_STORY, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        // 3. Log Raw Response
        var rawText = await res.text();
        console.log("[Storybound Debug] Begin Response:", { status: res.status, raw: rawText });

        if(!res.ok) throw new Error(`HTTP ${res.status}: ${rawText}`);

        // 4. Parse & Update
        var data = JSON.parse(rawText); // Manual parse to catch errors
        
        $('storyTitle').textContent = data.title || "A Door With Teeth";
        $('storySynopsis').textContent = data.synopsis || "Generated synopsis...";
        $('storyText').innerHTML = data.story || "<p>Story text...</p>";

    } catch(e) {
        console.error("[Storybound Debug] Begin Failed:", e);
        
        // Fallback
        $('storyTitle').textContent = "A Door With Teeth";
        $('storySynopsis').textContent = "A breathless encounter...";
        var txt = "<p>The atmosphere thickened. Shadows lengthened across the floor as the silence between them grew heavy with unsaid things.</p>";
        txt += "<p>He watched you from across the room, his gaze a physical weight. You knew you shouldn't be here—not with him, not after everything that happened—but the pull was undeniable.</p>";
        txt += "<p>'You came back,' he said, his voice low and rough, like gravel over velvet. 'I didn't think you would dare.'</p>";
        txt += "<p>You stepped forward, your heart hammering a frantic rhythm against your ribs. 'I had to know,' you whispered. 'I had to know if it was real.'</p>";
        $('storyText').innerHTML = txt;
        
        // Visible Error for Debugging (remove later)
        var errNote = document.createElement('p');
        errNote.style.color = 'red';
        errNote.style.fontSize = '0.8em';
        errNote.textContent = "Debug Note: Proxy failed. Check Console (F12). Error: " + e.message;
        $('storyText').appendChild(errNote);
    }

    $('loadingOverlay').classList.add('hidden');
    if(window.StoryboundCards) window.StoryboundCards.mount({ mountId:'cardMount', dialogueId:'dialogueInput', actionId:'actionInput' });
  };

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storybound</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@300;400&family=Playfair+Display:wght@400;700&family=Open+Sans:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@400;700&family=Allura&family=Glass+Antiqua&family=Eagle+Lake&family=Smooch+Sans:wght@300;500&family=Pinyon+Script&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://use.typekit.net/bzl3zth.css">

  <link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="auth-panel" class="hidden">
  <input id="auth-email" placeholder="Email" />
  <input id="auth-password" type="password" placeholder="Password" />
  <button id="btn-signin">Sign in</button>
  <div id="auth-status"></div>
</div>

<button id="burgerBtn">‚ò∞</button>
<button id="globalBackBtn" class="hidden" style="position:fixed; top:15px; left:15px; z-index:5000; background:none; border:none; font-size:1.5em; cursor:pointer;">‚Üê</button>

<div id="menuOverlay" class="overlay hidden" style="z-index:4999;">
  <div class="box">
    <h3>Menu</h3>
    <button onclick="window.restart()">Restart Story</button>
    <button onclick="window.changeTier()">Change Tier</button>
    <button id="continueStoryBtn" class="hidden" onclick="window.continueStory()">Continue Saved Story</button>
    <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
    
    <label class="setting-label">Theme</label>
    <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap; margin-bottom:15px;">
        <button class="small-btn" onclick="setTheme('default')">Default</button>
        <button class="small-btn" onclick="setTheme('sepia')">Sepia</button>
        <button class="small-btn" onclick="setTheme('midnight')">Midnight</button>
        <button class="small-btn" onclick="setTheme('print')">Print</button>
        <button class="small-btn" onclick="setTheme('easy')">Easy</button>
    </div>

    <label class="setting-label">Font</label>
    <select id="fontSelect" onchange="setFont(this.value)" style="margin-bottom:15px; width:100%;">
        <option value="'Lora', serif">Lora (Default)</option>
        <option value="'Grenze Gotisch', cursive">Grenze Gotisch</option>
        <option value="'Allura', cursive">Allura</option>
        <option value="'Glass Antiqua', cursive">Glass Antiqua</option>
        <option value="'Eagle Lake', cursive">Eagle Lake</option>
        <option value="'Smooch Sans', sans-serif">Smooch Sans</option>
        <option value="'Pinyon Script', cursive">Pinyon Script</option>
        <option value="'Merriweather', serif">Merriweather</option>
        <option value="'Roboto', sans-serif">Roboto</option>
    </select>

    <label class="setting-label">Font Size</label>
    <input type="range" min="16" max="72" value="18" oninput="setFontSize(this.value)">

    <br><br>
    <button onclick="document.getElementById('menuOverlay').classList.add('hidden')" style="background:#444">Close</button>
  </div>
</div>

<div id="loadingOverlay" class="overlay hidden" style="z-index:9000;">
  <div id="loadingOverlayInner">
    <div id="loadingText">Stoking the embers...</div>
    <div id="loadingOverlayBar"><div id="loadingOverlayFill"></div></div>
  </div>
</div>

<div id="vizModal" class="overlay hidden">
  <div class="box viz-modal-content">
    <h3>Visualization</h3>
    <textarea id="vizPromptInput" placeholder="Prompt will appear here..."></textarea>
    <div id="vizPlaceholder">Generating...</div>
    
    <div id="vizImgContainer">
        <img id="vizPreviewImg" alt="Scene" style="display:none">
        <div id="vizError" class="img-error-msg hidden"></div>
    </div>

    <div class="viz-controls">
        <select id="vizModel">
            <option value="auto">Auto (Best Available)</option>
            <option value="grok-2-image-1212">Grok 2</option>
            <option value="gpt-image-1">OpenAI (GPT Image)</option>
            <option value="dall-e-3">OpenAI (DALL-E 3)</option>
        </select>
        <button class="small-btn" id="vizRetryBtn" onclick="window.visualize(true)">Re-Visualize</button>
        <button onclick="window.insertImage()">Insert</button>
        <button class="small-btn" style="background:#555" onclick="window.closeViz()">Cancel</button>
    </div>
  </div>
</div>

<div id="eroticPreviewModal" class="overlay hidden" style="z-index:10001;">
  <div class="box" style="max-width:500px;">
    <h3 style="color:var(--hot)">Erotic Intensity Preview</h3>
    <p style="opacity:0.8; font-size:0.9em;">Explicit content enabled. Sample:</p>
    <div id="eroticPreviewText"></div>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
        <button onclick="window.showPaywall('unlock');">Unlock Erotic ($1)</button>
        <button onclick="document.getElementById('eroticPreviewModal').classList.add('hidden')" style="background:#444">Not Now</button>
    </div>
  </div>
</div>

<div id="coupleInvite" class="overlay hidden">
  <div class="box" style="max-width:520px; text-align:center;">
    <h3>Open a Private Chamber</h3>

    <div class="couple-status-box">
      <div><strong>Your nickname:</strong> <span id="sbNickLabel" style="color:var(--gold)">‚Ä¶</span></div>
      <div><strong>Status:</strong> <span id="coupleStatus" style="font-style:italic">Not connected</span></div>
      <div><strong>Room Code:</strong> <span id="coupleRoomCodeLabel" style="font-family:monospace; color:var(--pink)">‚Äî</span></div>
    </div>

    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
      <button id="btnCreateRoom">Create Room</button>
      <button id="btnJoinRoom" style="background:#444">Join Room</button>
    </div>

    <div id="joinRow" class="hidden" style="margin-bottom:15px; display:flex; gap:10px; justify-content:center;">
      <input id="joinCodeInput" placeholder="Enter 6-char Code" style="text-transform:uppercase; text-align:center; width:150px;">
      <button id="btnJoinGo">Enter</button>
    </div>

    <div id="roomCodeWrap" class="hidden" style="margin-bottom:15px;">
      <p style="margin:0 0 5px; font-size:0.9em; opacity:0.8;">Share this code with your partner:</p>
      <div id="coupleRoomCodeWrap">
         <div id="roomCodeBig">‚Äî</div>
         <button id="btnCopyCode" title="Copy Code">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
         </button>
      </div>
    </div>

    <div>
      <button id="btnEnterCoupleGame" class="hidden" style="width:100%; margin-bottom:10px;">Enter Together</button>
      <button onclick="window.coupleCleanup(); window.showScreen('modeSelect')" style="background:transparent; border:1px solid #444; font-size:0.9em;">Back</button>
    </div>
  </div>
</div>

<div id="coupleConsentModal" class="overlay hidden">
  <div class="box" style="max-width:450px; text-align:center;">
    <h3 style="color:var(--gold);">Shared Intensity Agreement</h3>
    <p>You are entering a shared hallucination. Before you begin:</p>
    <ul style="text-align:left; font-size:0.9em; line-height:1.5; color:var(--ink); margin: 20px auto; max-width: 350px;">
        <li><strong>Intensity is a hard ceiling.</strong> Limits depictions regardless of input.</li>
        <li><strong>Inputs are requests.</strong> Naughty reinterprets explicit inputs as tension.</li>
        <li><strong>Upgrades required.</strong> Higher intensity requires appropriate tier.</li>
    </ul>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button id="btnCoupleAgree">Agree & Enter</button>
        <button onclick="window.showScreen('setup'); document.getElementById('coupleConsentModal').classList.add('hidden');" style="background:#444">Change Settings</button>
    </div>
  </div>
</div>

<div id="strangerModal" class="overlay hidden">
  <div class="box">
    <h3>How Daring...</h3>
    <p><span id="strangerCount">12,408</span> others are seeking a connection right now.</p>
    <p style="font-style:italic; color:var(--gold)">Matching is currently unavailable in this version.</p>
    <button onclick="window.showScreen('modeSelect')" style="background:#444">Return</button>
  </div>
</div>

<div id="ageGate" class="screen overlay" style="background:#000; z-index:9999;">
  <div style="text-align:center;">
      <h2>Storybound</h2>
      <p style="font-size:1.2em; max-width:500px; margin:20px;">Explicit adult themes. 18+ Only.</p>
      <button id="ageYes">I am 18+</button>
      <button onclick="location.href='https://google.com'" style="background:#333">Exit</button>
  </div>
</div>

<div id="tosGate" class="screen overlay hidden" style="background:#000; z-index:9998;">
  <div class="box" style="text-align:center;">
      <h2>Terms of Service</h2>
      <div class="tos-box">
        <p><strong>TERMS OF SERVICE</strong></p>
        <p>1. <strong>Age Requirement:</strong> You must be 18+.</p>
        <p>2. <strong>Content Policy:</strong> Adult fantasy roleplay only. Content must be consensual. Optional power play is permitted only if explicitly opted-in. No non-consensual sexual acts, sexual violence, or minors.</p>
        <p>3. <strong>Data & AI:</strong> Content generated by third-party AI models. We may anonymize data.</p>
        <p>4. <strong>Liability:</strong> Use at your own risk. Entertainment purposes only.</p>
      </div>
      <label><input type="checkbox" id="tosCheck"> I agree to the Terms</label>
      <br>
      <button id="tosBtn" disabled>Enter Storybound</button>
  </div>
</div>

<div id="tierGate" class="screen overlay hidden" style="background:#000; z-index:9997;">
  <div style="text-align:center;">
      <h2>Storybound</h2>
      <div class="choice-buttons">
        <div style="text-align:center">
          <button class="choice" id="btnTease">Tease</button>
          <p class="choice-desc">A playful warmup‚Äîgentle choices, tension, and atmosphere.<br><br><strong>From $Free</strong></p>
        </div>
        <div style="text-align:center">
          <button class="choice" id="btnIndulge">Indulge</button>
          <p class="choice-desc">Longer openings, deeper memory, full control, saved stories.<br><br><strong>From $6/mo</strong></p>
        </div>
      </div>
      <button id="continueFromTierBtn" class="choice hidden" style="margin-top:20px; width:80%; max-width:300px;" onclick="window.continueStory()">Continue Saved Story</button>
  </div>
</div>

<div id="payModal" class="overlay hidden" style="z-index:10000;">
  <div class="box" style="text-align:center; max-width: 500px;">
    <h3>Unshackle Your Fate</h3>
    
    <div id="godModePay" class="hidden">
       <h4 style="color:var(--gold); margin-top:0; font-size:1.4em;">Unlock God Mode</h4>
       <p style="font-size:0.9em; opacity:0.8; margin-bottom:20px;">
         Sandbox power. No cooldowns. No safety.
         <br><strong>$50 One-time purchase.</strong>
       </p>
       <button id="payGodMode" style="width:100%; margin-top:10px; background:var(--gold); color:black;">Unlock Forever ($50)</button>
    </div>

    <div id="standardPay">
        <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin:20px 0;">
            <div id="optUnlock" class="hidden" style="background:#222; padding:15px; border-radius:10px; border:1px solid #ff69b4; width:220px; text-align:left;">
                <h4 style="color:var(--pink); margin-top:0;">Unlock This Story</h4>
                <p style="font-size:0.9em; line-height:1.4;">Go deeper for this one arc.<br>Erotic intensity, longer pacing, and control.<br><strong>$3 Story Pass.</strong></p>
                <button id="payOneTime" style="width:100%; margin-top:15px;">Unlock ($3)</button>
            </div>

            <div id="optSub" style="background:linear-gradient(145deg, #400020, #200010); padding:15px; border-radius:10px; border:1px solid gold; width:220px; text-align:left;">
                <h4 style="color:var(--gold); margin-top:0;">Indulge Limits</h4>
                <ul style="font-size:0.85em; padding-left:15px; opacity:0.9; line-height:1.4; list-style-type: '‚öú ';">
                    <li>Dirty intensity</li>
                    <li>Long-form stories (Affair/Soulmates)</li>
                    <li>Save & return anytime</li>
                    <li>Cancel anytime</li>
                </ul>
                <div style="text-align:center; font-size:0.9em; margin:15px 0; color:var(--gold);">$6/month</div>
                <button id="paySub" style="width:100%; background:linear-gradient(145deg, gold, #b8860b); color:black; font-weight:bold;">Subscribe</button>
            </div>
        </div>
    </div>
    
    <button onclick="document.getElementById('payModal').classList.add('hidden')" style="background:#444; margin-top:15px;">Cancel</button>
  </div>
</div>

<div id="previewModal" class="overlay hidden" style="z-index:5000;">
  <div class="box">
    <p id="previewText" style="font-size:1.3em; font-style:italic; line-height:1.6"></p>
    <button onclick="document.getElementById('previewModal').classList.add('hidden')">Close</button>
  </div>
</div>

<div id="app" class="hidden">

  <div id="modeSelect" class="screen">
    <h1 style="margin-top:40px">Storybound</h1>
    
    <div class="choice-buttons">
      <div style="text-align:center">
          <button class="choice" onclick="window.setMode('solo')">Solo</button>
          <p class="choice-desc">Your private laboratory‚Äîintentional, charged.</p>
      </div>
      <div style="text-align:center">
          <button class="choice" id="btnCoupleMode" onclick="window.setMode('couple')">Couple</button>
          <p class="choice-desc">Link devices and co-create a shared seduction.</p>
      </div>
      <div style="text-align:center">
          <button class="choice" onclick="window.setMode('stranger')">Stranger</button>
          <p class="choice-desc">Tempt fate with a random encounter.</p>
      </div>
    </div>
  </div>

  <div id="setup" class="screen hidden" style="max-width:800px; margin:0 auto; padding-bottom:50px;">
    
    <div class="section-title">Shape Your Story</div>
    
    <div class="input-wrapper">
        <label>Your Character's Name</label>
        <input id="playerNameInput" type="text" placeholder="e.g. Elara Vance">
    </div>

    <div class="input-wrapper">
        <label>Your Love Interest's Name</label>
        <input id="partnerNameInput" type="text" placeholder="e.g. Lord Blackwood">
    </div>
    
    <div class="grid-2-col">
        <div>
            <label>Your Gender</label>
            <select id="playerGender" onchange="checkCustom(this, 'customPlayerGender')">
                <option value="Female">Female</option>
                <option value="Male">Male</option>
                <option value="Non-Binary">Non-Binary</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customPlayerGender" type="text" placeholder="Enter gender..." class="hidden" style="margin-top:5px;">
            
            <label style="margin-top:10px;">Pronouns</label>
            <select id="playerPronouns" onchange="checkCustom(this, 'customPlayerPronouns')">
                <option value="She/Her">She/Her</option>
                <option value="He/Him">He/Him</option>
                <option value="They/Them">They/Them</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customPlayerPronouns" type="text" placeholder="Enter pronouns..." class="hidden" style="margin-top:5px;">
        </div>

        <div>
            <label>Love Interest Gender</label>
            <select id="loveInterestGender" onchange="checkCustom(this, 'customLoveInterest')">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Non-Binary">Non-Binary</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customLoveInterest" type="text" placeholder="Enter gender..." class="hidden" style="margin-top:5px;">
            
            <label style="margin-top:10px;">Pronouns</label>
            <select id="lovePronouns" onchange="checkCustom(this, 'customLovePronouns')">
                <option value="He/Him">He/Him</option>
                <option value="She/Her">She/Her</option>
                <option value="They/Them">They/Them</option>
                <option value="Custom">Custom</option>
            </select>
            <input id="customLovePronouns" type="text" placeholder="Enter pronouns..." class="hidden" style="margin-top:5px;">
        </div>
    </div>

    <div class="section-title">Safety & Boundaries</div>
    <div class="consent-controls">
        <label><input type="checkbox" id="chkDark" checked> Dark Themes Allowed</label>
        <label><input type="checkbox" id="chkNonCon"> Non-consent themes (IMPLIED ONLY)</label>
        <label><input type="checkbox" id="chkViolence" checked> Violence / Peril</label>
    </div>
    <div class="boundary-chips" id="boundaryChips">
        <div class="chip locked-chip active" title="Always enforced">No sexual violence</div>
        <div class="chip">No coercion</div>
        <div class="chip">No degradation language</div>
        <div class="chip">No captivity</div>
        <div class="chip">No blackmail</div>
    </div>

    <div class="section-title">Intensity <span class="instruction-text">(Rendering Ceiling)</span></div>
    <div id="intensityBtns" class="intensity-wrap">
      <button data-val="Clean" class="intensity-btn" data-desc="Romantic, non-explicit.">Clean</button>
      <button data-val="Naughty" class="intensity-btn active" data-desc="Suggestive tension; no explicit anatomy.">Naughty</button>
      <button data-val="Erotic" class="intensity-btn locked-tease" data-desc="Explicit sex; adult consensual.">Erotic</button>
      <button data-val="Dirty" class="intensity-btn locked-pass" data-desc="Very explicit; highest intensity.">Dirty</button>
    </div>
    <p id="intensityDesc" style="color:var(--gold); font-style:italic; margin-top:10px; min-height:40px;">
        (Naughty) Suggestive tension; no explicit anatomy.
    </p>
    
    <label style="font-size:0.85em; color:var(--gold); opacity:0.8; display:flex; align-items:center; justify-content:center; gap:8px; margin-top:5px; cursor:pointer;">
        <input type="checkbox" id="chkAutoLockVisual" checked> 
        Lock character look after first Visualize
    </label>

    <div id="lengthSection">
        <div class="section-title">Story Length</div>
        <p class="subtitle">Choose once. This shapes pacing and endings.</p>
        
        <div class="style-cards" id="lengthGrid">
          <div class="card selected" data-grp="length" data-val="voyeur">
            <h3>Voyeur Tease</h3>
            <p>A front-row seat. No touching. Ends right when you lean in.</p>
          </div>

          <div class="card locked" data-grp="length" data-val="fling" data-locked="pass">
            <h3>Fling</h3>
            <p>You get to get off, but you don‚Äôt get to finish.</p>
          </div>

          <div class="card locked" data-grp="length" data-val="affair" data-locked="sub">
            <h3>Affair</h3>
            <p>Longer nights, deeper consequences. Arcs unfold. Nothing is rushed.</p>
          </div>

          <div class="card locked" data-grp="length" data-val="soulmates" data-locked="sub">
            <h3>Soulmates</h3>
            <p>This isn‚Äôt about what happens next. It‚Äôs about what keeps happening.</p>
          </div>
        </div>
    </div>

    <div class="section-title">Genres <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="genreGrid">
      <div class="card" data-grp="genre" data-val="Romantasy"><h3>Romantasy</h3><p>High fantasy worlds, magic, and intense romantic stakes.</p></div>
      <div class="card" data-grp="genre" data-val="Contemporary"><h3>Contemporary Romance</h3><p>Modern settings and present-day relationships.</p></div>
      <div class="card" data-grp="genre" data-val="Historical"><h3>Historical Romance</h3><p>Period romance and forbidden rules.</p></div>
      <div class="card" data-grp="genre" data-val="Paranormal"><h3>Paranormal Modern Romance</h3><p>Vampires, shifters, witches in today‚Äôs world.</p></div>
      <div class="card" data-grp="genre" data-val="Dark"><h3>Dark Romance</h3><p>Morally gray heat; player defines boundaries.</p></div>
      <div class="card" data-grp="genre" data-val="Suspense"><h3>Romantic Suspense</h3><p>Romance entangled with danger and mystery.</p></div>
      <div class="card" data-grp="genre" data-val="Sports"><h3>Sports Romance</h3><p>Athletes and competitive tension.</p></div>
      <div class="card" data-grp="genre" data-val="Crime"><h3>Organized Crime Romance</h3><p>Forbidden love in criminal worlds.</p></div>
    </div>
    
    <button class="small-btn" onclick="document.getElementById('moreGenres').classList.toggle('hidden')">More Genres</button>
    <div id="moreGenres" class="style-cards hidden">
       <div class="card" data-grp="genre" data-val="Billionaire"><h3>Billionaire Romance</h3><p>Ultra-wealthy leads, power, polish.</p></div>
       <div class="card" data-grp="genre" data-val="Gothic"><h3>Gothic Romance</h3><p>Moody, haunted settings.</p></div>
       <div class="card" data-grp="genre" data-val="LGBTQ"><h3>Queer LGBTQ+</h3><p>Inclusive love stories.</p></div>
       <div class="card" data-grp="genre" data-val="SecondChance"><h3>Second Chance</h3><p>Ex-lovers reunited with baggage.</p></div>
       <div class="card" data-grp="genre" data-val="SmallTown"><h3>Small Town</h3><p>Cozy community vibes.</p></div>
       <div class="card" data-grp="genre" data-val="Romcom"><h3>Romantic Comedy</h3><p>Bantery, light chaos.</p></div>
    </div>

    <div class="section-title">Dynamics <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="dynamicGrid">
      <div class="card" data-grp="dynamic" data-val="Enemies"><h3>Enemies ‚Üí Lovers</h3><p>Rivals whose friction turns to heat.</p></div>
      <div class="card" data-grp="dynamic" data-val="Forbidden"><h3>Forbidden Love</h3><p>Desire under rules and taboo.</p></div>
      <div class="card" data-grp="dynamic" data-val="Power"><h3>Power Imbalance</h3><p>Player defines boundaries and limits.</p></div>
      <div class="card" data-grp="dynamic" data-val="SlowBurn"><h3>Slow Burn</h3><p>High restraint, earned payoff.</p></div>
      <div class="card" data-grp="dynamic" data-val="Friends"><h3>Friends ‚Üí Lovers</h3><p>Safety tipping into heat.</p></div>
      <div class="card" data-grp="dynamic" data-val="Proximity"><h3>Forced Proximity</h3><p>Close quarters, rising tension.</p></div>
      <div class="card" data-grp="dynamic" data-val="Secret"><h3>Secret Identity</h3><p>Truths revealed at the worst time.</p></div>
      <div class="card" data-grp="dynamic" data-val="Obsessive"><h3>Obsessive Devotion</h3><p>Intense focus, player sets bounds.</p></div>
      <div class="card" data-grp="dynamic" data-val="Fated"><h3>Fated Mates / Soulbond</h3><p>Destined bond, fast intensity.</p></div>
      <div class="card" data-grp="dynamic" data-val="Caretaker"><h3>Caretaker / Wounded One</h3><p>Vulnerability and steady support.</p></div>
    </div>

    <div class="section-title">Story POV</div>
    <div class="style-cards" id="povGrid">
      <div class="card selected" data-grp="pov" data-val="First"><h3>1st Person (I)</h3><p>Intimate, confessional, inside your pulse.</p><button class="preview-btn" data-txt="I held my breath as the door clicked shut behind him.">Preview</button></div>
      <div class="card" data-grp="pov" data-val="Second"><h3>2nd Person (You)</h3><p>Immediate, immersive, hands-on tension.</p><button class="preview-btn" data-txt="You feel the room shift the moment he looks at you.">Preview</button></div>
      <div class="card" data-grp="pov" data-val="Third"><h3>3rd Person (They)</h3><p>Wider lens, cinematic, controlled heat.</p><button class="preview-btn" data-txt="He kept his voice calm, but the way his gaze lingered betrayed the hunger.">Preview</button></div>
      <div class="card" data-grp="pov" data-val="Fourth"><h3>4th Person (We)</h3><p>Choral, conspiratorial, shared gaze.</p><button class="preview-btn" data-txt="We watched them circle each other‚Äîtwo storms pretending to be weather.">Preview</button></div>
      <div class="card" data-grp="pov" data-val="Fifth"><h3>5th Person (Author)</h3><p>Playful narrator with a hand on the page.</p><button class="preview-btn" data-txt="The Author hesitated‚Äîthen smiled‚Äîand offered them a door.">Preview</button></div>
    </div>

    <div class="section-title">Story Style <span class="instruction-text">(Select up to 3)</span></div>
    <div class="style-cards" id="styleGrid">
      <div class="card selected" data-grp="style" data-val="Breathless"><h3>Breathless Romance</h3><p>Fast tension, close POV, lush romantic heat.</p><button class="preview-btn" data-txt="His attention was a slow hand. It didn‚Äôt touch her‚Äîyet she felt it everywhere.">Preview</button></div>
      <div class="card locked" data-grp="style" data-val="Epic" data-locked="true"><h3>Epic Fantasy</h3><p>Grand stakes, wonder, danger, sweeping romance.</p><button class="preview-btn" data-txt="The city burned like a crown‚Äîand someone inside it was waiting to claim her.">Preview</button></div>
      <div class="card locked" data-grp="style" data-val="Playful" data-locked="true"><h3>Playful Heat</h3><p>Flirty banter, teasing humor, spark-first chemistry.</p><button class="preview-btn" data-txt="‚ÄúYou‚Äôre staring.‚Äù ‚ÄúI‚Äôm appreciating.‚Äù">Preview</button></div>
      <div class="card locked" data-grp="style" data-val="Dark" data-locked="true"><h3>Dark Desire</h3><p>Moody, dangerous tension with boundaries respected.</p><button class="preview-btn" data-txt="He smiled like a promise with teeth.">Preview</button></div>
      <div class="card locked" data-grp="style" data-val="Raw" data-locked="true"><h3>Raw Passion</h3><p>Direct emotion, embodied desire, grounded intensity.</p><button class="preview-btn" data-txt="He didn't ask twice.">Preview</button></div>
      <div class="card locked" data-grp="style" data-val="Regency" data-locked="true"><h3>Regency Restraint</h3><p>Polite knives, forbidden longing, exquisite restraint.</p><button class="preview-btn" data-txt="‚ÄúYour reputation is in danger,‚Äù she murmured.">Preview</button></div>
    </div>
    
    <button class="small-btn" onclick="document.getElementById('moreStyles').classList.toggle('hidden')">More Styles</button>
    <div id="moreStyles" class="style-cards hidden">
       <div class="card locked" data-grp="style" data-val="Wry" data-locked="true"><h3>Wry Confession</h3><p>Dry wit, sharp honesty, intimate tension.</p><button class="preview-btn" data-txt="She lied. He admired it.">Preview</button></div>
       <div class="card locked" data-grp="style" data-val="Strategic" data-locked="true"><h3>Strategic Intensity</h3><p>Calculated seduction, power games.</p><button class="preview-btn" data-txt="Silence did the flirting.">Preview</button></div>
       <div class="card locked" data-grp="style" data-val="Surreal" data-locked="true"><h3>Surreal Bloom</h3><p>Dreamlike imagery, symbolic heat.</p><button class="preview-btn" data-txt="The candles leaned in to listen.">Preview</button></div>
       <div class="card locked" data-grp="style" data-val="Brutal" data-locked="true"><h3>Brutal Edge</h3><p>Blunt honesty, razor tension.</p><button class="preview-btn" data-txt="No soft words. Just truth.">Preview</button></div>
       <div class="card locked" data-grp="style" data-val="Satirical" data-locked="true"><h3>Satirical Fantasy</h3><p>Witty fantasy, playful stakes.</p><button class="preview-btn" data-txt="The prophecy was inconvenient.">Preview</button></div>
       <div class="card locked" data-grp="style" data-val="Shakespearean" data-locked="true"><h3>Shakespearean</h3><p>Elevated cadence, poetic desire.</p><button class="preview-btn" data-txt="Speak low, sweet peril.">Preview</button></div>
       <div class="card locked" data-grp="style" data-val="SciFi" data-locked="true"><h3>SciFi Opera</h3><p>Grand futuristic worlds, high stakes.</p><button class="preview-btn" data-txt="Stars like spilled ink.">Preview</button></div>
    </div>

    <div class="section-title">Quill & Veto</div>

    <div class="quill-veto-container">
        <div class="qv-section">
            <label class="qv-label">Veto</label>
            <p class="qv-hint-above">Block elements you never want to appear. Vetoes are immediate and permanent.</p>
            <div id="vetoPills" class="pill-tray"></div>
            <textarea id="vetoInput" rows="2" placeholder="ban: word&#10;rename: Old Name -> New Name&#10;no tattoos"></textarea>
            <p class="qv-hint-below">Vetoes remove content from consideration. They cannot start scenes or direct the story.</p>
        </div>

        <div class="qv-section">
            <label class="qv-label">Quill</label>
            <p class="qv-hint-above">Use the Quill to gently steer tone, boundaries, or direction without rewriting what's already happened.</p>
            <div id="quillPills" class="pill-tray"></div>
            <div id="quillBox" class="input-wrapper locked-input" onclick="window.showPaywall('unlock')">
                <textarea id="quillInput" rows="2" placeholder="Bring them to a moonlit garden..."></textarea>
            </div>
            <p class="qv-hint-below">Quill edits shape what follows and may persist. Each use exhausts the Quill, requiring time and words before it can be wielded again.</p>
        </div>
    </div>

    <div class="quill-ui">
        <div style="display:flex; width:100%; justify-content:space-between; margin-bottom:5px;">
            <span id="quillStatus">Quill: Poised</span>
            <button id="btnCommitQuill" class="small-btn" style="padding:4px 10px; font-size:0.85em; opacity:0.5;" disabled>Commit Quill</button>
        </div>
        <div id="godModeToggle" class="hidden">
            <label id="godModeLabel"><input type="checkbox" id="godModeCheck"> Enable God Mode (Sandbox)</label>
        </div>
    </div>

    <br>
    <button id="beginBtn" style="font-size:1.5em; margin-top:20px;">Begin Story</button>
  </div>

  <div id="game" class="screen hidden" style="max-width:900px; margin:0 auto; padding-bottom:60px;">
    
    <div id="billingBanner" style="display:none;"></div>

    <h2 id="storyTitle"></h2>
    <p id="storySynopsis" style="color:var(--gold); font-style:italic; margin-bottom:20px;"></p>
    
    <div id="batedBreathIndicator" class="hidden" style="text-align:center; font-size:0.8em; color:var(--gold); font-style:italic; margin-bottom:10px; opacity:0.8;">
        Waiting for partner... 
        <button id="btnAbandonCouple" style="background:none; border:none; text-decoration:underline; color:var(--pink); cursor:pointer; padding:0; font-size:inherit; margin-left:5px;">Play Solo (Revoke Invite)</button>
    </div>

    <div id="settingShotWrap">
        <div id="settingError" class="img-error-msg hidden"></div>
        <img id="settingShotImg" src="" alt="Setting" style="display:none; width:100%;">
    </div>

    <div id="storyText" class="box"></div>

    <div style="text-align:center; margin-bottom:10px;">
        <button onclick="window.visualize()" style="font-size:0.9em; background:#444;">‚ú® Visualize This Scene</button>
    </div>
    
    <div id="metaControls" class="hidden" style="margin: 10px auto; padding: 10px; border: 1px dashed var(--gold); border-radius: 8px; max-width: 600px;">
      <div style="font-size: 0.8em; color: var(--gold); margin-bottom: 5px;">CHARACTERS REACT TO FATE (Meta System)</div>
      <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 5px;">
        <button class="small-btn meta-stance" onclick="window.setMetaStance('aid')">Aid Fate</button>
        <button class="small-btn meta-stance" onclick="window.setMetaStance('rebel')">Resist Fate</button>
        <button class="small-btn meta-stance" onclick="window.setMetaStance('seduce')">Tempt Fate</button>
      </div>
    </div>

    <div class="section-title" style="font-size:1.8em; margin-top:0; display:flex; justify-content:center;">Let Fate Guide You</div>

    <div class="fate-tree-container">
        <svg id="fateTree" class="fate-tree" viewBox="0 0 60 80">
            <!-- Trunk -->
            <path class="fate-tree-trunk" d="M30 80 L30 45" />
            <!-- Left branches (side) -->
            <path class="fate-tree-branch" d="M30 65 L15 55" />
            <path class="fate-tree-branch" d="M15 55 L8 48" />
            <path class="fate-tree-branch" d="M15 55 L12 62" />
            <path class="fate-tree-branch" d="M30 55 L18 42" />
            <path class="fate-tree-branch" d="M18 42 L10 35" />
            <path class="fate-tree-branch" d="M18 42 L22 32" />
            <!-- Right branches (side) -->
            <path class="fate-tree-branch" d="M30 60 L45 50" />
            <path class="fate-tree-branch" d="M45 50 L52 42" />
            <path class="fate-tree-branch" d="M45 50 L48 58" />
            <path class="fate-tree-branch" d="M30 50 L42 38" />
            <path class="fate-tree-branch" d="M42 38 L50 30" />
            <path class="fate-tree-branch" d="M42 38 L38 28" />
            <!-- Top branches -->
            <path class="fate-tree-branch" d="M30 45 L25 30" />
            <path class="fate-tree-branch" d="M30 45 L35 32" />
            <path class="fate-tree-branch" d="M25 30 L20 18" />
            <path class="fate-tree-branch" d="M35 32 L40 20" />
            <!-- Falling leaf (starts on right side branch) -->
            <ellipse class="fate-leaf" cx="50" cy="30" rx="4" ry="6" />
        </svg>
    </div>

    <div id="cardMount" class="fate-grid"></div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
      <div class="input-wrapper" id="actionWrapper">
          <label>What do you do?</label>
          <textarea id="actionInput" rows="3" placeholder="Action..."></textarea>
      </div>
      <div class="input-wrapper" id="dialogueWrapper">
          <label>What do you say?</label>
          <textarea id="dialogueInput" rows="3" placeholder="Dialogue..."></textarea>
      </div>
    </div>

    <div class="intensity-mini" id="gameIntensity">
        <button onclick="window.setGameIntensity('Clean')">Clean</button>
        <button onclick="window.setGameIntensity('Naughty')" class="active">Naughty</button>
        <button onclick="window.setGameIntensity('Erotic')">Erotic</button>
        <button onclick="window.setGameIntensity('Dirty')">Dirty</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; align-items:center;">
       <button id="saveBtn" class="small-btn locked-style" onclick="window.showPaywall('unlock')">Save</button>
       <button id="submitBtn" style="font-size:1.3em;">Submit Turn</button>
    </div>
    
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
       <button id="gameControlsBtn" class="small-btn">Quill & Veto</button>
       <button id="edgeCovenantBtn" class="small-btn" onclick="window.openEdgeCovenantModal()">Edge Covenant</button>
    </div>

    <div id="gameQuillVetoPanel" class="quill-veto-container hidden" style="margin-top:15px;">
        <div class="qv-section">
            <label class="qv-label">Veto</label>
            <p class="qv-hint-above">Block elements from appearing. Always active.</p>
            <div id="gameVetoPills" class="pill-tray"></div>
            <textarea id="gameVetoInput" rows="2" placeholder="ban: word&#10;no tattoos"></textarea>
        </div>

        <div class="qv-section" id="gameQuillSection">
            <label class="qv-label">
                Quill
                <span id="gameQuillTreeIcon" class="quill-tree-icon" title="Unlock Quill">üå≥</span>
            </label>
            <p class="qv-hint-above">Steer tone and direction. Requires unlock.</p>
            <div id="gameQuillPills" class="pill-tray"></div>
            <div id="gameQuillBox" class="input-wrapper">
                <textarea id="gameQuillInput" rows="2" placeholder="Bring them somewhere private..."></textarea>
            </div>
            <div class="quill-ui" style="margin-top:8px;">
                <div style="display:flex; width:100%; justify-content:space-between;">
                    <span id="gameQuillStatus">Quill: Poised</span>
                    <button id="gameCommitQuill" class="small-btn" style="padding:4px 10px; font-size:0.85em;">Commit</button>
                </div>
            </div>
        </div>
    </div>

  </div>
  
  <div id="toast" class="toast hidden">Boundaries redirected the scene.</div>

<div id="edgeCovenantModal" class="overlay hidden" style="z-index:10005;">
  <div class="box" style="max-width:500px; text-align:center;">
    <h3 style="color:var(--pink)">The Covenant</h3>
    <p style="font-size:0.9em; opacity:0.9; line-height:1.5; margin-bottom:20px;">
      This option allows a more intense, commanding tone between characters‚Äîlike dark-romance tension‚Äîwhile keeping clear boundaries. You can pause, soften, or stop at any time. Safewords are always honored instantly.
    </p>
    
    <div id="edgeActions">
        <button id="btnInviteEdge" onclick="window.inviteEdgeOffer()">Invite In-Story Offer</button>
        <div style="margin-top:10px; font-size:0.8em; opacity:0.6;">(If Solo/NPC play)</div>
        
        <div id="coupleEdgeControls" class="hidden" style="margin-top:20px; border-top:1px solid #444; padding-top:15px;">
            <p>Offer this dynamic to your partner?</p>
            <button onclick="window.sendEdgeOffer()">Send Offer</button>
        </div>
    </div>

    <div id="edgeAcceptance" class="hidden">
        <p style="font-style:italic; color:var(--gold); margin-bottom:20px;">
            "Accepting means your character consents to a more intense dynamic‚Äîstronger pressure, firmer guidance, and heightened tension‚Äîwithin your chosen intensity setting. You can stop or renegotiate at any time."
        </p>
        <button onclick="window.acceptEdgeCovenant()">I‚Äôm not afraid to enter your world.</button>
        <button onclick="window.closeEdgeModal()" style="background:#444; margin-top:10px;">Not like this.</button>
    </div>

    <button onclick="window.closeEdgeModal()" style="background:transparent; border:none; color:#aaa; margin-top:20px; font-size:0.8em; cursor:pointer;">Close</button>
  </div>
</div>

</div>

<script src="fatecards.js"></script>
<script src="app.js"></script>
</body>
</html>
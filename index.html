<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storybound</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@300;400&family=Playfair+Display:wght@400;700&family=Open+Sans:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@400;700&family=Allura&family=Glass+Antiqua&family=Eagle+Lake&family=Smooch+Sans:wght@300;500&family=Pinyon+Script&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://use.typekit.net/bzl3zth.css">

  <link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="auth-panel" class="hidden">
  <input id="auth-email" placeholder="Email" />
  <input id="auth-password" type="password" placeholder="Password" />
  <button id="btn-signin">Sign in</button>
  <div id="auth-status"></div>
</div>

<button id="burgerBtn">‚ò∞</button>
<button id="globalBackBtn" class="hidden" style="position:fixed; top:15px; left:15px; z-index:5000; background:none; border:none; font-size:1.8em; cursor:pointer; padding:0; box-shadow:none; color:var(--pink); text-shadow:0 0 5px var(--hot);">‚Üê</button>

<div id="menuOverlay" class="overlay hidden" style="z-index:4999;">
  <div class="box">
    <h3>Menu</h3>
<div id="menuAuthSection"></div>

    <button onclick="window.restart()">Restart Story</button>
    <button onclick="window.changeTier()">Change Tier</button>
    <button id="continueStoryBtn" class="hidden" onclick="window.continueStory()">Continue Saved Story</button>
    <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
    
    <label class="setting-label">Theme</label>
    <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap; margin-bottom:15px;">
        <button class="small-btn" onclick="setTheme('default')">Default</button>
        <button class="small-btn" onclick="setTheme('sepia')">Sepia</button>
        <button class="small-btn" onclick="setTheme('midnight')">Midnight</button>
        <button class="small-btn" onclick="setTheme('print')">Print</button>
        <button class="small-btn" onclick="setTheme('easy')">Easy</button>
    </div>

    <label class="setting-label">Font</label>
    <select id="fontSelect" onchange="setFont(this.value)" style="margin-bottom:15px; width:100%;">
        <option value="'Lora', serif">Lora (Default)</option>
        <option value="'Grenze Gotisch', cursive">Grenze Gotisch</option>
        <option value="'Allura', cursive">Allura</option>
        <option value="'Glass Antiqua', cursive">Glass Antiqua</option>
        <option value="'Eagle Lake', cursive">Eagle Lake</option>
        <option value="'Smooch Sans', sans-serif">Smooch Sans</option>
        <option value="'Pinyon Script', cursive">Pinyon Script</option>
        <option value="'Merriweather', serif">Merriweather</option>
        <option value="'Roboto', sans-serif">Roboto</option>
    </select>

    <label class="setting-label">Font Size</label>
    <input type="range" min="16" max="72" value="18" oninput="setFontSize(this.value)">

    <br><br>
    <button onclick="document.getElementById('menuOverlay').classList.add('hidden')" style="background:#444">Close</button>
  </div>
</div>

<div id="loadingOverlay" class="overlay hidden" style="z-index:9000;">
  <div id="loadingOverlayInner">
    <button id="loadingCancelBtn" class="loading-cancel-btn" title="Cancel">&times;</button>
    <div id="loadingText">Stoking the embers...</div>
    <div id="loadingOverlayBar"><div id="loadingOverlayFill"></div></div>
    <div id="loadingPercent">0%</div>
  </div>
</div>

<div id="vizModal" class="overlay hidden">
  <div class="box viz-modal-content">
    <h3>Visualization</h3>
    <!-- CORRECTIVE: Explanatory copy for visualization -->
    <p style="font-size:0.85em; color:var(--gold); margin-bottom:10px; font-style:italic;">
        You may freely edit the prompt below. Images are limited to Naughty-level eroticism.
        Prompts are automatically scaled down to avoid artist refusal.
    </p>
    <textarea id="vizPromptInput" placeholder="Prompt will appear here..."></textarea>

    <!-- CORRECTIVE: Quick Prompt Modifier heading -->
    <h4 style="font-size:1.1em; color:var(--pink); margin:15px 0 5px; font-weight:bold;">Quick Prompt Modifier</h4>
    <!-- Modifier section: scrolling suggestions + text input -->
    <div id="vizModifierSection" class="fate-input-wrapper" style="margin-top:5px;">
        <input type="text" id="vizModifierInput" class="fate-field" placeholder="">
        <div class="rotating-placeholder" data-for="vizModifierInput"></div>
    </div>
    <!-- CORRECTIVE: Instructions for modifiers -->
    <p style="font-size:0.8em; color:#888; margin-top:5px; font-style:italic;">
        Type or select a modifier to adjust the image. Modifiers are appended to your prompt.
    </p>

    <!-- Credit display (always visible, numeric) -->
    <div id="vizCreditDisplay" style="font-size:0.85em; color:var(--gold); margin:10px 0; text-align:center;">
        Visualization credits = <span id="vizCreditCount">0</span>
    </div>

    <div id="vizPlaceholder" style="display:flex; align-items:center; justify-content:center; min-height:200px; color:#888; font-style:italic; text-align:center; padding:20px;">
        Earn 1 Visualization credit for every 3 Scenes you complete.
    </div>

    <div id="vizImgContainer">
        <img id="vizPreviewImg" alt="Scene" style="display:none">
        <div id="vizError" class="img-error-msg hidden"></div>
    </div>

    <div class="viz-controls">
        <select id="vizModel">
            <option value="gemini" selected>Gemini (Primary)</option>
            <option value="openai">OpenAI (Fallback)</option>
            <option value="replicate">Replicate FLUX</option>
        </select>
        <button class="small-btn" id="vizRetryBtn" onclick="window.handleReVisualize()">Re-Visualize</button>
        <button id="vizInsertBtn" onclick="window.insertImage()">Insert</button>
        <button class="small-btn" style="background:#555" onclick="window.closeViz()">Cancel</button>
    </div>
    <label class="sb-checkbox" style="font-size:0.8em; justify-content:center; margin-top:12px;">
        <input type="checkbox" id="chkAutoLockVisual" checked>
        <span class="sb-checkbox-visual"></span>
        <span class="sb-checkbox-label" style="color:var(--gold); opacity:0.8;">Lock character look for more consistent portrayals next time.</span>
    </label>
    <!-- Lock Look Now button - manual immediate lock -->
    <div id="lockLookContainer" style="margin-top:10px; text-align:center;">
        <button id="btnLockLook" class="small-btn" style="background:#444; font-size:0.85em;" onclick="window.lockCharacterLook()">üîí Lock This Look</button>
        <span id="lockLookStatus" style="display:none; margin-left:8px; color:var(--gold); font-size:0.8em;">‚úì Locked</span>
    </div>
  </div>
</div>

<div id="payAsYouGoModal" class="overlay hidden" style="z-index:10002;">
  <div class="box" style="max-width:420px; text-align:center;">
    <h3 style="color:var(--gold);">Enable Re-Visualize</h3>
    <p style="opacity:0.9; font-size:0.95em; margin-bottom:15px;">
        Re-visualizing a scene costs <strong>$0.25</strong> per attempt.
    </p>
    <p style="opacity:0.7; font-size:0.85em; margin-bottom:20px;">
        Initial visualizations are free (using earned credits).
        Re-Visualize is pay-as-you-go for when you want a different take.
    </p>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button onclick="window.confirmPayAsYouGo();" style="background:var(--gold); color:#1a1814;">Enable Pay-As-You-Go</button>
        <button onclick="window.closePayAsYouGoModal();" style="background:#444">Not Now</button>
    </div>
  </div>
</div>

<div id="eroticPreviewModal" class="overlay hidden" style="z-index:10001;">
  <div class="box" style="max-width:500px;">
    <h3 style="color:var(--hot)">Erotic Intensity Preview</h3>
    <p style="opacity:0.8; font-size:0.9em;">Explicit content enabled. Sample:</p>
    <div id="eroticPreviewText"></div>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
        <button id="eroticPreviewStorypassBtn" onclick="window.showPaywall('unlock');">Storypass $3</button>
        <button id="eroticPreviewSubBtn" class="hidden" onclick="window.showPaywall('sub_only');">Subscribe $6</button>
        <button onclick="document.getElementById('eroticPreviewModal').classList.add('hidden')" style="background:#444">Not Now</button>
    </div>
  </div>
</div>

<div id="coupleInvite" class="overlay hidden">
  <div class="box" style="max-width:520px; text-align:center;">
    <h3>Open a Private Chamber</h3>

    <div class="couple-status-box">
      <div><strong>Your nickname:</strong> <span id="sbNickLabel" style="color:var(--gold)">‚Ä¶</span></div>
      <div><strong>Status:</strong> <span id="coupleStatus" style="font-style:italic">Not connected</span></div>
      <div><strong>Room Code:</strong> <span id="coupleRoomCodeLabel" style="font-family:monospace; color:var(--pink)">‚Äî</span></div>
    </div>

    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
      <button id="btnCreateRoom">New Invitation</button>
      <button id="btnJoinRoom" style="background:#444">Join Room</button>
    </div>

    <div id="joinRow" class="hidden" style="margin-bottom:15px; display:flex; gap:10px; justify-content:center;">
      <input id="joinCodeInput" placeholder="Enter 6-char Code" style="text-transform:uppercase; text-align:center; width:150px;">
      <button id="btnJoinGo">Enter</button>
    </div>

    <div id="roomCodeWrap" class="hidden" style="margin-bottom:15px;">
      <div class="invitation-card" style="background: rgba(255,105,180,0.08); border: 1px solid rgba(255,105,180,0.3); border-radius: 10px; padding: 20px; margin-bottom: 15px;">
        <p id="invitationText" style="font-style: italic; color: var(--ink); margin: 0 0 15px; line-height: 1.5;">
          "A private chamber awaits. The mask is optional. The curiosity is not."
        </p>
        <div id="coupleRoomCodeWrap">
           <div id="roomCodeBig">‚Äî</div>
           <button id="btnCopyCode" title="Copy Code">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
           </button>
        </div>
      </div>

      <p style="margin:0 0 10px; font-size:0.85em; color:var(--gold);">Send invitation via:</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
        <button id="btnSendEmail" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">Email</button>
        <button id="btnSendSMS" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">SMS</button>
        <button id="btnSendBoth" class="invite-send-btn" style="background:#444; font-size:0.85em; padding:8px 16px;">Both</button>
      </div>
      <p id="inviteSentStatus" class="hidden" style="color:var(--gold); font-size:0.85em; margin:10px 0;">Invitation sent. Awaiting your paramour...</p>
    </div>

    <div>
      <button id="btnEnterCoupleGame" class="hidden" style="width:100%; margin-bottom:10px;" disabled>Enter Chamber Together</button>
      <button id="btnPlaySoloWaiting" class="hidden" style="width:100%; margin-bottom:10px; background:#333; border:1px solid var(--gold);">Play Solo Until Your Paramour Joins</button>
      <button onclick="window.coupleCleanup(); window.showScreen('modeSelect')" style="background:transparent; border:1px solid #444; font-size:0.9em;">Back</button>
    </div>
  </div>
</div>

<div id="coupleConsentModal" class="overlay hidden">
  <div class="box" style="max-width:450px; text-align:center;">
    <h3 style="color:var(--gold);">Shared Intensity Agreement</h3>
    <p>You are entering a shared hallucination. Before you begin:</p>
    <ul style="text-align:left; font-size:0.9em; line-height:1.5; color:var(--ink); margin: 20px auto; max-width: 350px;">
        <li><strong>Intensity is a hard ceiling.</strong> Limits depictions regardless of input.</li>
        <li><strong>Inputs are requests.</strong> Naughty reinterprets explicit inputs as tension.</li>
        <li><strong>Upgrades required.</strong> Higher intensity requires appropriate tier.</li>
    </ul>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button id="btnCoupleAgree">Agree & Enter</button>
        <button onclick="window.showScreen('setup'); document.getElementById('coupleConsentModal').classList.add('hidden');" style="background:#444">Change Settings</button>
    </div>
  </div>
</div>

<div id="strangerModal" class="overlay hidden">
  <div class="box">
    <h3>How Daring...</h3>
    <p><span id="strangerCount">12,408</span> others are seeking a connection right now.</p>
    <p style="font-style:italic; color:var(--gold)">Matching is currently unavailable in this version.</p>
    <button onclick="window.showScreen('modeSelect')" style="background:#444">Return</button>
  </div>
</div>

<div id="ageGate" class="screen overlay" style="background:#000; z-index:9999;">
  <div style="text-align:center;">
      <h2>Storybound</h2>
      <p style="font-size:1.2em; max-width:500px; margin:20px;">Explicit adult themes. 18+ Only.</p>
      <button id="ageYes">I am 18+</button>
      <button onclick="location.href='https://google.com'" style="background:#333">Exit</button>
  </div>
</div>

<div id="tosGate" class="screen overlay hidden" style="background:#000; z-index:9998;">
  <div class="box" style="text-align:center;">
      <h2>Terms of Service</h2>
      <div class="tos-box">
        <p><strong>TERMS OF SERVICE</strong></p>
        <p>1. <strong>Age Requirement:</strong> You must be 18+.</p>
        <p>2. <strong>Content Policy:</strong> Adult fantasy roleplay only. Content must be consensual. Optional power play is permitted only if explicitly opted-in. No non-consensual sexual acts, sexual violence, or minors.</p>
        <p>3. <strong>Data & AI:</strong> Content generated by third-party AI models. We may anonymize data.</p>
        <p>4. <strong>Liability:</strong> Use at your own risk. Entertainment purposes only.</p>
      </div>
      <label><input type="checkbox" id="tosCheck"> I agree to the Terms</label>
      <br>
      <button id="tosBtn" disabled>Enter Storybound</button>
  </div>
</div>

<div id="tierGate" class="screen overlay hidden" style="background:#000; z-index:9997;">
  <div style="text-align:center;">
      <h2>Storybound</h2>
      <div class="choice-buttons">
        <div style="text-align:center">
          <button class="choice" id="btnTease">Tease</button>
          <p class="choice-desc">A playful warmup‚Äîgentle choices, tension, and atmosphere.<br><br><strong>From $Free</strong></p>
        </div>
        <div style="text-align:center">
          <button class="choice" id="btnIndulge">Indulge</button>
          <p class="choice-desc">Longer openings, deeper memory, full control, saved stories.<br><br><strong>From $6/mo</strong></p>
        </div>
      </div>
      <button id="continueFromTierBtn" class="choice hidden" style="margin-top:20px; width:80%; max-width:300px;" onclick="window.continueStory()">Continue Saved Story</button>
  </div>
</div>

<div id="payModal" class="overlay hidden" style="z-index:10000;">
  <div class="box" style="text-align:center; max-width: 500px;">
    <h3>Unshackle Your Fate</h3>
    
    <div id="godModePay" class="hidden">
       <h4 style="color:var(--gold); margin-top:0; font-size:1.4em;">Unlock God Mode</h4>
       <p style="font-size:0.9em; opacity:0.8; margin-bottom:20px;">
         Sandbox power. No cooldowns. No safety.
         <br><strong>$50 One-time purchase.</strong>
       </p>
       <button id="payGodMode" style="width:100%; margin-top:10px; background:var(--gold); color:black;">Unlock Forever ($50)</button>
    </div>

    <div id="standardPay">
        <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin:20px 0;">
            <div id="optUnlock" style="background:#222; padding:15px; border-radius:10px; border:1px solid #ff69b4; width:220px; text-align:left;">
                <h4 style="color:var(--pink); margin-top:0;">Unlock This Story</h4>
                <p style="font-size:0.85em; line-height:1.4;">Go deeper for this one arc.<br>Erotic intensity, longer pacing, Quill access.<br><strong>$3 Story Pass.</strong></p>
                <button id="payOneTime" style="width:100%; margin-top:15px;">Storypass $3</button>
                <div id="storypassDisabledNotice" class="hidden" style="margin-top:10px; font-size:0.75em; color:#888; text-align:center;">Unavailable for Dirty intensity</div>
            </div>

            <div id="optSub" style="background:linear-gradient(145deg, #400020, #200010); padding:15px; border-radius:10px; border:1px solid gold; width:220px; text-align:left;">
                <h4 style="color:var(--gold); margin-top:0;">Indulge Limits</h4>
                <ul style="font-size:0.8em; padding-left:15px; opacity:0.9; line-height:1.4; list-style-type: '‚öú ';">
                    <li>Dirty intensity</li>
                    <li>Long-form stories</li>
                    <li>Unlimited Quill</li>
                    <li>Save anytime</li>
                </ul>
                <div style="text-align:center; font-size:0.9em; margin:10px 0; color:var(--gold);">$6/month</div>
                <button id="paySub" style="width:100%; background:linear-gradient(145deg, gold, #b8860b); color:black; font-weight:bold;">Subscribe</button>
            </div>
        </div>
    </div>
    
    <button onclick="document.getElementById('payModal').classList.add('hidden'); if(window.onPaywallDismiss) window.onPaywallDismiss();" style="background:#444; margin-top:15px;">Cancel</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- COVER$ PURCHASE MODAL ‚Äî Paid cover generation with prompt editing        -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="coverPurchaseModal" class="overlay hidden" style="z-index:10020;">
  <div class="box" style="max-width:500px; text-align:left;">
    <h3 style="color:var(--gold); margin-bottom:15px; text-align:center;">‚ú® Purchase Cover Credit</h3>

    <p style="color:var(--text-secondary); font-size:0.9em; margin-bottom:15px;">
      Your free covers for today are used. Purchase an additional cover for <strong style="color:var(--gold);">$0.25</strong>.
    </p>

    <div style="background:rgba(255,215,0,0.08); border:1px solid rgba(255,215,0,0.3); border-radius:8px; padding:15px; margin-bottom:15px;">
      <h4 style="color:var(--gold); font-size:0.9em; margin-bottom:10px;">Cover Details</h4>
      <p style="font-size:0.85em; margin-bottom:5px;"><strong>Title:</strong> <span id="coverPromptTitle">-</span></p>
      <p style="font-size:0.85em; margin-bottom:5px;"><strong>World:</strong> <span id="coverPromptWorld">-</span></p>
      <p style="font-size:0.85em;"><strong>Focal Object:</strong> <span id="coverPromptObject">-</span></p>
    </div>

    <div style="margin-bottom:15px;">
      <label style="display:block; color:var(--gold); font-size:0.85em; margin-bottom:5px;">
        Edit Cover Prompt (optional):
      </label>
      <textarea id="coverPromptInput" style="width:100%; height:100px; background:#1a1a1a; border:1px solid #444; color:var(--text-primary); padding:10px; border-radius:6px; font-size:0.9em; resize:none;" placeholder="Describe your ideal cover..."></textarea>
      <p id="coverPromptSafetyWarning" class="hidden" style="color:#ff6b6b; font-size:0.8em; margin-top:5px;">
        ‚ö†Ô∏è Some words or combinations may prevent image generation.
      </p>
    </div>

    <div style="background:rgba(255,100,100,0.1); border:1px solid rgba(255,100,100,0.3); border-radius:6px; padding:12px; margin-bottom:20px;">
      <p style="color:#ff9999; font-size:0.8em; line-height:1.5;">
        <strong>‚ö†Ô∏è Important:</strong><br>
        Certain words, phrases, or combinations may cause image generation to fail.
        If generation fails due to restricted or incompatible input, the cover credit is forfeited.
        Storybound is not responsible for unfulfilled image requests.
      </p>
    </div>

    <div style="display:flex; gap:10px; justify-content:center;">
      <button onclick="window.processPaidCoverPurchase();" style="background:linear-gradient(145deg, var(--gold), #b8860b); color:black; font-weight:bold; padding:12px 24px; border-radius:6px; cursor:pointer;">
        Pay $0.25 & Generate
      </button>
      <button onclick="window.hideCoverPurchaseModal();" style="background:#444; padding:12px 24px; border-radius:6px; cursor:pointer;">
        Cancel
      </button>
    </div>
  </div>
</div>

<div id="previewModal" class="overlay hidden" style="z-index:10010;">
  <div class="box">
    <p id="previewText" style="font-size:1.3em; font-style:italic; line-height:1.6"></p>
    <button onclick="document.getElementById('previewModal').classList.add('hidden')">Close</button>
  </div>
</div>

<div id="app" class="hidden">

  <div id="modeSelect" class="screen">
    <h1 style="margin-top:40px">Storybound</h1>
    
    <div class="choice-buttons">
      <div style="text-align:center">
          <button class="choice" onclick="window.setMode('solo')">Solo</button>
          <p class="choice-desc" id="soloSubtitle">Just you and your curiosity.</p>
      </div>
      <div style="text-align:center">
          <button class="choice" id="btnCoupleMode" onclick="window.setMode('couple')">Couple</button>
          <p class="choice-desc">Play in bed, together or miles apart.</p>
      </div>
      <div style="text-align:center">
          <button class="choice" onclick="window.setMode('stranger')">Stranger</button>
          <p class="choice-desc">Tempt fate with a random encounter.</p>
      </div>
    </div>
  </div>

  <div id="setup" class="screen hidden" style="max-width:800px; margin:0 auto; padding-bottom:50px;">

    <div class="section-title">Shape Your Story</div>
    <p id="coupleSubhead" class="hidden" style="text-align:center; color:var(--pink); font-style:italic; margin:-10px 0 20px; font-size:0.95em;">Play in bed, together or miles apart.</p>
    <!-- Golden vignette overlay for Guided Fate ceremony -->
    <div id="fateVignette"></div>
    <div class="fate-shortcut-row fate-shortcut-vertical">
      <span class="fate-shortcut-text">or Let Fate Decide</span>
      <div class="fate-destiny-card" id="fateDestinyCard">
        <div class="fate-destiny-inner">
          <div class="fate-destiny-face fate-destiny-back">
            <span class="fate-destiny-title">Guided Fate</span>
          </div>
          <div class="fate-destiny-face fate-destiny-front">
            <div class="fate-golden-tree"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="story-shape-row">
    <!-- Player Character Block: "Your Character" -->
    <div class="character-block character-block-horizontal story-shape-character">
        <div class="character-destiny-side destiny-card">
            <div class="character-destiny-card character-destiny-card-tall" id="playerDestinyCard" data-character="player">
                <div class="character-destiny-inner">
                    <div class="character-destiny-face character-destiny-back"></div>
                    <div class="character-destiny-face character-destiny-front"></div>
                </div>
            </div>
        </div>
        <div class="character-fields-side story-shape-fields">
            <div class="character-section-header">
                <span class="character-section-title">Your Character</span>
            </div>
            <div class="character-fields-row">
                <div class="character-field character-field-name">
                    <label>Name</label>
                    <input id="playerNameInput" type="text" placeholder="e.g. Elara Vance">
                </div>
                <div class="character-field character-field-age">
                    <label>Age</label>
                    <input id="playerAgeInput" type="number" min="18" max="99" placeholder="25">
                </div>
                <div class="character-field character-field-gender">
                    <label>Gender</label>
                    <select id="playerGender" onchange="checkCustom(this, 'customPlayerGender')">
                        <option value="Female">Female</option>
                        <option value="Male">Male</option>
                        <option value="Non-Binary">Non-Binary</option>
                        <option value="Custom">Custom</option>
                    </select>
                    <input id="customPlayerGender" type="text" placeholder="Custom..." class="hidden custom-gender-input">
                </div>
                <div class="character-field character-field-pronouns">
                    <label>Pronouns</label>
                    <select id="playerPronouns" onchange="checkCustom(this, 'customPlayerPronouns')">
                        <option value="She/Her">She/Her</option>
                        <option value="He/Him">He/Him</option>
                        <option value="They/Them">They/Them</option>
                        <option value="Custom">Custom</option>
                    </select>
                    <input id="customPlayerPronouns" type="text" placeholder="Custom..." class="hidden custom-gender-input">
                </div>
                <div class="character-field character-field-ancestry fate-input-wrapper">
                    <label>Ancestry</label>
                    <input id="ancestryInputPlayer" type="text" class="fate-field ancestry-field" data-fate-type="ancestry">
                    <div class="rotating-placeholder" data-for="ancestryInputPlayer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Love Interest Block: "Your Love Interest" -->
    <div class="character-block character-block-horizontal story-shape-character">
        <div class="character-destiny-side destiny-card">
            <div class="character-destiny-card character-destiny-card-tall" id="loveInterestDestinyCard" data-character="loveInterest">
                <div class="character-destiny-inner">
                    <div class="character-destiny-face character-destiny-back"></div>
                    <div class="character-destiny-face character-destiny-front"></div>
                </div>
            </div>
        </div>
        <div class="character-fields-side story-shape-fields">
            <div class="character-section-header">
                <span class="character-section-title">Your Love Interest</span>
            </div>
            <div class="character-fields-row">
                <div class="character-field character-field-name">
                    <label>Name</label>
                    <input id="partnerNameInput" type="text" placeholder="e.g. Lord Blackwood">
                </div>
                <div class="character-field character-field-age">
                    <label>Age</label>
                    <input id="partnerAgeInput" type="number" min="18" max="99" placeholder="28">
                </div>
                <div class="character-field character-field-gender">
                    <label>Gender</label>
                    <select id="loveInterestGender" onchange="checkCustom(this, 'customLoveInterest')">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Non-Binary">Non-Binary</option>
                        <option value="Custom">Custom</option>
                    </select>
                    <input id="customLoveInterest" type="text" placeholder="Custom..." class="hidden custom-gender-input">
                </div>
                <div class="character-field character-field-pronouns">
                    <label>Pronouns</label>
                    <select id="lovePronouns" onchange="checkCustom(this, 'customLovePronouns')">
                        <option value="He/Him">He/Him</option>
                        <option value="She/Her">She/Her</option>
                        <option value="They/Them">They/Them</option>
                        <option value="Custom">Custom</option>
                    </select>
                    <input id="customLovePronouns" type="text" placeholder="Custom..." class="hidden custom-gender-input">
                </div>
                <div class="character-field character-field-ancestry fate-input-wrapper">
                    <label>Ancestry</label>
                    <input id="ancestryInputLI" type="text" class="fate-field ancestry-field" data-fate-type="ancestry">
                    <div class="rotating-placeholder" data-for="ancestryInputLI"></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="section-title" id="archetypeSectionTitle">Archetype Storybeau</div>
    <p class="archetype-header-text">Choose a core personality for your Love Interest.</p>
    <p class="archetype-subtext">Select one Primary archetype. You may optionally add one Modifier to refine how it shows up.</p>

    <div class="sb-grid" id="archetypeCardGrid">
        <!-- Cards dynamically generated by JS -->
    </div>

    <!-- REMOVED: Modal overlay - cards now zoom in-place using CSS transforms -->

    <div class="archetype-selection-summary" id="archetypeSelectionSummary">
        <p class="selected-primary">Primary: <span id="selectedPrimaryName">None</span></p>
        <p class="selected-modifier">Modifier: <span id="selectedModifierName">None</span></p>
    </div>

    <div class="section-title">Arousal Intensity</div>
    <div class="sb-grid sb-grid-4" id="intensityGrid">
      <div class="sb-card" data-grp="intensity" data-val="Clean">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">Clean</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">Clean</span><span class="sb-card-desc">Romantic, non-explicit.</span><span class="sb-card-example">"She sent him home with a stolen kiss."</span></div>
        </div>
      </div>
      <div class="sb-card selected flipped" data-grp="intensity" data-val="Naughty">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">Naughty</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">Naughty</span><span class="sb-card-desc">Suggestive tension; no explicit anatomy.</span><span class="sb-card-example">"She felt him pressed against her, and she pressed back."</span></div>
        </div>
      </div>
      <div class="sb-card locked" data-grp="intensity" data-val="Erotic" data-locked="tease">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">Erotic</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">Erotic</span><span class="sb-card-desc">Explicit sensuality.</span><span class="sb-card-example">"She shuddered as he [censored] deep inside her."</span></div>
        </div>
      </div>
      <div class="sb-card locked" data-grp="intensity" data-val="Dirty" data-locked="sub" data-storypass-allowed="false">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">Dirty</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">Dirty</span><span class="sb-card-desc">Very explicit; highest intensity.</span><span class="sb-card-example">"She [censored] his [censored] and [censored] it again."</span></div>
        </div>
      </div>
    </div>

    <div id="lengthSection">
        <div class="section-title">Story Length</div>
        <p class="subtitle">Choose once. This shapes pacing and endings.</p>
        
        <div class="sb-grid sb-grid-4" id="lengthGrid">
          <div class="sb-card selected flipped" data-grp="length" data-val="tease">
            <div class="sb-card-inner">
              <div class="sb-card-face sb-card-back"><span class="sb-card-title">Tease</span></div>
              <div class="sb-card-face sb-card-front"><span class="sb-card-title">Tease</span><span class="sb-card-desc">A front-row seat. No touching. Ends right when you lean in.</span></div>
            </div>
          </div>
          <div class="sb-card locked" data-grp="length" data-val="fling" data-locked="pass">
            <div class="sb-card-inner">
              <div class="sb-card-face sb-card-back"><span class="sb-card-title">Fling</span></div>
              <div class="sb-card-face sb-card-front"><span class="sb-card-title">Fling</span><span class="sb-card-desc">You get to get off, but you don't get to finish.</span></div>
            </div>
          </div>
          <div class="sb-card locked" data-grp="length" data-val="affair" data-locked="sub">
            <div class="sb-card-inner">
              <div class="sb-card-face sb-card-back"><span class="sb-card-title">Affair</span></div>
              <div class="sb-card-face sb-card-front"><span class="sb-card-title">Affair</span><span class="sb-card-desc">Longer nights, deeper consequences. Arcs unfold. Nothing is rushed.</span></div>
            </div>
          </div>
          <div class="sb-card locked" data-grp="length" data-val="soulmates" data-locked="sub" data-storypass-allowed="false">
            <div class="sb-card-inner">
              <div class="sb-card-face sb-card-back"><span class="sb-card-title">Soulmates</span></div>
              <div class="sb-card-face sb-card-front"><span class="sb-card-title">Soulmates</span><span class="sb-card-desc">This isn't about what happens next. It's about what keeps happening.</span></div>
            </div>
          </div>
        </div>
    </div>

    <!-- STORY POV (Repositioned: POV ‚Üí Safety ‚Üí World) -->
    <div class="section-title">Story POV</div>
    <div class="sb-grid sb-grid-5" id="povGrid">
      <div class="sb-card selected flipped" data-grp="pov" data-val="First">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">1st Person (I)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">1st Person (I)</span><span class="sb-card-desc">"I shouldn't have gone back‚Äîbut my hand was already on the door."</span></div>
        </div>
      </div>
      <div class="sb-card" data-grp="pov" data-val="Second">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">2nd Person (You)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">2nd Person (You)</span><span class="sb-card-desc">"You hesitate, knowing once you knock, nothing will be the same."</span></div>
        </div>
      </div>
      <div class="sb-card" data-grp="pov" data-val="Third">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">3rd Person (They)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">3rd Person (They)</span><span class="sb-card-desc">"We watch her falter at the threshold, pride warring with need."</span></div>
        </div>
      </div>
      <div class="sb-card" data-grp="pov" data-val="Fourth">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">4th Person (We)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">4th Person (We)</span><span class="sb-card-desc">"We feel the moment tighten, as if the room itself is holding its breath."</span></div>
        </div>
      </div>
      <div class="sb-card" data-grp="pov" data-val="Fifth">
        <div class="sb-card-inner">
          <div class="sb-card-face sb-card-back"><span class="sb-card-title">5th Person (Author)</span></div>
          <div class="sb-card-face sb-card-front"><span class="sb-card-title">5th Person (Author)</span><span class="sb-card-desc">"The Author has big plans for you, starting with a knock on the door..."</span></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         FOUR-AXIS STORY SELECTION SYSTEM (AUTHORITATIVE)
         Order: World ‚Üí Tone ‚Üí Genre ‚Üí Dynamic
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

    <!-- FLOATING SYNOPSIS PANEL (Side-mounted book jacket card) -->
    <div id="synopsisPanel" class="synopsis-panel">
      <!-- Art Deco Border: Double gold frame, corner sunbursts, center diamonds -->
      <svg class="dsp-art-deco-border" viewBox="0 0 200 280" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Brushed gold gradient for plated look -->
          <linearGradient id="dspGoldBrushed" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#d4af5a"/>
            <stop offset="25%" stop-color="#c9a24e"/>
            <stop offset="50%" stop-color="#b8934a"/>
            <stop offset="75%" stop-color="#c9a24e"/>
            <stop offset="100%" stop-color="#d4af5a"/>
          </linearGradient>
          <linearGradient id="dspGoldHighlight" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#e8c86a"/>
            <stop offset="50%" stop-color="#c9a24e"/>
            <stop offset="100%" stop-color="#a8863c"/>
          </linearGradient>
        </defs>

        <!-- OUTER FRAME: Double gold lines -->
        <rect x="4" y="4" width="192" height="272" rx="3" ry="3"
              fill="none" stroke="url(#dspGoldBrushed)" stroke-width="1.5" opacity="0.85"/>
        <rect x="8" y="8" width="184" height="264" rx="2" ry="2"
              fill="none" stroke="url(#dspGoldHighlight)" stroke-width="0.75" opacity="0.6"/>

        <!-- TOP CENTER DIAMOND: Where double lines resolve -->
        <polygon points="100,2 106,8 100,14 94,8"
                 fill="url(#dspGoldBrushed)" opacity="0.8"/>
        <polygon points="100,4 104,8 100,12 96,8"
                 fill="none" stroke="url(#dspGoldHighlight)" stroke-width="0.5" opacity="0.6"/>

        <!-- BOTTOM CENTER DIAMOND: Mirror of top -->
        <polygon points="100,278 106,272 100,266 94,272"
                 fill="url(#dspGoldBrushed)" opacity="0.8"/>
        <polygon points="100,276 104,272 100,268 96,272"
                 fill="none" stroke="url(#dspGoldHighlight)" stroke-width="0.5" opacity="0.6"/>

        <!-- TOP-LEFT CORNER SUNBURST: 4 stepped angular rays pointing inward -->
        <g opacity="0.7">
          <line x1="4" y1="4" x2="20" y2="20" stroke="url(#dspGoldBrushed)" stroke-width="1.2"/>
          <line x1="4" y1="12" x2="16" y2="24" stroke="url(#dspGoldBrushed)" stroke-width="0.9"/>
          <line x1="4" y1="22" x2="14" y2="32" stroke="url(#dspGoldBrushed)" stroke-width="0.7"/>
          <line x1="12" y1="4" x2="24" y2="16" stroke="url(#dspGoldBrushed)" stroke-width="0.9"/>
        </g>

        <!-- TOP-RIGHT CORNER SUNBURST: Mirror of top-left -->
        <g opacity="0.7">
          <line x1="196" y1="4" x2="180" y2="20" stroke="url(#dspGoldBrushed)" stroke-width="1.2"/>
          <line x1="196" y1="12" x2="184" y2="24" stroke="url(#dspGoldBrushed)" stroke-width="0.9"/>
          <line x1="196" y1="22" x2="186" y2="32" stroke="url(#dspGoldBrushed)" stroke-width="0.7"/>
          <line x1="188" y1="4" x2="176" y2="16" stroke="url(#dspGoldBrushed)" stroke-width="0.9"/>
        </g>

        <!-- BOTTOM-LEFT CORNER SUNBURST: Mirror of top-left vertically -->
        <g opacity="0.7">
          <line x1="4" y1="276" x2="20" y2="260" stroke="url(#dspGoldBrushed)" stroke-width="1.2"/>
          <line x1="4" y1="268" x2="16" y2="256" stroke="url(#dspGoldBrushed)" stroke-width="0.9"/>
          <line x1="4" y1="258" x2="14" y2="248" stroke="url(#dspGoldBrushed)" stroke-width="0.7"/>
          <line x1="12" y1="276" x2="24" y2="264" stroke="url(#dspGoldBrushed)" stroke-width="0.9"/>
        </g>

        <!-- BOTTOM-RIGHT CORNER SUNBURST: Mirror diagonally -->
        <g opacity="0.7">
          <line x1="196" y1="276" x2="180" y2="260" stroke="url(#dspGoldBrushed)" stroke-width="1.2"/>
          <line x1="196" y1="268" x2="184" y2="256" stroke="url(#dspGoldBrushed)" stroke-width="0.9"/>
          <line x1="196" y1="258" x2="186" y2="248" stroke="url(#dspGoldBrushed)" stroke-width="0.7"/>
          <line x1="188" y1="276" x2="176" y2="264" stroke="url(#dspGoldBrushed)" stroke-width="0.9"/>
        </g>
      </svg>
      <p id="synopsisText" class="synopsis-text"></p>
    </div>

    <!-- AXIS 1: STORY WORLD (Required, First) -->
    <div class="section-title">Story World</div>
    <div class="sb-grid sb-grid-6" id="worldGrid">
      <div class="sb-card selected flipped" data-grp="world" data-val="Modern"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Modern</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Modern</span><span class="sb-card-desc">Present-day settings, familiar social norms.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="Historical"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Historical</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Historical</span><span class="sb-card-desc">A real past era with period constraints.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="Fantasy"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Fantasy</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Fantasy</span><span class="sb-card-desc">Magic, invented worlds, enchanted realms.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="SciFi"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Sci-Fi</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Sci-Fi</span><span class="sb-card-desc">Advanced technology, space, future societies.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="Dystopia"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Dystopia</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Dystopia</span><span class="sb-card-desc">Oppressive systems, controlled societies.</span></div></div></div>
      <div class="sb-card" data-grp="world" data-val="PostApocalyptic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Post-Apocalyptic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Post-Apocalyptic</span><span class="sb-card-desc">Survival after collapse, scarce resources.</span></div></div></div>
    </div>

    <!-- Modern Subtype Sub-Selection (shown only when Modern selected) -->
    <div id="modernSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Modern Flavor</div>
      <div class="sb-grid" id="modernSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="small_town"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Small Town</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Small Town</span><span class="sb-card-desc">Close communities, local secrets, familiar faces.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="college"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">College</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">College</span><span class="sb-card-desc">Campus life, coming of age, academic settings.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="friends"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Friends</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Friends</span><span class="sb-card-desc">Friend groups, shared spaces, everyday drama.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="old_money"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Old Money</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Old Money</span><span class="sb-card-desc">Inherited wealth, elite circles, social expectations.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="office"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">9-5 / Office</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">9-5 / Office</span><span class="sb-card-desc">Workplace dynamics, corporate settings, professional life.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="supernatural_modern"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Supernatural Modern</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Supernatural Modern</span><span class="sb-card-desc">Vampires, shifters, witches in hidden worlds.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="superheroic_modern"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Superheroic Modern</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Superheroic Modern</span><span class="sb-card-desc">Powers, masks, secret identities, cosmic stakes.</span></div></div></div>
      </div>
    </div>

    <!-- Sci-Fi Subtype Sub-Selection (shown only when SciFi selected) -->
    <div id="scifiSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Sci-Fi Flavor</div>
      <div class="sb-grid" id="scifiSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="space_opera"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Star-Spanning Civilizations</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Star-Spanning Civilizations</span><span class="sb-card-desc">Galactic empires, starship voyages, interstellar politics.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="hard_scifi"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Future Built on Science</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Future Built on Science</span><span class="sb-card-desc">Scientific accuracy, plausible technology, realistic physics.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="cyberpunk"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Neon Futures</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Neon Futures</span><span class="sb-card-desc">Neon cities, corporate shadows, hackers and augmentation.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="post_human"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Post-Human</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Post-Human</span><span class="sb-card-desc">Transcendence, uploaded minds, evolved consciousness.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="alien_contact"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">First Contact</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">First Contact</span><span class="sb-card-desc">Alien encounters, xenobiology, interspecies discovery.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="abundance_collapse"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Abundance or Collapse</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Abundance or Collapse</span><span class="sb-card-desc">Post-scarcity utopia or civilizational decline.</span></div></div></div>
      </div>
    </div>

    <!-- Fantasy Subtype Sub-Selection (shown only when Fantasy selected) -->
    <div id="fantasySubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Fantasy Flavor</div>
      <div class="sb-grid" id="fantasySubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="enchanted_realms"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Enchanted Realms</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Enchanted Realms</span><span class="sb-card-desc">Epic quests, powerful magic, wondrous creatures.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="hidden_magic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Hidden Magic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Hidden Magic</span><span class="sb-card-desc">Subtle magic, grounded stakes, rare supernatural.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="cursed_corrupt"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Cursed & Corrupt Worlds</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Cursed & Corrupt Worlds</span><span class="sb-card-desc">Grim worlds, dangerous magic, moral corruption.</span></div></div></div>
      </div>
    </div>

    <!-- Horror Subtype Sub-Selection (shown when Horror tone selected with Fantasy/Supernatural) -->
    <div id="horrorSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Horror Flavor</div>
      <div class="sb-grid" id="horrorSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="cosmic_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Cosmic Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Cosmic Horror</span><span class="sb-card-desc">Unknowable entities, insignificance, existential dread.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="psychological_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Psychological</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Psychological</span><span class="sb-card-desc">Mind games, paranoia, internal terror.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="gothic_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Gothic Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Gothic Horror</span><span class="sb-card-desc">Decaying mansions, ancestral curses, romantic dread.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="body_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Body Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Body Horror</span><span class="sb-card-desc">Transformation, corruption of flesh, visceral dread.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="folk_horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Folk Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Folk Horror</span><span class="sb-card-desc">Rural isolation, ancient rituals, community darkness.</span></div></div></div>
      </div>
    </div>

    <!-- Dystopia Subtype Sub-Selection (shown only when Dystopia selected) -->
    <div id="dystopiaSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Dystopia Flavor</div>
      <div class="sb-grid" id="dystopiaSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="authoritarian"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Authoritarian</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Authoritarian</span><span class="sb-card-desc">Totalitarian state, thought control, rebellion.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="surveillance"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Surveillance</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Surveillance</span><span class="sb-card-desc">Constant monitoring, no privacy, digital control.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="corporate"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Corporate</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Corporate</span><span class="sb-card-desc">Mega-corps rule, profit over people, wage slavery.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="environmental"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Environmental</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Environmental</span><span class="sb-card-desc">Ecological collapse, scarce resources, climate ruin.</span></div></div></div>
      </div>
    </div>

    <!-- Post-Apocalyptic Subtype Sub-Selection (shown only when PostApocalyptic selected) -->
    <div id="apocalypseSubtypeSelection" class="world-subtype-selection hidden">
      <div class="section-title sub-title">Apocalypse Type</div>
      <div class="sb-grid" id="apocalypseSubtypeGrid">
        <div class="sb-card" data-grp="worldSubtype" data-val="nuclear"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Nuclear Aftermath</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Nuclear Aftermath</span><span class="sb-card-desc">Atomic devastation, radiation, scarred landscapes.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="pandemic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Pandemic Collapse</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Pandemic Collapse</span><span class="sb-card-desc">Plague survivors, immune vs infected, quarantine.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="climate"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Climate Ruin</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Climate Ruin</span><span class="sb-card-desc">Environmental collapse, extreme weather, survival.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="technological"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Technological Fallout</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Technological Fallout</span><span class="sb-card-desc">AI uprising, tech failure, machines vs humans.</span></div></div></div>
        <div class="sb-card" data-grp="worldSubtype" data-val="slow_decay"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Slow Civilizational Decay</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Slow Civilizational Decay</span><span class="sb-card-desc">Gradual decline, fading infrastructure, quiet endings.</span></div></div></div>
      </div>
    </div>

    <!-- AXIS 2: STORY TONE (Required, Second) -->
    <div class="section-title">Story Tone</div>
    <div class="sb-grid sb-grid-9" id="toneGrid">
      <div class="sb-card selected flipped" data-grp="tone" data-val="Earnest"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Earnest</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Earnest</span><span class="sb-card-desc">Sincere emotion, unironic stakes.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="WryConfession"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Wry Confession</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Wry Confession</span><span class="sb-card-desc">Intimacy with irony, self-aware narrator.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Satirical"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Satirical</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Satirical</span><span class="sb-card-desc">Social critique, exaggeration, systems mocked.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Dark"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Dark</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Dark</span><span class="sb-card-desc">Morally complex, shadowed desire.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Horror"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Horror</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Horror</span><span class="sb-card-desc">Dread, the uncanny, fear as tension.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Mythic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Mythic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Mythic</span><span class="sb-card-desc">Archetypal weight, legendary scale.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Comedic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Comedic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Comedic</span><span class="sb-card-desc">Humor is primary, stakes are light.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Surreal"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Surreal</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Surreal</span><span class="sb-card-desc">Dreamlike, unstable, symbolic.</span></div></div></div>
      <div class="sb-card" data-grp="tone" data-val="Poetic"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Poetic</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Poetic</span><span class="sb-card-desc">Lyrical prose, sensory immersion.</span></div></div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         AXIS 3: GENRE / FLAVOR (Required, Third)

         LOCKED DESIGN RULE:
         Genres must describe narrative action or fantasy, not setting or life stage.
         Settings like "Sports", "College", "Small Town" belong in World modifiers,
         not Genre. Genre implies what the characters DO, not where they ARE.
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section-title">Genre</div>
    <div class="sb-grid sb-grid-6" id="genreGrid">
      <div class="sb-card" data-grp="genre" data-val="CrimeSyndicate"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Crime Syndicate</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Crime Syndicate</span><span class="sb-card-desc">Organized crime, loyalty, blood oaths.</span></div></div></div>
      <div class="sb-card selected flipped" data-grp="genre" data-val="Billionaire"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Billionaire</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Billionaire</span><span class="sb-card-desc">Ultra-wealth, power plays, golden cages.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Noir"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Noir</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Noir</span><span class="sb-card-desc">Shadows, moral compromise, fatalism.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Heist"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Heist</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Heist</span><span class="sb-card-desc">Elaborate plans, trust and betrayal.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Espionage"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Espionage</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Espionage</span><span class="sb-card-desc">Spies, double lives, dangerous information.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Political"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Political Intrigue</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Political Intrigue</span><span class="sb-card-desc">Power structures, alliances, betrayal.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Escape"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Escape</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Escape</span><span class="sb-card-desc">Running from the past, chasing freedom.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Redemption"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Redemption</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Redemption</span><span class="sb-card-desc">Second chances, atonement, becoming worthy.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="BuildingBridges"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Building Bridges</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Building Bridges</span><span class="sb-card-desc">Healing rifts, unlikely alliances, found family.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Purgatory"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Purgatory</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Purgatory</span><span class="sb-card-desc">Cycles, stalled time, escape through understanding.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="RelentlessPast"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Relentless Past</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Relentless Past</span><span class="sb-card-desc">Identity erosion, old lives resurfacing, consequences arriving.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Sports"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Sports</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Sports</span><span class="sb-card-desc">Competition, teamwork, glory and defeat.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Survival"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Survival</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Survival</span><span class="sb-card-desc">Scarcity, endurance, brutal choices.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="Obsession"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Obsession</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Obsession</span><span class="sb-card-desc">Fixation, escalation, loss of control.</span></div></div></div>
      <div class="sb-card" data-grp="genre" data-val="ForbiddenKnowledge"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Forbidden Knowledge</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Forbidden Knowledge</span><span class="sb-card-desc">Curiosity, revelation, the price of knowing.</span></div></div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         AXIS 4: RELATIONSHIP DYNAMIC (Required, Last)

         LOCKED DESIGN RULE:
         Relationship Dynamics are single-select and represent emotional structure,
         not identity. They describe how characters relate, not who they are.
         Groupings are for cognitive organization only‚Äîselection remains flat.
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section-title">Relationship Dynamic</div>
    <div class="dynamic-grouped" id="dynamicGrid">
      <!-- Circumstance-Based -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Circumstance-Based</div>
        <div class="sb-grid sb-grid-4">
          <div class="sb-card" data-grp="dynamic" data-val="Proximity"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Forced Proximity</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Forced Proximity</span><span class="sb-card-desc">Circumstance throws them together.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="SecretIdentity"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Secret Identity</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Secret Identity</span><span class="sb-card-desc">Hidden truths, masks, revelations.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Caretaker"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Caretaker / Wounded</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Caretaker / Wounded</span><span class="sb-card-desc">Vulnerability and steady presence.</span></div></div></div>
        </div>
      </div>
      <!-- Emotional Arc -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Emotional Arc</div>
        <div class="sb-grid sb-grid-4">
          <div class="sb-card" data-grp="dynamic" data-val="Friends"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Friends to Lovers</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Friends to Lovers</span><span class="sb-card-desc">Safety tipping into something more.</span></div></div></div>
          <div class="sb-card selected flipped" data-grp="dynamic" data-val="Enemies"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Enemies to Lovers</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Enemies to Lovers</span><span class="sb-card-desc">Friction that becomes fire.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="SecondChance"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">2nd Chance</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">2nd Chance</span><span class="sb-card-desc">Past lovers, unfinished business.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Forbidden"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Forbidden Love</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Forbidden Love</span><span class="sb-card-desc">Rules, taboo, desire against judgment.</span></div></div></div>
        </div>
      </div>
      <!-- Intensity / Attachment -->
      <div class="dynamic-group">
        <div class="dynamic-group-label">Intensity / Attachment</div>
        <div class="sb-grid sb-grid-4">
          <div class="sb-card" data-grp="dynamic" data-val="Dangerous"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Dangerous</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Dangerous</span><span class="sb-card-desc">Risk in proximity, threat as aphrodisiac.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Obsessive"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Obsessive Devotion</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Obsessive Devotion</span><span class="sb-card-desc">Consuming focus, intensity as love language.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Fated"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Fated</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Fated</span><span class="sb-card-desc">Destined bond, cosmic inevitability.</span></div></div></div>
          <div class="sb-card" data-grp="dynamic" data-val="Partners"><div class="sb-card-inner"><div class="sb-card-face sb-card-back"><span class="sb-card-title">Partners in Crime</span></div><div class="sb-card-face sb-card-front"><span class="sb-card-title">Partners in Crime</span><span class="sb-card-desc">Complicity, shared secrets, us vs them.</span></div></div></div>
        </div>
      </div>
    </div>

    <!-- SAFETY & BOUNDARIES (Repositioned: above Quill & Veto) -->
    <div class="section-title">Safety & Boundaries</div>
    <div class="sb-checkbox-group">
        <label class="sb-checkbox">
            <input type="checkbox" id="chkDark" checked>
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Dark Themes</span>
        </label>
        <label class="sb-checkbox">
            <input type="checkbox" id="chkNonCon">
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Implied Non-consent</span>
        </label>
        <label class="sb-checkbox">
            <input type="checkbox" id="chkViolence" checked>
            <span class="sb-checkbox-visual"></span>
            <span class="sb-checkbox-label">Violence / Peril</span>
        </label>
    </div>
    <div class="boundary-chips" id="boundaryChips">
        <div class="chip locked-chip active" title="Always enforced">No sexual violence</div>
        <div class="chip" data-boundary="coercion">No coercion</div>
        <div class="chip" data-boundary="degradation">No degradation language</div>
        <div class="chip" data-boundary="captivity">No captivity</div>
        <div class="chip" data-boundary="blackmail">No blackmail</div>
    </div>

    <div class="section-title">Quill & Veto</div>

    <div class="quill-veto-container">
        <div class="qv-section">
            <label class="qv-label">Veto</label>
            <p class="qv-hint-above">Block elements you never want to appear. Vetoes are immediate and permanent.</p>
            <div id="vetoCommitted" class="committed-phrases"></div>
            <div class="fate-input-row">
                <div class="destiny-flip-card" data-target="vetoInput" data-type="veto">
                    <div class="destiny-card-inner">
                        <div class="destiny-card-back"></div>
                        <div class="destiny-card-front"></div>
                    </div>
                </div>
                <div class="input-wrapper fate-input-wrapper fate-textarea-wrapper">
                    <textarea id="vetoInput" rows="2" class="fate-field" data-fate-type="veto"></textarea>
                    <div class="rotating-placeholder textarea-placeholder" data-for="vetoInput"></div>
                </div>
            </div>
            <div class="qv-commit-row qv-commit-center">
                <span id="vetoStatus" style="font-size:0.85em; color:var(--pink);">Veto: Ready</span>
                <button id="btnCommitVeto" class="small-btn" style="padding:4px 10px; font-size:0.85em;">Commit Veto</button>
            </div>
            <p class="qv-hint-below">Vetoes remove content from consideration. They cannot start scenes or direct the story.</p>
        </div>

        <div class="qv-section">
            <label class="qv-label">Quill</label>
            <p class="qv-hint-above">Use the Quill to gently steer tone, boundaries, or direction without rewriting what's already happened.</p>
            <div id="quillCommitted" class="committed-phrases"></div>
            <div class="fate-input-row">
                <div class="destiny-flip-card" data-target="quillInput" data-type="quill">
                    <div class="destiny-card-inner">
                        <div class="destiny-card-back"></div>
                        <div class="destiny-card-front"></div>
                    </div>
                </div>
                <div id="quillBox" class="input-wrapper fate-input-wrapper fate-textarea-wrapper locked-input">
                    <textarea id="quillInput" rows="2" class="fate-field" data-fate-type="quill"></textarea>
                    <div class="rotating-placeholder textarea-placeholder" data-for="quillInput"></div>
                </div>
            </div>
            <div class="qv-commit-row qv-commit-center">
                <span id="quillStatus">Quill: Poised</span>
                <button id="btnCommitQuill" class="small-btn" style="padding:4px 10px; font-size:0.85em; opacity:0.5;" disabled>Commit Quill</button>
            </div>
            <p class="qv-hint-below">Quill edits shape what follows and may persist. Each use exhausts the Quill, requiring time and words before it can be wielded again.</p>
        </div>
    </div>

    <div class="quill-veto-ui">
        <div id="godModeToggle" class="hidden">
            <label id="godModeLabel"><input type="checkbox" id="godModeCheck"> Enable God Mode (Sandbox)</label>
        </div>
    </div>

    <br>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- BOOK COVER GENERATION ‚Äî DISABLED (Earned Cover System Phase B)       -->
    <!-- Cover generation is now READER-ONLY via btnReaderCover               -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="coverGenSection" class="hidden" style="display:none; margin-top:20px; text-align:center;">
      <button id="btnGenerateCover" style="font-size:1.1em; padding:10px 20px; background:linear-gradient(135deg, #2a2a2a, #1a1a1a); border:1px solid var(--gold); color:var(--gold); cursor:pointer;">
        Generate Your Book Cover
      </button>
      <!-- Cover$ Credit Display -->
      <p id="coverCreditDisplay" style="font-size:0.75em; color:var(--gold); margin-top:6px; opacity:0.8;">3 free covers remaining today</p>
      <div id="coverGenStatus" class="hidden" style="margin-top:10px; color:var(--text-secondary); font-size:0.9em;">
        <div id="coverGenLoading" style="display:flex; flex-direction:column; align-items:center; gap:8px;">
          <span>Generating your cover...</span>
          <div class="cover-gen-bar" style="width:50px; height:3px; background:rgba(255,215,0,0.2); border-radius:2px; overflow:hidden;">
            <div class="cover-gen-bar-fill" style="width:100%; height:100%; background:var(--gold); animation:coverGenBarFill 1.2s ease-in-out infinite;"></div>
          </div>
        </div>
        <div id="coverGenComplete" class="hidden" style="color:var(--gold);">
          Cover ready! It will appear when you begin your story.
        </div>
        <div id="coverGenLocked" class="hidden" style="color:var(--text-secondary);">
          Cover generation unlocks again at Scene 5 <span id="coverGenSubLink" class="hidden">or <a href="#" onclick="window.showPaywall('sub_only'); return false;" style="color:var(--pink);">subscribe</a></span>
        </div>
      </div>
      <p style="font-size:0.8em; color:var(--text-secondary); margin-top:8px; opacity:0.7;">Optional ‚Äî you can skip this and start reading immediately</p>
    </div>

    <button id="beginBtn" style="font-size:1.5em; margin-top:20px;">Begin Story</button>
  </div>

  <!-- ============================================================ -->
  <!-- BREADCRUMB INDICATOR ‚Äî Non-clickable orientation display     -->
  <!-- ============================================================ -->
  <div id="storyBreadcrumb" class="story-breadcrumb hidden">
    <span class="breadcrumb-step breadcrumb-origin" data-step="shape">Shape</span>
    <span class="breadcrumb-dot">¬∑</span>
    <span class="breadcrumb-step" data-step="cover">Cover</span>
    <span class="breadcrumb-arrow">‚Üí</span>
    <span class="breadcrumb-step" data-step="setting">Setting</span>
    <span class="breadcrumb-arrow">‚Üí</span>
    <span class="breadcrumb-step" data-step="story">Story</span>
  </div>

  <div id="game" class="screen hidden" style="max-width:900px; margin:0 auto; padding-bottom:60px;">

    <!-- ============================================================ -->
    <!-- BOOK COVER PAGE - Physical book object, clickable anywhere   -->
    <!-- ============================================================ -->
    <div id="bookCoverPage" class="book-cover-page">
      <div id="coverLoadingState" class="cover-loading">
        <div class="cover-progress-bar">
          <div id="coverProgressFill" class="cover-progress-fill"></div>
        </div>
        <p id="coverStatusText" class="cover-status-text">Building your book cover...</p>
        <button id="coverAbortBtn" class="cover-abort-btn" title="Cancel cover generation">‚úï</button>
      </div>

      <!-- Physical book object - no buttons, click anywhere to open -->
      <div id="bookObject" class="book-object hidden">
        <!-- Bookmark ribbon (visible for returning readers) -->
        <div id="bookmarkRibbon" class="bookmark-ribbon hidden"></div>

        <!-- Book cover with hinge -->
        <div id="bookCover" class="book-cover">
          <img id="bookCoverImg" src="" alt="Book Cover" class="book-cover-image">
          <!-- Fallback cover: Intentional empty-state design (textured, Art Deco border, watermark) -->
          <div id="coverFallback" class="cover-fallback hidden">
            <!-- Art Deco border frame -->
            <svg class="fallback-border" viewBox="0 0 320 480" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Outer frame -->
              <rect x="8" y="8" width="304" height="464" rx="4" stroke="currentColor" stroke-width="1.5"/>
              <!-- Inner frame -->
              <rect x="16" y="16" width="288" height="448" rx="2" stroke="currentColor" stroke-width="0.75" opacity="0.5"/>
              <!-- Corner flourishes -->
              <g opacity="0.6">
                <!-- Top-left -->
                <path d="M8,40 L8,8 L40,8" stroke="currentColor" stroke-width="1.5"/>
                <path d="M16,32 L16,16 L32,16" stroke="currentColor" stroke-width="0.75"/>
                <!-- Top-right -->
                <path d="M312,40 L312,8 L280,8" stroke="currentColor" stroke-width="1.5"/>
                <path d="M304,32 L304,16 L288,16" stroke="currentColor" stroke-width="0.75"/>
                <!-- Bottom-left -->
                <path d="M8,440 L8,472 L40,472" stroke="currentColor" stroke-width="1.5"/>
                <path d="M16,448 L16,464 L32,464" stroke="currentColor" stroke-width="0.75"/>
                <!-- Bottom-right -->
                <path d="M312,440 L312,472 L280,472" stroke="currentColor" stroke-width="1.5"/>
                <path d="M304,448 L304,464 L288,464" stroke="currentColor" stroke-width="0.75"/>
              </g>
              <!-- Top center keystone -->
              <g transform="translate(160,0)" opacity="0.5">
                <line x1="0" y1="24" x2="-20" y2="6" stroke="currentColor" stroke-width="0.6"/>
                <line x1="0" y1="22" x2="0" y2="4" stroke="currentColor" stroke-width="0.7"/>
                <line x1="0" y1="24" x2="20" y2="6" stroke="currentColor" stroke-width="0.6"/>
                <circle cx="0" cy="18" r="4" stroke="currentColor" stroke-width="0.75"/>
              </g>
              <!-- Bottom center flourish -->
              <g transform="translate(160,480)" opacity="0.5">
                <line x1="0" y1="-24" x2="-20" y2="-6" stroke="currentColor" stroke-width="0.6"/>
                <line x1="0" y1="-22" x2="0" y2="-4" stroke="currentColor" stroke-width="0.7"/>
                <line x1="0" y1="-24" x2="20" y2="-6" stroke="currentColor" stroke-width="0.6"/>
                <circle cx="0" cy="-18" r="4" stroke="currentColor" stroke-width="0.75"/>
              </g>
            </svg>
            <!-- Embossed watermark (symbolic key) -->
            <div class="fallback-watermark">
              <svg viewBox="0 0 80 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Key bow (ring) -->
                <circle cx="40" cy="24" r="18" stroke="currentColor" stroke-width="2"/>
                <circle cx="40" cy="24" r="10" stroke="currentColor" stroke-width="1" opacity="0.5"/>
                <!-- Key shaft -->
                <line x1="40" y1="42" x2="40" y2="105" stroke="currentColor" stroke-width="3"/>
                <!-- Key teeth -->
                <path d="M40,85 L52,85 L52,92 L40,92" stroke="currentColor" stroke-width="2"/>
                <path d="M40,95 L48,95 L48,102 L40,102" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <!-- Title and author -->
            <div class="fallback-title" id="fallbackTitle">Untitled</div>
            <div class="fallback-author">by Anonymous</div>
          </div>
          <!-- Layer 2: Erotic border overlay (Art Deco filigree + implements) -->
          <div id="coverEroticBorder" class="cover-erotic-border hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 480" fill="none" class="erotic-border-svg">
              <!-- OUTER FRAME RAILS -->
              <rect x="5" y="5" width="310" height="470" rx="6" stroke="currentColor" stroke-width="2" opacity="0.65"/>
              <rect x="13" y="13" width="294" height="454" rx="3" stroke="currentColor" stroke-width="1" opacity="0.35"/>

              <!-- TOP-LEFT CORNER: stepped bracket + ribbon curl -->
              <g opacity="0.6">
                <path d="M5,60 L5,5 L60,5" stroke="currentColor" stroke-width="2"/>
                <path d="M13,50 L13,13 L50,13" stroke="currentColor" stroke-width="1.2"/>
                <path d="M21,42 L21,21 L42,21" stroke="currentColor" stroke-width="0.8"/>
                <path d="M5,40 C14,38 18,30 15,24 C12,18 18,11 25,14 C32,17 34,10 40,5" stroke="currentColor" stroke-width="0.9" opacity="0.5"/>
                <line x1="5" y1="5" x2="32" y2="32" stroke="currentColor" stroke-width="0.5" opacity="0.25"/>
              </g>
              <!-- TOP-RIGHT CORNER (mirror) -->
              <g transform="translate(320,0) scale(-1,1)" opacity="0.6">
                <path d="M5,60 L5,5 L60,5" stroke="currentColor" stroke-width="2"/>
                <path d="M13,50 L13,13 L50,13" stroke="currentColor" stroke-width="1.2"/>
                <path d="M21,42 L21,21 L42,21" stroke="currentColor" stroke-width="0.8"/>
                <path d="M5,40 C14,38 18,30 15,24 C12,18 18,11 25,14 C32,17 34,10 40,5" stroke="currentColor" stroke-width="0.9" opacity="0.5"/>
                <line x1="5" y1="5" x2="32" y2="32" stroke="currentColor" stroke-width="0.5" opacity="0.25"/>
              </g>
              <!-- BOTTOM-LEFT CORNER (mirror) -->
              <g transform="translate(0,480) scale(1,-1)" opacity="0.6">
                <path d="M5,60 L5,5 L60,5" stroke="currentColor" stroke-width="2"/>
                <path d="M13,50 L13,13 L50,13" stroke="currentColor" stroke-width="1.2"/>
                <path d="M21,42 L21,21 L42,21" stroke="currentColor" stroke-width="0.8"/>
                <path d="M5,40 C14,38 18,30 15,24 C12,18 18,11 25,14 C32,17 34,10 40,5" stroke="currentColor" stroke-width="0.9" opacity="0.5"/>
                <line x1="5" y1="5" x2="32" y2="32" stroke="currentColor" stroke-width="0.5" opacity="0.25"/>
              </g>
              <!-- BOTTOM-RIGHT CORNER (mirror both) -->
              <g transform="translate(320,480) scale(-1,-1)" opacity="0.6">
                <path d="M5,60 L5,5 L60,5" stroke="currentColor" stroke-width="2"/>
                <path d="M13,50 L13,13 L50,13" stroke="currentColor" stroke-width="1.2"/>
                <path d="M21,42 L21,21 L42,21" stroke="currentColor" stroke-width="0.8"/>
                <path d="M5,40 C14,38 18,30 15,24 C12,18 18,11 25,14 C32,17 34,10 40,5" stroke="currentColor" stroke-width="0.9" opacity="0.5"/>
                <line x1="5" y1="5" x2="32" y2="32" stroke="currentColor" stroke-width="0.5" opacity="0.25"/>
              </g>

              <!-- TOP CENTER: KEY as Art Deco keystone arch -->
              <g transform="translate(160,0)" opacity="0.6">
                <!-- Sunburst fan rays (key bow abstracted) -->
                <line x1="0" y1="30" x2="-28" y2="3" stroke="currentColor" stroke-width="0.7"/>
                <line x1="0" y1="30" x2="-16" y2="2" stroke="currentColor" stroke-width="0.7"/>
                <line x1="0" y1="28" x2="0" y2="1" stroke="currentColor" stroke-width="0.8"/>
                <line x1="0" y1="30" x2="16" y2="2" stroke="currentColor" stroke-width="0.7"/>
                <line x1="0" y1="30" x2="28" y2="3" stroke="currentColor" stroke-width="0.7"/>
                <!-- Key ring (bow) -->
                <circle cx="0" cy="23" r="6.5" stroke="currentColor" stroke-width="1.2"/>
                <circle cx="0" cy="23" r="3" stroke="currentColor" stroke-width="0.5" opacity="0.3"/>
                <!-- Key shaft -->
                <line x1="0" y1="29.5" x2="0" y2="52" stroke="currentColor" stroke-width="1.2"/>
                <!-- Ward cuts (teeth) -->
                <line x1="0" y1="44" x2="4.5" y2="44" stroke="currentColor" stroke-width="0.9"/>
                <line x1="0" y1="48" x2="3.5" y2="48" stroke="currentColor" stroke-width="0.9"/>
                <!-- Flanking accent lines -->
                <line x1="-50" y1="8" x2="-32" y2="8" stroke="currentColor" stroke-width="0.7" opacity="0.35"/>
                <line x1="32" y1="8" x2="50" y2="8" stroke="currentColor" stroke-width="0.7" opacity="0.35"/>
              </g>

              <!-- BOTTOM CENTER: HANDCUFFS as linked Art Deco rings -->
              <g transform="translate(160,480)" opacity="0.55">
                <!-- Left cuff -->
                <ellipse cx="-15" cy="-25" rx="10" ry="9" stroke="currentColor" stroke-width="1.2"/>
                <!-- Right cuff -->
                <ellipse cx="15" cy="-25" rx="10" ry="9" stroke="currentColor" stroke-width="1.2"/>
                <!-- Chain links (interlocking circles) -->
                <circle cx="-3" cy="-25" r="3" stroke="currentColor" stroke-width="0.8"/>
                <circle cx="3" cy="-25" r="3" stroke="currentColor" stroke-width="0.8"/>
                <!-- Keyhole accents on cuffs -->
                <line x1="-15" y1="-28" x2="-15" y2="-22" stroke="currentColor" stroke-width="0.5" opacity="0.4"/>
                <line x1="15" y1="-28" x2="15" y2="-22" stroke="currentColor" stroke-width="0.5" opacity="0.4"/>
                <!-- Stepped deco base -->
                <line x1="-45" y1="-9" x2="45" y2="-9" stroke="currentColor" stroke-width="0.7" opacity="0.3"/>
                <line x1="-35" y1="-13" x2="35" y2="-13" stroke="currentColor" stroke-width="0.5" opacity="0.2"/>
              </g>

              <!-- LEFT RAIL: FEATHER as Art Deco leaf filigree -->
              <g transform="translate(9,140)" opacity="0.4">
                <!-- Quill shaft -->
                <line x1="4" y1="0" x2="4" y2="200" stroke="currentColor" stroke-width="0.7"/>
                <!-- Barb pairs ‚Äî symmetric leaf shapes -->
                <path d="M4,8 C-1,18 -1,30 4,40" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,8 C9,18 9,30 4,40" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,48 C-1,58 -1,70 4,80" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,48 C9,58 9,70 4,80" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,88 C-1,98 -1,110 4,120" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,88 C9,98 9,110 4,120" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,128 C-1,138 -1,150 4,160" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,128 C9,138 9,150 4,160" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,168 C-1,178 -1,190 4,200" stroke="currentColor" stroke-width="0.5"/>
                <path d="M4,168 C9,178 9,190 4,200" stroke="currentColor" stroke-width="0.5"/>
              </g>

              <!-- RIGHT RAIL: RIDING CROP as vertical accent -->
              <g transform="translate(307,140)" opacity="0.4">
                <!-- Shaft (slightly tapered) -->
                <line x1="4" y1="12" x2="4" y2="188" stroke="currentColor" stroke-width="0.9"/>
                <!-- Handle wrap (cross-lacing) -->
                <line x1="2" y1="168" x2="6" y2="173" stroke="currentColor" stroke-width="0.4"/>
                <line x1="2" y1="173" x2="6" y2="178" stroke="currentColor" stroke-width="0.4"/>
                <line x1="2" y1="178" x2="6" y2="183" stroke="currentColor" stroke-width="0.4"/>
                <line x1="2" y1="183" x2="6" y2="188" stroke="currentColor" stroke-width="0.4"/>
                <!-- Keeper loop (wrist strap) -->
                <path d="M4,188 C0,194 0,200 4,200 C8,200 8,194 4,188" stroke="currentColor" stroke-width="0.6"/>
                <!-- Tongue/keeper flap at top -->
                <ellipse cx="4" cy="6" rx="5" ry="4" stroke="currentColor" stroke-width="0.5" opacity="0.5"/>
                <line x1="4" y1="10" x2="4" y2="12" stroke="currentColor" stroke-width="0.7"/>
              </g>

              <!-- SIDE ACCENT DASHES -->
              <line x1="5" y1="80" x2="5" y2="115" stroke="currentColor" stroke-width="0.8" opacity="0.2"/>
              <line x1="5" y1="365" x2="5" y2="400" stroke="currentColor" stroke-width="0.8" opacity="0.2"/>
              <line x1="315" y1="80" x2="315" y2="115" stroke="currentColor" stroke-width="0.8" opacity="0.2"/>
              <line x1="315" y1="365" x2="315" y2="400" stroke="currentColor" stroke-width="0.8" opacity="0.2"/>
            </svg>
          </div>
          <!-- Layer 3: Dirty keyhole takeover -->
          <div id="coverKeyholeOverlay" class="cover-keyhole-overlay hidden">
            <div class="keyhole-plate"></div>
            <div class="keyhole-title"></div>
          </div>
        </div>

        <!-- Book pages underneath (visible during courtesy hinge) -->
        <div id="bookPagesPreview" class="book-pages-preview">
          <div class="page-edge-stack"></div>
          <!-- Inside cover: BLANK paper only (no text, no images per spec) -->
          <div id="bookInsideCover" class="book-inside-cover">
            <!-- Intentionally empty: pure white/paper texture -->
          </div>
        </div>

        <!-- Book spine/thickness -->
        <div class="book-spine"></div>
        <div class="book-thickness"></div>
      </div>

      <!-- Cover View Buttons (below the book) -->
      <div id="coverViewButtons" class="cover-view-buttons hidden">
        <button id="btnSeeSetting" class="cover-view-btn setting-btn">See Your Story Setting</button>
        <div id="settingBtnDisabledNotice" class="setting-disabled-notice hidden">Requires subscription to access</div>
        <button id="btnBeginStory" class="cover-view-btn begin-btn">Begin Story</button>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- SETTING VIEW - Full-screen setting image display            -->
    <!-- ============================================================ -->
    <div id="settingView" class="setting-view hidden">
      <!-- NON-BLOCKING Loading: User can always proceed -->
      <div id="settingViewLoading" class="setting-view-loading">
        <p class="setting-status-text">Generating setting image<span class="setting-ellipsis"></span></p>
        <p id="settingLongWaitHint" class="setting-long-wait-hint hidden">Still working‚Ä¶ you can continue without it.</p>
        <button id="btnSettingSkip" class="setting-skip-btn">Begin Story ‚Üí</button>
      </div>
      <div id="settingViewContent" class="setting-view-content hidden">
        <img id="settingViewImg" src="" alt="Story Setting" class="setting-view-image">
        <p class="setting-view-hint">Tap to begin your story</p>
      </div>
      <!-- Setting Fallback: Shown on failure (not cancel) -->
      <div id="settingViewFallback" class="setting-view-fallback hidden">
        <div class="setting-fallback-inner">
          <div class="setting-fallback-text">Setting image unavailable</div>
          <button id="btnSettingBeginStory" class="setting-begin-btn">Begin Story</button>
          <button id="btnSettingRetry" class="setting-retry-btn">Try Again</button>
        </div>
      </div>
      <button id="btnSettingBack" class="setting-back-btn">‚Üê Back to Cover</button>
    </div>

    <!-- Main story content (hidden during cover) -->
    <div id="storyContent" class="story-content hidden">

    <div id="billingBanner" style="display:none;"></div>

    <!-- SCENE 1 COMPOSITION: Title ‚Üí Synopsis ‚Üí Setting Image ‚Üí Prose -->
    <h2 id="storyTitle" style="font-size:3em; text-align:center; margin-bottom:10px;"></h2>

    <!-- Synopsis displays below title, before setting image -->
    <p id="sceneSynopsis" class="scene-synopsis hidden" style="text-align:center; font-style:italic; color:var(--text-secondary); margin:0 20px 20px; line-height:1.5;"></p>

    <div id="sceneNumber" style="font-size:2em; color:var(--gold); font-weight:bold; text-align:center; margin:0 0 20px;">Scene 1</div>

    <!-- Setting Plate: Inline within Scene 1 (between synopsis and prose) -->
    <div id="settingPlate" class="setting-plate setting-inline">
      <img id="bookSceneImg" src="" alt="" class="book-scene-image">
      <div id="bookSceneLoading" class="book-scene-loading hidden">Conjuring the world‚Ä¶</div>
    </div>
    
    <div id="batedBreathIndicator" class="hidden" style="text-align:center; font-size:0.8em; color:var(--gold); font-style:italic; margin-bottom:10px; opacity:0.8;">
        Waiting for partner...
        <button id="btnAbandonCouple" style="background:none; border:none; text-decoration:underline; color:var(--pink); cursor:pointer; padding:0; font-size:inherit; margin-left:5px;">Play Solo (Revoke Invite)</button>
    </div>

    <!-- TEXT-FIRST LAYOUT: Story text begins immediately after Scene 1 -->
    <div id="storyText" class="box">
        <div class="story-pages-container" id="storyPagesContainer"></div>
    </div>

    <!-- Setting shot appears as landscape element AFTER text (does not replace text) -->
    <div id="settingShotWrap">
        <div id="settingError" class="img-error-msg hidden"></div>
        <img id="settingShotImg" src="" alt="Setting" style="display:none; width:100%;">
    </div>

    <div class="page-nav-controls" id="pageNavControls">
        <button class="page-nav-btn" id="prevPageBtn" disabled>
            <span>‚Üê</span> Previous
        </button>
        <span class="page-indicator" id="pageIndicator">Page 1 of 1</span>
        <button class="page-nav-btn" id="nextPageBtn" disabled>
            Next <span>‚Üí</span>
        </button>
    </div>

    <div style="text-align:center; margin-bottom:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button id="vizSceneBtn" onclick="window.visualize()" style="font-size:0.9em; background:#444;">‚ú® Visualize This Scene</button>
        <button id="btnReaderCover" style="font-size:0.9em; background:linear-gradient(135deg, #2a2a2a, #1a1a1a); border:1px solid var(--gold); color:var(--gold);">üìñ Cover Sketch</button>
    </div>
    
    <div id="metaControls" class="hidden" style="margin: 10px auto; padding: 10px; border: 1px dashed var(--gold); border-radius: 8px; max-width: 600px;">
      <div style="font-size: 0.8em; color: var(--gold); margin-bottom: 5px;">CHARACTERS REACT TO FATE (Meta System)</div>
      <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 5px;">
        <button class="small-btn meta-stance" onclick="window.setMetaStance('aid')">Aid Fate</button>
        <button class="small-btn meta-stance" onclick="window.setMetaStance('rebel')">Resist Fate</button>
        <button class="small-btn meta-stance" onclick="window.setMetaStance('seduce')">Tempt Fate</button>
      </div>
    </div>

    <div id="fateCardHeader" class="section-title" style="font-size:1.8em; margin-top:0; display:flex; justify-content:center;">Let Fate Guide You</div>

    <div style="display:flex; align-items:flex-start; justify-content:center;">
        <div id="cardMount" class="fate-grid"></div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
      <div class="input-wrapper" id="actionWrapper">
          <label>What do you do?</label>
          <textarea id="actionInput" rows="3" placeholder="Action..."></textarea>
      </div>
      <div class="input-wrapper" id="dialogueWrapper">
          <label>What do you say?</label>
          <textarea id="dialogueInput" rows="3" placeholder="Dialogue..."></textarea>
      </div>
    </div>

    <div class="intensity-mini" id="gameIntensity">
        <button onclick="window.setGameIntensity('Clean')">Clean</button>
        <button onclick="window.setGameIntensity('Naughty')" class="active">Naughty</button>
        <button onclick="window.setGameIntensity('Erotic')">Erotic</button>
        <button onclick="window.setGameIntensity('Dirty')">Dirty</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; align-items:center;">
       <button id="saveBtn" class="small-btn locked-style">Save</button>
       <button id="submitBtn" style="font-size:1.3em;">Submit Turn</button>
    </div>
    
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
       <button id="gameControlsBtn" class="small-btn">Quill & Veto</button>
       <button id="edgeCovenantBtn" class="small-btn" onclick="window.openEdgeCovenantModal()">Edge Covenant</button>
    </div>

  </div>

    </div><!-- END storyContent -->

  <div id="toast" class="toast hidden">Boundaries redirected the scene.</div>

<div id="gameQuillVetoModal" class="overlay hidden" style="z-index:10004;">
  <div class="box" style="max-width:90vw; width:700px; text-align:left;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div class="qv-section">
            <label class="qv-label" style="display:block; margin-bottom:8px;">Veto</label>
            <p class="qv-hint-above" style="font-size:0.85em; opacity:0.8; margin-bottom:10px;">Block elements you never want to appear.</p>
            <!-- CORRECTIVE: Show committed veto entries in game modal -->
            <div id="gameVetoCommitted" class="committed-phrases" style="margin-bottom:10px;"></div>
            <div class="fate-input-row" style="margin-bottom:10px;">
                <div class="input-wrapper fate-input-wrapper" style="flex:1;">
                    <textarea id="gameVetoInput" rows="3" class="fate-field" data-fate-type="veto" placeholder=""></textarea>
                    <div class="rotating-placeholder" data-for="gameVetoInput"></div>
                </div>
            </div>
            <div class="veto-ui" style="display:flex; align-items:center; justify-content:flex-end;">
                <button id="btnGameCommitVeto" class="small-btn" style="padding:6px 12px; font-size:0.85em;">Commit Veto</button>
            </div>
        </div>

        <div class="qv-section">
            <label class="qv-label" style="display:block; margin-bottom:8px;">Quill</label>
            <p class="qv-hint-above" style="font-size:0.85em; opacity:0.8; margin-bottom:10px;">Steer tone, boundaries, or direction.</p>
            <!-- Committed Quill entries (parallel to gameVetoCommitted) -->
            <div id="gameQuillCommitted" class="committed-phrases" style="margin-bottom:10px;"></div>
            <div class="fate-input-row" style="margin-bottom:10px;">
                <div id="gameQuillBox" class="input-wrapper fate-input-wrapper" style="flex:1;">
                    <textarea id="gameQuillInput" rows="3" class="fate-field" data-fate-type="quill" placeholder=""></textarea>
                    <div class="rotating-placeholder" data-for="gameQuillInput"></div>
                </div>
            </div>
            <div class="quill-ui" style="display:flex; align-items:center; justify-content:space-between;">
                <span id="gameQuillStatus" style="font-size:0.9em;">Quill: Poised</span>
                <button id="btnGameCommitQuill" class="small-btn" style="padding:6px 12px; font-size:0.85em;">Commit Quill</button>
            </div>
        </div>
    </div>

    <div style="text-align:center; margin-top:20px;">
        <button onclick="document.getElementById('gameQuillVetoModal').classList.add('hidden')" style="background:#444;">Close</button>
    </div>
  </div>
</div>

<!-- TRIPLE-FORK CONTINUATION MODAL -->
<div id="continuationForkModal" class="overlay hidden" style="z-index:10006;" onclick="if(event.target===this) window.defaultContinuationPath();">
  <div class="box" style="max-width:450px; text-align:center;">
    <h3 style="color:var(--gold); margin-bottom:20px;">What comes next?</h3>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button id="btnContinueStory" onclick="window.selectContinuationPath('continue')" style="padding:15px;">
        Continue this story
      </button>
      <button id="btnSameWorld" onclick="window.selectContinuationPath('same_world')" style="padding:15px;">
        Start a new story in this world
      </button>
      <button id="btnNewStory" onclick="window.selectContinuationPath('new_story')" style="padding:15px;">
        Start a completely new story
      </button>
    </div>
    <p style="font-size:0.75em; opacity:0.5; margin-top:15px;">
      Click outside to start a completely new story.
    </p>
  </div>
</div>

<div id="edgeCovenantModal" class="overlay hidden" style="z-index:10005;">
  <div class="box" style="max-width:500px; text-align:center;">
    <h3 style="color:var(--pink)">The Covenant</h3>
    <p style="font-size:0.9em; opacity:0.9; line-height:1.5; margin-bottom:20px;">
      This option allows a more intense, commanding tone between characters‚Äîlike dark-romance tension‚Äîwhile keeping clear boundaries. You can pause, soften, or stop at any time. Safewords are always honored instantly.
    </p>
    
    <div id="edgeActions">
        <button id="btnInviteEdge" onclick="window.inviteEdgeOffer()">Invite In-Story Offer</button>
        <div style="margin-top:10px; font-size:0.8em; opacity:0.6;">(If Solo/NPC play)</div>
        
        <div id="coupleEdgeControls" class="hidden" style="margin-top:20px; border-top:1px solid #444; padding-top:15px;">
            <p>Offer this dynamic to your partner?</p>
            <button onclick="window.sendEdgeOffer()">Send Offer</button>
        </div>
    </div>

    <div id="edgeAcceptance" class="hidden">
        <p style="font-style:italic; color:var(--gold); margin-bottom:20px;">
            "Accepting means your character consents to a more intense dynamic‚Äîstronger pressure, firmer guidance, and heightened tension‚Äîwithin your chosen intensity setting. You can stop or renegotiate at any time."
        </p>
        <button onclick="window.acceptEdgeCovenant()">I‚Äôm not afraid to enter your world.</button>
        <button onclick="window.closeEdgeModal()" style="background:#444; margin-top:10px;">Not like this.</button>
    </div>

    <button onclick="window.closeEdgeModal()" style="background:transparent; border:none; color:#aaa; margin-top:20px; font-size:0.8em; cursor:pointer;">Close</button>
  </div>
</div>

</div>

<script src="fatecards.js"></script>
<script src="orchestration-client.js"></script>
<script src="app.js"></script>
<div id="authModal" class="overlay hidden" style="z-index:5001;">
  <div class="box" style="max-width:400px;">
    <h3 id="authModalTitle">Log In</h3>
    <div id="authError" style="color:#e74c3c; margin-bottom:10px; display:none;"></div>
    <input type="email" id="authEmail" placeholder="Email" style="width:100%; margin-bottom:10px; padding:10px;">
    <input type="password" id="authPassword" placeholder="Password" style="width:100%; margin-bottom:15px; padding:10px;">
    <button id="authSubmitBtn" onclick="window.handleAuthSubmit()">Log In</button>
    <p style="margin-top:15px; font-size:0.9em;">
      <span id="authToggleText">Don't have an account?</span>
      <a href="#" id="authToggleLink" onclick="window.toggleAuthMode(); return false;">Sign up</a>
    </p>
    <button onclick="window.closeAuthModal()" style="background:#444; margin-top:10px;">Cancel</button>
  </div>
</div>

<div id="profileModal" class="overlay hidden" style="z-index:5001;">
  <div class="box" style="max-width:450px;">
    <h3>Author Profile</h3>
    <label class="setting-label">Pen Name</label>
    <input type="text" id="profilePenName" placeholder="Your pen name" style="width:100%; margin-bottom:15px; padding:10px;">
    <label style="display:flex; align-items:center; gap:10px; margin-bottom:20px; cursor:pointer;">
      <input type="checkbox" id="profileAttribution" style="width:20px; height:20px;">
      <span>Show my name on public stories</span>
    </label>
    <button onclick="window.saveProfile()">Save</button>
    <button onclick="window.closeProfileModal()" style="background:#444; margin-top:10px;">Cancel</button>
  </div>
</div>

<div id="myLibraryModal" class="overlay hidden" style="z-index:5000;">
  <div class="box" style="max-width:600px; max-height:80vh; overflow-y:auto;">
    <h3>My Library</h3>
    <div id="myLibraryContent"></div>
    <button onclick="window.closeMyLibraryModal()" style="background:#444; margin-top:15px;">Close</button>
  </div>
</div>
<!-- Dev HUD (developer-only, toggled with backtick key) -->
<div id="devHud" class="dev-hud">
  <div class="dev-hud-bar">
    <span class="dev-hud-label">DEV</span>
    <input id="devHudInput" type="text" placeholder="what can i say..." autocomplete="off" spellcheck="false">
    <div id="devHudLog" class="dev-hud-log"></div>
  </div>
</div>
</body>
</html>
